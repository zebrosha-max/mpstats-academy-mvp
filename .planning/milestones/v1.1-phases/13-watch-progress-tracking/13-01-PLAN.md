---
phase: 13-watch-progress-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/prisma/schema.prisma
  - packages/api/src/routers/learning.ts
  - apps/web/src/components/video/KinescopePlayer.tsx
  - apps/web/src/app/(main)/learn/[id]/page.tsx
autonomous: true
requirements: [WATCH-01, WATCH-03]

must_haves:
  truths:
    - "Video playback position is saved to database automatically as user watches"
    - "Reopening a lesson resumes video from last saved position"
    - "Progress is stored per-user per-lesson with position in seconds and percentage"
  artifacts:
    - path: "packages/db/prisma/schema.prisma"
      provides: "LessonProgress model with lastPosition field"
      contains: "lastPosition"
    - path: "packages/api/src/routers/learning.ts"
      provides: "saveWatchProgress mutation and getWatchProgress query"
      contains: "saveWatchProgress"
    - path: "apps/web/src/components/video/KinescopePlayer.tsx"
      provides: "onTimeUpdate callback and getCurrentTime method on PlayerHandle"
      contains: "onTimeUpdate"
    - path: "apps/web/src/app/(main)/learn/[id]/page.tsx"
      provides: "Debounced progress saving and resume-from-position on load"
      contains: "saveWatchProgress"
  key_links:
    - from: "apps/web/src/app/(main)/learn/[id]/page.tsx"
      to: "packages/api/src/routers/learning.ts"
      via: "trpc.learning.saveWatchProgress mutation"
      pattern: "saveWatchProgress\\.mutate"
    - from: "apps/web/src/components/video/KinescopePlayer.tsx"
      to: "apps/web/src/app/(main)/learn/[id]/page.tsx"
      via: "onTimeUpdate callback prop"
      pattern: "onTimeUpdate"
---

<objective>
Implement watch progress persistence: track video playback position via Kinescope postMessage API, save to database with debounce, and restore position on lesson reopen.

Purpose: WATCH-01 (save position + %) and WATCH-03 (resume from last position) — the data foundation for progress tracking.
Output: Working save/restore loop where watching a video auto-saves progress and reopening resumes from that point.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-watch-progress-tracking/13-CONTEXT.md
@packages/db/prisma/schema.prisma
@packages/api/src/routers/learning.ts
@apps/web/src/components/video/KinescopePlayer.tsx
@apps/web/src/app/(main)/learn/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lastPosition to schema + saveWatchProgress/getWatchProgress endpoints</name>
  <files>
    packages/db/prisma/schema.prisma
    packages/api/src/routers/learning.ts
  </files>
  <action>
1. **Prisma schema** — add `lastPosition Int @default(0)` field to `LessonProgress` model (seconds into video). Also add `videoDuration Int @default(0)` field for calculating percentage accurately. Run `pnpm db:push` to apply.

2. **learning.ts — saveWatchProgress mutation:**
   - Input: `{ lessonId: string, position: number, duration: number }` (position and duration in seconds)
   - Calculate `watchedPercent = Math.round((position / duration) * 100)` clamped 0-100
   - Threshold: ignore saves where position < 5 seconds (prevents noise from page loads)
   - Use existing pattern: `ensureUserProfile` → upsert LearningPath → upsert LessonProgress
   - Update `lastPosition`, `watchedPercent`, `videoDuration`
   - Set `status = 'COMPLETED'` if `watchedPercent >= 90`, else `'IN_PROGRESS'`
   - Return `{ lessonId, status, watchedPercent, lastPosition }`

3. **learning.ts — getWatchProgress query:**
   - Input: `{ lessonId: string }`
   - Find LessonProgress for user's path + lessonId
   - Return `{ lastPosition: number, watchedPercent: number, status: string } | null`
   - This is used by the lesson page to know where to resume

Keep existing `updateProgress` and `completeLesson` mutations working (don't break them). The new `saveWatchProgress` handles the automatic video tracking case; the existing mutations remain for manual completion.
  </action>
  <verify>
    <automated>cd D:/GpT_docs/MPSTATS\ ACADEMY\ ADAPTIVE\ LEARNING/MAAL && pnpm db:generate && pnpm build --filter=@mpstats/api 2>&1 | tail -5</automated>
    <manual>Check schema has lastPosition and videoDuration fields; check learning router exports saveWatchProgress and getWatchProgress</manual>
  </verify>
  <done>LessonProgress has lastPosition + videoDuration fields. saveWatchProgress mutation accepts position/duration and persists to DB with auto-status. getWatchProgress returns saved position for a lesson.</done>
</task>

<task type="auto">
  <name>Task 2: Kinescope time tracking + lesson page save/restore integration</name>
  <files>
    apps/web/src/components/video/KinescopePlayer.tsx
    apps/web/src/app/(main)/learn/[id]/page.tsx
  </files>
  <action>
1. **KinescopePlayer.tsx — Add time tracking:**
   - Extend `KinescopePlayerProps` with optional `onTimeUpdate?: (currentTime: number, duration: number) => void` callback and optional `initialTime?: number` for resume.
   - After player instance is created (in the `.then((pl) => { ... })` block), set up a **setInterval** (every 10 seconds) that calls `pl.getCurrentTime()` (if available via Kinescope IframePlayer API) and invokes `onTimeUpdate(currentTime, duration)`.
   - **Kinescope Iframe API approach:** The Kinescope IframePlayer instance returned by `factory.create()` exposes `getCurrentTime()` and `getDuration()` methods (Promise-based). Use these in the interval.
   - If `initialTime` is provided and > 0, after player creation, call `pl.seekTo(initialTime)` to resume from that position. Show a brief toast/notification "Продолжаем с X:XX" (use a small absolute-positioned div that fades out after 3 seconds).
   - On component unmount (cleanup function), clear the interval.
   - Extend `PlayerHandle` to add `getCurrentTime(): number | null` method for external access.

2. **Lesson page (page.tsx) — Wire save/restore:**
   - Add `trpc.learning.getWatchProgress.useQuery({ lessonId })` to fetch saved position on load.
   - Add `trpc.learning.saveWatchProgress.useMutation()` (with `onError: silent log`).
   - Create a **debounced save handler**: when `onTimeUpdate` fires from player, debounce 15 seconds before calling `saveWatchProgress.mutate({ lessonId, position, duration })`. Use a `useRef` for the timeout ID.
   - Pass `initialTime={watchProgress?.lastPosition}` to `VideoPlayer` so it resumes.
   - Pass `onTimeUpdate={handleTimeUpdate}` to `VideoPlayer`.
   - On `beforeunload` event, fire one final save (non-debounced) to capture exit position. Use `navigator.sendBeacon` pattern or just the mutation.
   - After save completes, invalidate `getLesson` query to update the watchedPercent badge on the lesson page.

**Important:** The `onTimeUpdate` callback must NOT cause re-renders on every tick. Store current time/duration in refs, not state. Only the debounced mutation triggers network calls.
  </action>
  <verify>
    <automated>cd D:/GpT_docs/MPSTATS\ ACADEMY\ ADAPTIVE\ LEARNING/MAAL && pnpm build --filter=web 2>&1 | tail -5</automated>
    <manual>Open a lesson with video, play for 30+ seconds, navigate away, return — video should resume from ~where you left off. Check network tab for saveWatchProgress calls every ~15 seconds.</manual>
  </verify>
  <done>Video player reports time every 10s. Lesson page debounce-saves every 15s. On reopen, video resumes from last position with a brief "Продолжаем с X:XX" indicator. Progress is persisted in DB.</done>
</task>

</tasks>

<verification>
1. `pnpm db:generate` succeeds — schema valid with new fields
2. `pnpm build` succeeds — no TypeScript errors
3. Open lesson page → play video → verify saveWatchProgress network calls in DevTools
4. Navigate away and back → video resumes from saved position
5. Check DB: LessonProgress row has lastPosition > 0 and accurate watchedPercent
</verification>

<success_criteria>
- LessonProgress stores lastPosition (seconds) and videoDuration
- saveWatchProgress auto-fires every ~15 seconds during playback
- Reopening a lesson resumes from saved position
- Status auto-transitions to COMPLETED at >=90%
- No re-render storms from time tracking (refs, not state)
</success_criteria>

<output>
After completion, create `.planning/phases/13-watch-progress-tracking/13-01-SUMMARY.md`
</output>
