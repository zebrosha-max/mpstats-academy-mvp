---
phase: 13-watch-progress-tracking
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - apps/web/src/components/learning/LessonCard.tsx
  - apps/web/src/app/(main)/learn/page.tsx
  - packages/api/src/routers/learning.ts
  - packages/api/src/routers/admin.ts
autonomous: true
requirements: [WATCH-02, WATCH-04]

must_haves:
  truths:
    - "Lesson cards show a progress bar with watch percentage for in-progress and completed lessons"
    - "Course header on /learn page shows overall completion percentage based on watched videos"
    - "Admin panel shows basic watch engagement stats (avg watch %, top active users)"
  artifacts:
    - path: "apps/web/src/components/learning/LessonCard.tsx"
      provides: "Progress bar visible for all lessons with watchedPercent > 0"
      contains: "watchedPercent"
    - path: "apps/web/src/app/(main)/learn/page.tsx"
      provides: "Course-level progress percentage in course header"
      contains: "progressPercent"
    - path: "packages/api/src/routers/learning.ts"
      provides: "getCourses returns accurate progressPercent based on video watch data"
      contains: "progressPercent"
    - path: "packages/api/src/routers/admin.ts"
      provides: "getWatchStats procedure for admin panel"
      contains: "getWatchStats"
  key_links:
    - from: "apps/web/src/components/learning/LessonCard.tsx"
      to: "LessonWithProgress type"
      via: "lesson.watchedPercent field"
      pattern: "watchedPercent"
    - from: "apps/web/src/app/(main)/learn/page.tsx"
      to: "packages/api/src/routers/learning.ts"
      via: "trpc.learning.getCourses query"
      pattern: "getCourses"
---

<objective>
Display watch progress on lesson cards and course headers, calculate course completion from video data, and add watch engagement stats to admin panel.

Purpose: WATCH-02 (progress bar on cards) and WATCH-04 (course completion %) — the visible progress indicators.
Output: Users see how far they've watched each lesson and overall course progress. Admin sees watch engagement metrics.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-watch-progress-tracking/13-CONTEXT.md
@.planning/phases/13-watch-progress-tracking/13-01-SUMMARY.md
@apps/web/src/components/learning/LessonCard.tsx
@apps/web/src/app/(main)/learn/page.tsx
@packages/api/src/routers/learning.ts
@packages/api/src/routers/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Progress UI on lesson cards + course completion in /learn page</name>
  <files>
    apps/web/src/components/learning/LessonCard.tsx
    apps/web/src/app/(main)/learn/page.tsx
    packages/api/src/routers/learning.ts
  </files>
  <action>
1. **LessonCard.tsx — Always show progress bar when watchedPercent > 0:**
   - Currently progress bar only shows for `IN_PROGRESS` status. Change to show for ANY lesson with `watchedPercent > 0` (including COMPLETED — shows full green bar).
   - For COMPLETED lessons: bar is green (`bg-mp-green-500`) at 100%.
   - For IN_PROGRESS: bar is blue (`bg-mp-blue-500`) at current percent.
   - For NOT_STARTED with watchedPercent > 0 (edge case): treat as IN_PROGRESS visually.
   - Add a small checkmark icon overlay on the progress bar when COMPLETED.

2. **learning.ts getCourses — Improve progressPercent calculation:**
   - Current calculation counts lessons with COMPLETED status. Update to calculate weighted average:
     - `progressPercent = Math.round(sum(lesson.watchedPercent) / lessonsWithVideo.length)` where lessonsWithVideo = lessons with non-null videoId.
     - Lessons without videoId are excluded from the calculation (per CONTEXT.md, Claude's Discretion).
     - Keep `completedLessons` count as-is (lessons with COMPLETED status) for the "X/Y completed" display.

3. **learn/page.tsx — Show course progress bar in course accordion header:**
   - In the course section header (where course title is shown), add a progress bar and "X% завершено" text.
   - Use the `progressPercent` from getCourses response.
   - Style: thin horizontal bar (h-1.5) below course title, same green/blue coloring as lesson cards.
   - If progressPercent === 100: show green bar + "Курс завершён" badge.
   - If progressPercent > 0: show blue bar + "X% завершено" text.
   - If progressPercent === 0: no bar shown (clean look for untouched courses).
   - Also add a "Продолжить просмотр" button on courses with progress that links to the first IN_PROGRESS or NOT_STARTED lesson.
  </action>
  <verify>
    <automated>cd D:/GpT_docs/MPSTATS\ ACADEMY\ ADAPTIVE\ LEARNING/MAAL && pnpm build --filter=web 2>&1 | tail -5</automated>
    <manual>Open /learn page — courses with watched lessons show progress bar in header. Lesson cards with any progress show the blue/green bar. Completed lessons show green bar at 100%.</manual>
  </verify>
  <done>Lesson cards display progress bars for all watched lessons. Course headers show overall completion percentage. "Продолжить просмотр" button links to next unwatched lesson in course.</done>
</task>

<task type="auto">
  <name>Task 2: Admin watch engagement stats</name>
  <files>
    packages/api/src/routers/admin.ts
    apps/web/src/app/(admin)/analytics/page.tsx
  </files>
  <action>
1. **admin.ts — Add getWatchStats procedure:**
   - Uses `adminProcedure` (protected, admin-only).
   - Returns:
     - `avgWatchPercent`: Average watchedPercent across all LessonProgress records with watchedPercent > 0
     - `totalWatchSessions`: Count of LessonProgress records with watchedPercent > 0
     - `completionRate`: Percentage of started lessons that reached COMPLETED status
     - `courseEngagement`: Array of `{ courseId, courseTitle, avgPercent, startedCount, completedCount }` — aggregate per course by joining LessonProgress → Lesson → Course
     - `topActiveUsers`: Top 5 users by number of lessons with progress > 0, showing `{ userId, name, lessonsWatched, avgPercent }`
   - Use Prisma `aggregate` and `groupBy` for efficient queries.

2. **Analytics page — Add Watch Engagement section:**
   - In the existing analytics page (`apps/web/src/app/(admin)/analytics/page.tsx`), add a new section below existing charts.
   - Title: "Вовлечённость в видео"
   - Show 3 KPI cards: Средний % просмотра, Всего просмотров, Доля завершений
   - Show a simple table of course engagement: course name, avg %, started, completed
   - Show top 5 active users table: name, lessons watched, avg %
   - Use existing Card component styling from admin panel.
   - Wire to `trpc.admin.getWatchStats.useQuery()`.
  </action>
  <verify>
    <automated>cd D:/GpT_docs/MPSTATS\ ACADEMY\ ADAPTIVE\ LEARNING/MAAL && pnpm build --filter=web 2>&1 | tail -5</automated>
    <manual>Open /admin/analytics — scroll down to see "Вовлечённость в видео" section with KPI cards and tables.</manual>
  </verify>
  <done>Admin analytics page shows watch engagement metrics: avg watch %, total sessions, completion rate, per-course breakdown, and top active users.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds — no TypeScript errors
2. /learn page: courses show progress bars in headers with completion %
3. Lesson cards: all lessons with watchedPercent > 0 show progress bars
4. /admin/analytics: watch engagement section visible with metrics
5. Course progressPercent calculated from actual watch data (weighted average of lesson watchedPercent)
</verification>

<success_criteria>
- Every lesson card with watchedPercent > 0 displays a progress bar
- Course headers show weighted average completion percentage
- "Продолжить просмотр" button navigates to first unwatched lesson in course
- Admin sees average watch %, total sessions, completion rate, per-course breakdown
- All data is live from DB (not mock)
</success_criteria>

<output>
After completion, create `.planning/phases/13-watch-progress-tracking/13-02-SUMMARY.md`
</output>
