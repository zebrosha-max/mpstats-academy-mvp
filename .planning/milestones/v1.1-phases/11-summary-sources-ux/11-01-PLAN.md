---
phase: 11-summary-sources-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/(main)/learn/[id]/page.tsx
  - apps/web/src/components/shared/SafeMarkdown.tsx
  - apps/web/src/components/learning/CollapsibleSummary.tsx
  - apps/web/src/components/learning/SourceTooltip.tsx
autonomous: true
requirements:
  - UX-01
  - UX-02
  - UX-03
  - UX-04

must_haves:
  truths:
    - "Summary урока отображается под видео, а не в боковой панели, по умолчанию свёрнуто (~6-8 строк)"
    - "Кнопка-ссылка 'Показать полностью' / 'Свернуть' разворачивает/сворачивает summary с плавной анимацией"
    - "Ссылки [1], [2], [N] в markdown summary рендерятся как superscript mp-blue badge-ки"
    - "При наведении на badge [N] через ~200ms появляется тултип с названием фрагмента, таймкодом и цитатой"
    - "Клик на badge [N] перематывает Kinescope видео на таймкод через seekTo + play"
    - "Внизу summary блок сносок (footnotes) с нумерованными источниками и таймкодами"
    - "Боковая AI-панель содержит только чат (таб 'Краткое содержание' убран)"
  artifacts:
    - path: "apps/web/src/components/learning/CollapsibleSummary.tsx"
      provides: "Collapsible summary container with gradient fade and expand/collapse"
      min_lines: 40
    - path: "apps/web/src/components/learning/SourceTooltip.tsx"
      provides: "Tooltip component for source citations with delay"
      min_lines: 30
    - path: "apps/web/src/components/shared/SafeMarkdown.tsx"
      provides: "Updated markdown renderer that transforms [N] references into interactive badges"
    - path: "apps/web/src/app/(main)/learn/[id]/page.tsx"
      provides: "Lesson page with summary under video and sidebar as chat-only"
  key_links:
    - from: "SafeMarkdown"
      to: "SourceTooltip"
      via: "Custom renderer for [N] patterns in markdown text"
      pattern: "\\[\\d+\\]"
    - from: "SourceTooltip badge click"
      to: "KinescopePlayer.seekTo"
      via: "onSeek callback prop passed through from lesson page"
      pattern: "handleTimecodeClick.*seekTo"
    - from: "CollapsibleSummary"
      to: "SafeMarkdown"
      via: "Renders summary content inside collapsible container"
---

<objective>
Move the AI summary from the narrow sidebar to under the video player with collapsible display, and transform source references [1], [2] in the summary text into interactive superscript badges with hover tooltips and video seekTo on click.

Purpose: Summary in the sidebar is too narrow, causing text to stretch many screens. Moving it under the video provides full width. Interactive source citations let users jump to relevant video moments directly from the summary text.

Output: Lesson page with summary under video, interactive [N] badges with tooltips, footnotes block, and sidebar reduced to chat-only.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-summary-sources-ux/11-CONTEXT.md

@apps/web/src/app/(main)/learn/[id]/page.tsx
@apps/web/src/components/shared/SafeMarkdown.tsx
@apps/web/src/components/video/KinescopePlayer.tsx
@apps/web/src/components/video/TimecodeLink.tsx
@packages/api/src/routers/ai.ts
@packages/ai/src/generation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SourceTooltip and CollapsibleSummary components</name>
  <files>
    apps/web/src/components/learning/SourceTooltip.tsx
    apps/web/src/components/learning/CollapsibleSummary.tsx
  </files>
  <action>
**SourceTooltip.tsx:**
Create a tooltip component for source citation badges. Props:
- `index: number` — citation number (1-based)
- `source: { id: string; content: string; timecodeFormatted: string; timecode_start: number }` — source data
- `onSeek: (seconds: number) => void` — callback for seekTo
- `disabled?: boolean` — when no video

Rendering:
- The trigger is a superscript badge: `<sup>` with small rounded circle, mp-blue-600 bg, white text, font-size ~10px, like scientific paper references. Use a `<button>` for accessibility.
- On hover (after ~200ms delay via `onMouseEnter` + `setTimeout` / `onMouseLeave` cancel pattern), show a positioned tooltip (absolute, z-50) with:
  - Source content snippet (first ~100 chars of `source.content`)
  - Timecode formatted string
  - Use mp-gray-900 bg, white text, rounded-lg, shadow-lg, max-w-xs, text-xs
  - Small arrow/caret pointing to badge
- On click: call `onSeek(source.timecode_start)` to seekTo video, scroll player into view
- On mobile: click goes straight to seekTo (no hover possible)
- Position tooltip above the badge by default, measure if it fits (check `getBoundingClientRect` vs viewport top), flip below if not enough space above

**CollapsibleSummary.tsx:**
Create a collapsible container for summary content. Props:
- `children: React.ReactNode` — summary content
- `isLoading?: boolean` — show skeleton
- `error?: string | null` — show error state
- `maxCollapsedHeight?: number` — default 200 (px), approximately 6-8 lines of text

Rendering:
- Collapsed state (default): `max-height: {maxCollapsedHeight}px`, `overflow: hidden`
- Gradient fade at bottom when collapsed: `::after` pseudo-element or a div with `bg-gradient-to-t from-white to-transparent` overlaid at the bottom (h-12)
- Text link "Показать полностью" below the gradient fade when collapsed
- Expanded state: full height, text link changes to "Свернуть"
- Animate height transition (~300ms) using `transition-all duration-300 ease-in-out` on max-height (set max-height to a large value like 5000px when expanded, or measure actual height via ref)
- Detect if content is actually taller than maxCollapsedHeight (via ref + ResizeObserver or useEffect measuring scrollHeight). If content fits, hide the expand button entirely.
- Loading state: show skeleton lines (4 lines, shimmer effect)
- Error state: show red error card with icon and message

Use `useState` for expanded/collapsed, `useRef` + `useEffect` for content height measurement.
  </action>
  <verify>
    <automated>cd /d/GpT_docs/"MPSTATS ACADEMY ADAPTIVE LEARNING"/MAAL && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30</automated>
    <manual>Check that both component files exist and compile without errors</manual>
  </verify>
  <done>SourceTooltip renders superscript badge with delayed tooltip on hover and seekTo on click. CollapsibleSummary renders content with gradient fade, expand/collapse toggle with animation, and handles loading/error states.</done>
</task>

<task type="auto">
  <name>Task 2: Update SafeMarkdown to render [N] as interactive SourceTooltip badges</name>
  <files>
    apps/web/src/components/shared/SafeMarkdown.tsx
  </files>
  <action>
Extend SafeMarkdown to support interactive source references. The challenge: react-markdown renders markdown to React elements, but [1], [2] etc. in the LLM output are plain text inside `<p>`, `<li>`, `<strong>` etc. We need to intercept text nodes and replace `[N]` patterns with SourceTooltip components.

**Approach — Add new optional props to SafeMarkdown:**
- `sources?: Array<{ id: string; content: string; timecodeFormatted: string; timecode_start: number; timecode_end: number }>` — source data array (index-aligned: sources[0] = [1])
- `onSourceSeek?: (seconds: number) => void` — seekTo callback
- `disableSourceLinks?: boolean` — when no video

When `sources` is provided, wrap the output in a post-processing step. The simplest reliable approach:

1. Add a custom `components` override that processes text children. In the existing `components` object, many elements receive `children`. We need to intercept text nodes.

2. Create a helper function `processTextWithSources(text: string, sources, onSourceSeek, disabled)` that:
   - Splits text by regex `/\[(\d+)\]/g`
   - For each match, replaces with `<SourceTooltip index={N} source={sources[N-1]} onSeek={onSourceSeek} disabled={disabled} />`
   - Returns array of string segments and SourceTooltip elements

3. Create a wrapper component `SourceAwareText` that receives children, walks through them, and for any string child, runs `processTextWithSources`. Non-string children (other React elements) are passed through recursively.

4. Wrap the `p`, `li`, `strong`, `em` component overrides to process their children through `SourceAwareText` when `sources` is provided. Keep existing styling intact. Use a closure or context to pass sources/onSeek without prop drilling through every component.

**Important:** Keep backward compatibility — when `sources` is not provided, SafeMarkdown works exactly as before (no SourceTooltip imports needed at render time).

Also add `'a'` to sanitizeSchema tagNames (for potential link rendering) and make sure `sup` is already there (it is).
  </action>
  <verify>
    <automated>cd /d/GpT_docs/"MPSTATS ACADEMY ADAPTIVE LEARNING"/MAAL && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30</automated>
    <manual>SafeMarkdown with sources prop transforms [1] text into SourceTooltip badges. Without sources prop, renders as before.</manual>
  </verify>
  <done>SafeMarkdown accepts optional `sources` and `onSourceSeek` props. When provided, [N] patterns in text are replaced with interactive SourceTooltip superscript badges. Existing usage without sources remains unchanged.</done>
</task>

<task type="auto">
  <name>Task 3: Restructure lesson page — summary under video, sidebar chat-only, footnotes</name>
  <files>
    apps/web/src/app/(main)/learn/[id]/page.tsx
  </files>
  <action>
Restructure the lesson page layout per CONTEXT.md decisions.

**Layout changes:**

1. **Remove summary tab from sidebar.** The sidebar `<div className="space-y-4">` currently has tabs "Краткое содержание" / "AI-чат". Remove the tab switcher entirely and the summary tab content. The sidebar becomes chat-only (always shows chat card, no tabs needed).

2. **Remove `activeTab` state** and the `trpc.ai.getLessonSummary.useQuery` `enabled: activeTab === 'summary'` condition — summary should always load when lesson loads.

3. **Add summary section under video player.** Between the video Card and the lesson info/navigation, insert the summary block:

```
<Card> {/* video player */}
  <VideoPlayer ... />
</Card>

{/* Summary section — new */}
{summaryLoading || summaryData?.content ? (
  <CollapsibleSummary isLoading={summaryLoading} error={summaryError?.message}>
    <SafeMarkdown
      content={summaryData?.content || ''}
      className="prose prose-sm max-w-none text-body-sm text-mp-gray-700"
      sources={summaryData?.sources}
      onSourceSeek={handleTimecodeClick}
      disableSourceLinks={!lesson.videoId}
    />

    {/* Footnotes block */}
    {summaryData?.sources && summaryData.sources.length > 0 && (
      <div className="border-t border-mp-gray-200 pt-3 mt-4">
        <p className="text-xs font-medium text-mp-gray-500 mb-2">Источники:</p>
        <div className="space-y-1">
          {summaryData.sources.map((source, idx) => (
            <div key={source.id} className="flex items-start gap-2 text-xs text-mp-gray-600">
              <span className="text-mp-blue-600 font-semibold shrink-0">[{idx + 1}]</span>
              <span className="flex-1">{source.content.slice(0, 80)}...</span>
              <TimecodeLink
                startSeconds={source.timecode_start}
                formattedTime={source.timecodeFormatted}
                onSeek={handleTimecodeClick}
                disabled={!lesson.videoId}
              />
            </div>
          ))}
        </div>
      </div>
    )}
  </CollapsibleSummary>
)}
```

4. **Summary is inside `lg:col-span-2` (left column)**, under the video, before navigation. The `fromCache` indicator can be shown as a small "(кэш)" badge next to "Ключевые тезисы" heading if desired, or removed since it was in the sidebar header.

5. **Add heading for summary section** — a simple `<h2>` with the document icon "Ключевые тезисы" and optional "(кэш)" badge, styled like current CardTitle.

6. **Sidebar simplification:** Remove tab buttons. Keep the chat Card as-is but without the tab wrapper. The chat card can be shown directly with its title "Задайте вопрос по уроку".

7. **Import new components:** Add imports for `CollapsibleSummary` and update `SafeMarkdown` usage with new props.

8. **Ensure `handleTimecodeClick` still works** — it calls `playerRef.current?.seekTo(seconds)` and scrolls to `#video-player`. This callback is passed to SafeMarkdown via `onSourceSeek` and to footnotes via TimecodeLink.
  </action>
  <verify>
    <automated>cd /d/GpT_docs/"MPSTATS ACADEMY ADAPTIVE LEARNING"/MAAL && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30</automated>
    <manual>Open lesson page in browser. Summary should appear under video (collapsed by default). Click "Показать полностью" to expand. Hover over [N] badges to see tooltips. Click badges to seek video. Sidebar should show only chat.</manual>
  </verify>
  <done>Lesson page has summary under video in collapsible container with gradient fade. [N] badges in summary text are interactive with tooltips and seekTo. Footnotes block at bottom of summary. Sidebar is chat-only (no tabs). All existing chat functionality preserved.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. Lesson page loads with summary under video (not in sidebar)
3. Summary is collapsed by default (~6-8 lines visible) with gradient fade
4. "Показать полностью" expands summary with smooth animation
5. "Свернуть" collapses it back
6. [N] references in summary text render as small blue superscript badges
7. Hovering over a badge for ~200ms shows tooltip with source snippet and timecode
8. Clicking a badge calls seekTo on the Kinescope player
9. Footnotes section at bottom lists all sources with timecodes
10. Sidebar shows only chat (no "Краткое содержание" tab)
11. Chat functionality works as before
</verification>

<success_criteria>
- UX-01: Summary ограничен по высоте с expand/collapse и gradient fade
- UX-02: [N] ссылки в тексте кликабельны как superscript badges
- UX-03: Hover на [N] показывает тултип с превью (название, таймкод, фрагмент)
- UX-04: Клик на [N] перематывает видео через seekTo
- Summary перемещён под видео, боковая панель — только чат
- TypeScript компилируется без ошибок
</success_criteria>

<output>
After completion, create `.planning/phases/11-summary-sources-ux/11-01-SUMMARY.md`
</output>
