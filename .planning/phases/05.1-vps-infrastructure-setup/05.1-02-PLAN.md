---
phase: 05.1-vps-infrastructure-setup
plan: 02
type: execute
wave: 2
depends_on:
  - 05.1-01
files_modified: []
autonomous: false
requirements:
  - INFRA-04

user_setup:
  - service: Cloudflare
    why: "Cloudflare Named Tunnel requires Cloudflare account with a domain"
    env_vars: []
    dashboard_config:
      - task: "Verify Cloudflare account has at least one domain (from Talent project or new)"
        location: "Cloudflare Dashboard -> Websites"

must_haves:
  truths:
    - "Cloudflare Tunnel установлен и работает на VPS как systemd service"
    - "Временный домен с HTTPS доступен и проксирует трафик на Nginx -> localhost:3000"
    - "cloudflared перезапускается автоматически при reboot VPS"
  artifacts:
    - path: "VPS: /home/deploy/.cloudflared/config.yml"
      provides: "Cloudflare Tunnel ingress configuration"
      contains: "service: http://localhost:80"
    - path: "VPS: /etc/systemd/system/cloudflared.service (or equivalent)"
      provides: "Systemd service for persistent tunnel"
  key_links:
    - from: "cloudflared config.yml"
      to: "Nginx maal.conf"
      via: "ingress -> localhost:80 -> proxy_pass localhost:3000"
      pattern: "localhost:80"
---

<objective>
Настроить Cloudflare Named Tunnel на VPS для временного домена с HTTPS, проксирующего трафик через Nginx на MAAL-контейнер (localhost:3000).

Purpose: Приложение будет доступно по HTTPS URL без собственного домена и без открытия дополнительных портов.
Output: Работающий Cloudflare Tunnel как systemd service + доступный HTTPS URL.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-vps-infrastructure-setup/05.1-CONTEXT.md
@.planning/phases/05.1-vps-infrastructure-setup/05.1-RESEARCH.md
@.planning/phases/05.1-vps-infrastructure-setup/05.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Cloudflare Named Tunnel</name>
  <files>VPS: remote commands via SSH</files>
  <action>
**Все команды выполняются на VPS 89.208.106.208 через SSH (paramiko или vps-ops-manager).**

**Step 1: Install cloudflared**

```bash
# Check if already installed
cloudflared --version 2>/dev/null || {
  wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
  sudo dpkg -i cloudflared-linux-amd64.deb
  rm cloudflared-linux-amd64.deb
}
cloudflared --version
```

**Step 2: Authenticate with Cloudflare**

```bash
cloudflared tunnel login
```

Эта команда выведет URL для авторизации в Cloudflare. Пользователь должен открыть URL в браузере и выбрать домен. После авторизации cert.pem сохранится в `~/.cloudflared/`.

**CHECKPOINT:** Если у пользователя НЕТ домена в Cloudflare — использовать Quick Tunnel как fallback:
```bash
# Quick Tunnel (URL меняется при перезапуске, но работает без домена)
cloudflared tunnel --url http://localhost:80
```
Для Named Tunnel домен в Cloudflare ОБЯЗАТЕЛЕН.

**Step 3: Create Named Tunnel**

```bash
cloudflared tunnel create maal
```

Записать UUID туннеля из вывода. Credentials JSON сохранится в `~/.cloudflared/<UUID>.json`.

**Step 4: Route DNS**

```bash
# Заменить <DOMAIN> на домен из Cloudflare аккаунта
cloudflared tunnel route dns maal maal.<DOMAIN>
```

Это создаст CNAME запись `maal.<DOMAIN>` -> `<UUID>.cfargotunnel.com` в Cloudflare DNS.

**Step 5: Create config.yml**

```bash
# Получить UUID
TUNNEL_UUID=$(cloudflared tunnel list | grep maal | awk '{print $1}')

cat > /home/deploy/.cloudflared/config.yml << EOF
tunnel: ${TUNNEL_UUID}
credentials-file: /home/deploy/.cloudflared/${TUNNEL_UUID}.json

ingress:
  - hostname: maal.<DOMAIN>
    service: http://localhost:80
  - service: http_status:404
EOF
```

**ВАЖНО:** Последнее правило ingress `- service: http_status:404` ОБЯЗАТЕЛЬНО (catch-all). Без него cloudflared не запустится.

Трафик идет: `Cloudflare Edge -> cloudflared -> Nginx (localhost:80) -> Docker (localhost:3000)`.

**Step 6: Install as systemd service**

```bash
sudo cloudflared --config /home/deploy/.cloudflared/config.yml service install
sudo systemctl enable cloudflared
sudo systemctl start cloudflared
sudo systemctl status cloudflared
```

**Step 7: Verify tunnel is running**

```bash
cloudflared tunnel info maal
sudo systemctl status cloudflared
# Check logs for errors
sudo journalctl -u cloudflared --no-pager -n 20
```
  </action>
  <verify>
На VPS:
```bash
cloudflared --version
cloudflared tunnel list | grep maal
sudo systemctl is-active cloudflared
sudo systemctl is-enabled cloudflared
cat /home/deploy/.cloudflared/config.yml
```
cloudflared установлен, tunnel "maal" существует, сервис активен и enabled.
  </verify>
  <done>Cloudflare Named Tunnel "maal" создан, config.yml настроен (ingress -> localhost:80 -> Nginx -> localhost:3000), systemd service запущен и автозапускается при reboot.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Cloudflare Tunnel connectivity</name>
  <action>Human verification of Cloudflare Tunnel and HTTPS access.</action>
  <what-built>
Cloudflare Named Tunnel настроен на VPS 89.208.106.208. Трафик проксируется: Cloudflare Edge (HTTPS) -> cloudflared -> Nginx (localhost:80) -> Docker container (localhost:3000). Tunnel работает как systemd service.

**Примечание:** На данном этапе MAAL Docker-контейнер ещё не запущен (это Phase 6). Поэтому при открытии URL будет 502 от Nginx — это ожидаемо. Цель этого плана — убедиться что инфраструктурная цепочка (cloudflared -> Nginx) работает.
  </what-built>
  <how-to-verify>
1. SSH на VPS: `ssh deploy@89.208.106.208`
2. Проверить tunnel: `cloudflared tunnel list` — должен быть tunnel "maal"
3. Проверить service: `sudo systemctl status cloudflared` — должен быть active
4. Открыть в браузере `https://maal.<DOMAIN>` — должен быть 502 Bad Gateway от Nginx (MAAL контейнер ещё не запущен, это нормально)
5. Проверить что 502 от Nginx, а не connection refused (значит Cloudflare -> Nginx работает)
6. Проверить что старые сервисы (OpenClaw) не затронуты: `docker ps`, `systemctl status`
  </how-to-verify>
  <resume-signal>Type "approved" if tunnel is working (502 from Nginx is expected). Describe issues if any.</resume-signal>
</task>

</tasks>

<verification>
1. `cloudflared tunnel list` показывает tunnel "maal" со статусом
2. `sudo systemctl is-active cloudflared` возвращает "active"
3. `sudo systemctl is-enabled cloudflared` возвращает "enabled"
4. `curl -I https://maal.<DOMAIN>` возвращает HTTP ответ (502 ожидаем, но НЕ connection refused)
5. `/home/deploy/.cloudflared/config.yml` содержит правильный hostname и catch-all правило
6. Существующие сервисы на VPS продолжают работать
</verification>

<success_criteria>
- cloudflared установлен на VPS
- Named Tunnel "maal" создан с DNS маршрутом
- config.yml имеет ingress rule к localhost:80 и catch-all 404
- cloudflared запущен как systemd service (auto-start при reboot)
- HTTPS URL доступен (502 от Nginx ожидаем — MAAL контейнер будет в Phase 6)
- Существующие сервисы не затронуты
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-vps-infrastructure-setup/05.1-02-SUMMARY.md`
</output>
