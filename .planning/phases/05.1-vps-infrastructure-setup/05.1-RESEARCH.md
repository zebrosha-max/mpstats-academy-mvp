# Phase 05.1: VPS Infrastructure Setup - Research

**Researched:** 2026-02-20
**Domain:** VPS infrastructure, Docker, Nginx, Cloudflare Tunnel, fail2ban
**Confidence:** HIGH

## Summary

Фаза 05.1 готовит VPS 89.208.106.208 к деплою MAAL. На сервере уже работает другой OpenClaw, поэтому ключевой принцип -- изоляция через Docker. Рекомендуется Docker Compose для управления MAAL-контейнером (Next.js standalone build), Nginx как reverse proxy, Cloudflare Tunnel для временного домена с HTTPS (без необходимости собственного домена на первом этапе), UFW + fail2ban для безопасности.

Из опыта проекта Talent на старом VPS (79.137.197.90) известно: Docker + Cloudflare Quick Tunnel работали стабильно для Next.js приложения. Аналогичный подход рекомендуется для MAAL, но с Named Tunnel вместо Quick Tunnel для персистентного URL.

**Primary recommendation:** Docker Compose + Nginx reverse proxy + Cloudflare Named Tunnel. Использовать существующего пользователя `deploy`. Next.js в standalone mode внутри Docker-контейнера.

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions
- SSH key auth, пароль отключить (как на старом VPS)
- Credentials хранятся в `Server auth.md`
- На сервере уже есть другие сервисы (другой OpenClaw) -- не ломать существующее
- Проверить что уже установлено перед установкой нового
- Node.js 20 LTS -- проверить наличие, установить если нет (через nvm или NodeSource)
- Nginx -- проверить наличие, установить если нет; добавить конфиг для MAAL
- Пользователь склоняется к Docker -- рассмотреть Docker-подход для изоляции MAAL от существующих сервисов
- PM2 vs systemd vs Docker -- на усмотрение Claude (Docker предпочтительнее)
- UFW -- проверить статус, настроить если нужно (порты 22, 80, 443, 3000)
- fail2ban -- установить, но с whitelist для IP агентов (vps-ops-manager), чтобы не банить автоматику при множественных подключениях
- **НЕ ngrok** -- используем Cloudflare Tunnel или DuckDNS (бесплатное решение)
- Был Cloudflare аккаунт для Talent на старом VPS -- можно переиспользовать
- Нужно простое и рабочее решение с HTTPS

### Claude's Discretion
- Выбор между отдельным пользователем `maal` или использованием существующего `deploy`
- PM2 vs systemd vs Docker compose для управления процессом
- Точный набор открытых портов (базовые + дополнительные)
- Выбор между Cloudflare Tunnel и DuckDNS для временного домена
- Docker architecture (Dockerfile, docker-compose)

### Deferred Ideas (OUT OF SCOPE)
None -- discussion stayed within phase scope
</user_constraints>

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| INFRA-01 | vps-ops-manager может подключиться к 89.208.106.208 и выполнять команды | SSH key auth setup, deploy user, sshd_config hardening |
| INFRA-02 | Node.js 20 LTS, PM2, Nginx установлены и работают на VPS | Docker-подход: Node.js внутри контейнера, Nginx на хосте как reverse proxy. PM2 не нужен при Docker (docker compose --restart) |
| INFRA-03 | Firewall (UFW) настроен: порты 22, 80, 443, 3000 открыты | UFW configuration + fail2ban с ignoreip whitelist |
| INFRA-04 | Временный домен с HTTPS работает и проксирует трафик на порт 3000 | Cloudflare Named Tunnel (рекомендация вместо ngrok) -- бесплатный, персистентный URL, автоматический HTTPS |
</phase_requirements>

## Standard Stack

### Core (на VPS хосте)

| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| Docker Engine | 27.x+ | Контейнеризация MAAL | Изоляция от существующих сервисов, воспроизводимость |
| Docker Compose | v2 (plugin) | Оркестрация контейнера | Декларативное управление, restart policies |
| Nginx | 1.24+ | Reverse proxy | Уже есть на старом VPS, стандарт для reverse proxy |
| UFW | встроен в Ubuntu | Firewall | Стандарт Ubuntu, простой синтаксис |
| fail2ban | 1.0+ | Защита от brute-force | Стандарт для SSH protection |
| cloudflared | latest | Cloudflare Tunnel daemon | Бесплатный HTTPS, персистентный URL, no port forwarding |

### Inside Docker Container

| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| node | 20-alpine | Runtime для Next.js standalone | LTS, alpine для минимального размера |
| Next.js standalone | 14.x | Self-contained server | Не требует node_modules, ~100MB вместо ~1GB |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Docker Compose | PM2 + bare Node.js | PM2 проще, но нет изоляции от OpenClaw; Docker лучше при cohabitation |
| Cloudflare Tunnel | DuckDNS + Let's Encrypt | DuckDNS требует открытия порта 80/443, ручного certbot, менее надежен; Cloudflare дает HTTPS бесплатно без открытых портов |
| Cloudflare Named Tunnel | Cloudflare Quick Tunnel | Quick Tunnel меняет URL при каждом перезапуске; Named Tunnel дает постоянный subdomain |
| Отдельный пользователь `maal` | Существующий `deploy` | Отдельный пользователь безопаснее, но создает overhead; Docker уже обеспечивает изоляцию |

## Architecture Patterns

### Recommended Infrastructure Layout

```
VPS 89.208.106.208
├── /etc/nginx/
│   ├── sites-available/
│   │   └── maal.conf              # reverse proxy -> localhost:3000
│   └── sites-enabled/
│       └── maal.conf -> ../sites-available/maal.conf
├── /home/deploy/
│   └── maal/
│       ├── docker-compose.yml      # MAAL container definition
│       ├── Dockerfile              # Next.js standalone build
│       ├── .env.production         # Environment variables
│       └── app/                    # Built application (volume or COPY)
├── /etc/fail2ban/
│   └── jail.local                  # SSH protection + ignoreip whitelist
├── /root/.cloudflared/             # or /home/deploy/.cloudflared/
│   ├── cert.pem                    # Cloudflare auth certificate
│   ├── <tunnel-uuid>.json          # Tunnel credentials
│   └── config.yml                  # Tunnel -> localhost:3000
└── systemd services:
    ├── cloudflared.service          # Tunnel daemon
    ├── docker containers            # MAAL via docker compose
    └── existing OpenClaw services   # НЕ ТРОГАТЬ
```

### Pattern 1: Next.js Standalone in Docker (Turborepo Monorepo)

**What:** Multi-stage Dockerfile для MAAL monorepo с turbo prune
**When to use:** Production deploy Next.js из Turborepo monorepo

```dockerfile
# Stage 1: Prepare - prune monorepo for target app
FROM node:20-alpine AS base
RUN apk update && apk add --no-cache libc6-compat
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate
WORKDIR /app

FROM base AS pruner
RUN pnpm add -g turbo@^2
COPY . .
RUN turbo prune @mpstats/web --docker

# Stage 2: Install dependencies (cached layer)
FROM base AS installer
COPY --from=pruner /app/out/json/ .
RUN pnpm install --frozen-lockfile

# Stage 3: Build
FROM base AS builder
COPY --from=installer /app/ .
COPY --from=pruner /app/out/full/ .

# Environment variables needed at build time
ARG NEXT_PUBLIC_SUPABASE_URL
ARG NEXT_PUBLIC_SUPABASE_ANON_KEY
ARG NEXT_PUBLIC_SITE_URL

ENV NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL
ENV NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY
ENV NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL

RUN pnpm turbo build --filter=@mpstats/web

# Stage 4: Production runner
FROM node:20-alpine AS runner
WORKDIR /app

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
USER nextjs

COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/public ./apps/web/public

ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME=0.0.0.0

CMD ["node", "apps/web/server.js"]
```

**Important:** Requires `output: 'standalone'` in `next.config.js` and `outputFileTracingRoot: path.join(__dirname, '../..')` for monorepo.

Source: [Turborepo Docker guide](https://turborepo.dev/docs/guides/tools/docker), [Next.js standalone output docs](https://nextjs.org/docs/app/api-reference/config/next-config-js/output)

### Pattern 2: docker-compose.yml для MAAL

**What:** Docker Compose file для запуска MAAL контейнера
**When to use:** Управление MAAL на VPS

```yaml
version: '3.8'

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL}
    ports:
      - "3000:3000"
    env_file:
      - .env.production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
```

### Pattern 3: Nginx Reverse Proxy Config

**What:** Nginx site config для проксирования на Docker контейнер
**When to use:** Когда Cloudflare Tunnel направляет трафик на Nginx (или при прямом доступе)

```nginx
server {
    listen 80;
    server_name maal.example.com;  # или _ для catch-all

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### Pattern 4: Cloudflare Named Tunnel config.yml

**What:** Конфигурация Cloudflare Tunnel для проксирования на localhost
**When to use:** Временный домен с HTTPS

```yaml
tunnel: <TUNNEL_UUID>
credentials-file: /home/deploy/.cloudflared/<TUNNEL_UUID>.json

ingress:
  - hostname: maal.example.com   # или subdomain на существующем домене
    service: http://localhost:80  # через Nginx
  - service: http_status:404     # catch-all обязателен
```

### Anti-Patterns to Avoid

- **Установка Node.js на хост для MAAL:** Docker уже содержит Node.js. Установка на хосте создает конфликт версий с OpenClaw.
- **Использование PM2 внутри Docker:** Docker сам управляет restart policy. PM2 внутри контейнера -- избыточен.
- **Cloudflare Quick Tunnel для production:** URL меняется при каждом перезапуске. Для стабильного доступа нужен Named Tunnel.
- **Открытие порта 3000 наружу:** Не нужно если используется Nginx + Cloudflare Tunnel. Порт 3000 только для localhost.
- **Редактирование /etc/fail2ban/jail.conf напрямую:** Изменения потеряются при обновлении. Всегда использовать jail.local.

## Discretion Decisions (Recommendations)

### 1. Пользователь: использовать существующего `deploy`

**Рекомендация:** Существующий `deploy`
**Причина:** Docker обеспечивает изоляцию на уровне контейнера. Отдельный пользователь `maal` создал бы overhead в управлении без значимого выигрыша в безопасности. На старом VPS Talent также работал через `deploy`.

### 2. Process manager: Docker Compose

**Рекомендация:** Docker Compose (не PM2, не systemd unit)
**Причина:**
- Docker изолирует MAAL от OpenClaw (разные контейнеры, разные environments)
- `restart: unless-stopped` заменяет PM2 watch/restart
- Пользователь явно склоняется к Docker
- На старом VPS Talent уже успешно работает через Docker

### 3. Порты: 22, 80, 443

**Рекомендация:** Открыть только 22, 80, 443. **НЕ открывать 3000 наружу.**
**Причина:** Cloudflare Tunnel подключается outbound (не нужен inbound на 3000). Nginx на 80 для health checks и прямого доступа. 443 зарезервирован на будущее (Let's Encrypt при переходе на свой домен). Порт 3000 слушает только localhost (Docker port mapping `127.0.0.1:3000:3000`).

### 4. Временный домен: Cloudflare Named Tunnel

**Рекомендация:** Cloudflare Named Tunnel
**Причина:**
- Бесплатный, входит в Cloudflare Free plan
- Автоматический HTTPS без Let's Encrypt/certbot
- Персистентный URL (не меняется при перезапуске, в отличие от Quick Tunnel)
- У пользователя уже есть Cloudflare аккаунт (от Talent проекта)
- Не требует открытия портов наружу (outbound-only connection)
- DuckDNS + Let's Encrypt требует больше настройки и менее надежен

**Два варианта Cloudflare Tunnel:**
1. **Если есть домен в Cloudflare** (mpstats.academy или другой) -- Named Tunnel с subdomain (напр. `maal.mpstats.academy`)
2. **Если нет домена** -- Quick Tunnel как fallback (URL типа `<random>.trycloudflare.com`), но URL непостоянный

Sources: [Cloudflare Tunnel docs](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/), [Create locally-managed tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/create-local-tunnel/)

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Process restart | Custom bash watchdog scripts | Docker `restart: unless-stopped` | Встроенный в Docker, battle-tested |
| HTTPS certificates | Manual openssl, self-signed | Cloudflare Tunnel auto-HTTPS | Zero maintenance, auto-renewal |
| SSH brute-force protection | Custom iptables rules | fail2ban | Стандарт, поддерживает jail.local overrides |
| Firewall rules | Raw iptables | UFW | Человекочитаемый синтаксис, стандарт Ubuntu |
| Monorepo Docker build | Manual copy of all packages | `turbo prune --docker` | Автоматически определяет зависимости |

**Key insight:** Каждый компонент инфраструктуры имеет стандартное решение. Кастомные скрипты создают tech debt без выигрыша.

## Common Pitfalls

### Pitfall 1: Сломать существующие сервисы на VPS

**What goes wrong:** Установка/обновление софта конфликтует с OpenClaw или другими сервисами.
**Why it happens:** Не проверили что уже установлено, перезаписали конфиги, порты пересеклись.
**How to avoid:**
1. Первый шаг -- аудит: `docker ps`, `systemctl list-units`, `ss -tlnp`, `nginx -t`, `node -v`, `ufw status`
2. Никогда не трогать конфиги, не принадлежащие MAAL
3. Docker контейнер MAAL использует свой порт (3000), не конфликтующий с существующими
4. Nginx -- добавлять ТОЛЬКО свой site config, не менять nginx.conf
**Warning signs:** Ошибки при `nginx -t`, порт already in use, другие сервисы перестали отвечать

### Pitfall 2: fail2ban банит автоматику (vps-ops-manager)

**What goes wrong:** Агент делает несколько SSH-подключений подряд, fail2ban считает это brute-force и банит IP.
**Why it happens:** Дефолтный maxretry=5 + findtime=10m слишком агрессивен для автоматики.
**How to avoid:**
```ini
# /etc/fail2ban/jail.local
[DEFAULT]
ignoreip = 127.0.0.1/8 ::1 <VPS-OPS-MANAGER-IP>

[sshd]
enabled = true
port = ssh
maxretry = 5
findtime = 600
bantime = 3600
```
**Warning signs:** Внезапный Connection refused от VPS при SSH

### Pitfall 3: NEXT_PUBLIC_ переменные не попадают в Docker build

**What goes wrong:** Приложение работает, но Supabase/site URL -- undefined.
**Why it happens:** NEXT_PUBLIC_ переменные инлайнятся при `next build`, а не при runtime. Docker ENV задает runtime переменные.
**How to avoid:** Передавать NEXT_PUBLIC_ как build ARG в Dockerfile и docker-compose.yml.
**Warning signs:** Ошибки Supabase auth, пустой `NEXT_PUBLIC_SITE_URL`, OAuth redirect failures

### Pitfall 4: Cloudflare Tunnel без catch-all ingress rule

**What goes wrong:** cloudflared не запускается или возвращает ошибки.
**Why it happens:** config.yml ОБЯЗАН заканчиваться catch-all правилом `- service: http_status:404`.
**How to avoid:** Всегда добавлять catch-all как последнее ingress rule.
**Warning signs:** `cloudflared tunnel run` выдает ошибку про missing catch-all

### Pitfall 5: standalone build в монорепо не находит файлы

**What goes wrong:** `MODULE_NOT_FOUND` при запуске `node server.js` в standalone output.
**Why it happens:** Next.js file tracing не видит файлы за пределами apps/web/ в монорепо.
**How to avoid:** Добавить `outputFileTracingRoot: path.join(__dirname, '../..')` в `next.config.js`.
**Warning signs:** Ошибки `Cannot find module` при запуске standalone server

Source: [Next.js output docs](https://nextjs.org/docs/app/api-reference/config/next-config-js/output)

### Pitfall 6: Docker port binding на 0.0.0.0

**What goes wrong:** Порт 3000 доступен извне, обходя Nginx и Cloudflare.
**Why it happens:** Docker по умолчанию биндит на 0.0.0.0.
**How to avoid:** В docker-compose.yml указывать `"127.0.0.1:3000:3000"` вместо `"3000:3000"`.
**Warning signs:** `curl <VPS-IP>:3000` работает извне

## Code Examples

### next.config.js -- обязательные изменения для standalone monorepo

```javascript
// Source: https://nextjs.org/docs/app/api-reference/config/next-config-js/output
const path = require('path');

/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
  outputFileTracingRoot: path.join(__dirname, '../../'),
  reactStrictMode: true,
  transpilePackages: ['@mpstats/api', '@mpstats/db', '@mpstats/shared'],
  experimental: {
    serverComponentsExternalPackages: ['@prisma/client'],
  },
  images: {
    remotePatterns: [
      { protocol: 'https', hostname: '*.supabase.co' },
      { protocol: 'https', hostname: 'kinescope.io' },
    ],
  },
};

module.exports = nextConfig;
```

### UFW setup script

```bash
# Check and configure UFW
sudo ufw status verbose

# If not active, set defaults and open required ports
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP (Nginx)
sudo ufw allow 443/tcp   # HTTPS (reserved)
sudo ufw enable
```

### fail2ban jail.local

```ini
[DEFAULT]
# Whitelist: localhost + vps-ops-manager IP
ignoreip = 127.0.0.1/8 ::1 <AGENT_IP>

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 5
findtime = 600
bantime = 3600
```

### Cloudflare Tunnel setup sequence

```bash
# 1. Install cloudflared
wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
sudo dpkg -i cloudflared-linux-amd64.deb

# 2. Login (opens browser URL for Cloudflare auth)
cloudflared tunnel login

# 3. Create named tunnel
cloudflared tunnel create maal

# 4. Route DNS (if have domain in Cloudflare)
cloudflared tunnel route dns maal maal.yourdomain.com

# 5. Create config.yml
cat > ~/.cloudflared/config.yml << 'EOF'
tunnel: <UUID>
credentials-file: /home/deploy/.cloudflared/<UUID>.json

ingress:
  - hostname: maal.yourdomain.com
    service: http://localhost:80
  - service: http_status:404
EOF

# 6. Install as systemd service
sudo cloudflared --config /home/deploy/.cloudflared/config.yml service install
sudo systemctl enable cloudflared
sudo systemctl start cloudflared
```

Source: [Cloudflare Tunnel locally-managed](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/create-local-tunnel/)

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| ngrok free tunnel | Cloudflare Tunnel (free) | 2024+ | Постоянный URL, нативный HTTPS, нет rate limit |
| PM2 на bare metal | Docker Compose | 2023+ | Изоляция, воспроизводимость, simplified ops |
| certbot + Let's Encrypt | Cloudflare auto-HTTPS | 2023+ | Zero maintenance SSL при использовании Tunnel |
| `docker-compose` (v1, python) | `docker compose` (v2, go plugin) | 2023 | v1 deprecated, v2 - часть Docker Engine |

**Deprecated/outdated:**
- docker-compose v1 (Python): заменен на `docker compose` v2 (Go plugin, часть Docker)
- ngrok free tier: один tunnel, непостоянный URL, rate limits
- Cloudflare Quick Tunnel: URL меняется при перезапуске -- не для production

## Open Questions

1. **Какие сервисы уже работают на 89.208.106.208?**
   - What we know: Есть другой OpenClaw
   - What's unclear: Какие порты заняты, есть ли Docker, Nginx, Node.js
   - Recommendation: Первый шаг плана -- полный аудит VPS (docker ps, ss -tlnp, systemctl, nginx -t)

2. **Какой домен использовать в Cloudflare?**
   - What we know: У пользователя есть Cloudflare аккаунт от Talent проекта
   - What's unclear: Есть ли домен в Cloudflare, можно ли добавить subdomain
   - Recommendation: Попробовать Named Tunnel с существующим доменом; fallback -- Quick Tunnel

3. **IP адрес vps-ops-manager для fail2ban whitelist**
   - What we know: Нужен whitelist чтобы не банить автоматику
   - What's unclear: Статический ли IP у агента, или нужен CIDR range
   - Recommendation: Спросить у пользователя при выполнении; можно добавить позже через `fail2ban-client`

4. **Нужен ли Node.js на хосте?**
   - What we know: Docker контейнер содержит свой Node.js; OpenClaw может требовать Node.js на хосте
   - What's unclear: Установлен ли Node.js, какая версия, используется ли OpenClaw
   - Recommendation: Проверить при аудите. Для MAAL Node.js на хосте НЕ нужен (все внутри Docker)

## Sources

### Primary (HIGH confidence)
- [Next.js standalone output docs](https://nextjs.org/docs/app/api-reference/config/next-config-js/output) -- standalone mode, outputFileTracingRoot
- [Turborepo Docker guide](https://turborepo.dev/docs/guides/tools/docker) -- turbo prune --docker, multi-stage Dockerfile
- [Cloudflare Tunnel docs](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/) -- Named Tunnel setup
- [Cloudflare local tunnel management](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/create-local-tunnel/) -- config.yml, DNS routing
- [Cloudflare run as Linux service](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/as-a-service/linux/) -- systemd service install
- [Docker multi-stage build docs](https://github.com/docker/docs/blob/main/content/get-started/workshop/09_image_best.md) -- best practices
- Context7 /llmstxt/nextjs_llms_txt -- standalone output, monorepo config
- Context7 /docker/docs -- multi-stage Dockerfile patterns

### Secondary (MEDIUM confidence)
- Episodic memory: Talent VPS (79.137.197.90) -- Docker + Cloudflare Quick Tunnel + Nginx architecture (verified working 2026-01-29)
- [DigitalOcean fail2ban guide](https://www.digitalocean.com/community/tutorials/how-to-protect-ssh-with-fail2ban-on-ubuntu-20-04) -- jail.local, ignoreip

### Tertiary (LOW confidence)
- None

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH -- Docker, Nginx, UFW, fail2ban, cloudflared -- все стандартные, хорошо документированные инструменты
- Architecture: HIGH -- паттерн проверен на Talent проекте (аналогичный стек)
- Pitfalls: HIGH -- из опыта Talent deploy + official docs warnings
- Cloudflare Tunnel specifics: MEDIUM -- зависит от наличия домена в Cloudflare аккаунте пользователя

**Research date:** 2026-02-20
**Valid until:** 2026-03-20 (стабильные инструменты, медленно меняются)
