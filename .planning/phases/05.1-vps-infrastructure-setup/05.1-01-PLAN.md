---
phase: 05.1-vps-infrastructure-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - docker-compose.yml
  - apps/web/next.config.js
  - .dockerignore
autonomous: false
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03

must_haves:
  truths:
    - "SSH подключение к 89.208.106.208 работает через deploy пользователя"
    - "SSH password authentication отключён (PasswordAuthentication no в sshd_config)"
    - "Docker и Docker Compose установлены и работают на VPS (заменяет PM2/Node.js на хосте — INFRA-02 реализован через Docker)"
    - "Nginx установлен и запущен на VPS"
    - "UFW активен с открытыми портами 22, 80, 443"
    - "fail2ban защищает SSH с whitelist для IP автоматики (vps-ops-manager)"
    - "Существующие сервисы (OpenClaw) продолжают работать"
    - "Dockerfile содержит корректный multi-stage build (статическая проверка; полная сборка верифицируется в Phase 6)"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage Docker build for Next.js standalone monorepo"
      contains: "turbo prune"
    - path: "docker-compose.yml"
      provides: "Docker Compose config for MAAL container"
      contains: "127.0.0.1:3000:3000"
    - path: "apps/web/next.config.js"
      provides: "Standalone output config for monorepo"
      contains: "output: 'standalone'"
    - path: ".dockerignore"
      provides: "Docker build exclusions"
      contains: "node_modules"
  key_links:
    - from: "docker-compose.yml"
      to: "Dockerfile"
      via: "build context"
      pattern: "build:"
    - from: "Dockerfile"
      to: "apps/web/next.config.js"
      via: "standalone output enables server.js"
      pattern: "server\\.js"
---

<objective>
Подготовить VPS 89.208.106.208 для деплоя MAAL: аудит существующих сервисов, установка Docker/Nginx/UFW/fail2ban, создание Dockerfile и docker-compose.yml для Next.js standalone build.

Purpose: Инфраструктура VPS готова для деплоя MAAL-контейнера (Phase 6). Docker изолирует MAAL от существующего OpenClaw.
Output: Работающий VPS с Docker/Nginx/UFW/fail2ban + Dockerfile/docker-compose.yml в репозитории.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-vps-infrastructure-setup/05.1-CONTEXT.md
@.planning/phases/05.1-vps-infrastructure-setup/05.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: VPS audit and software installation (Docker, Nginx, UFW, fail2ban)</name>
  <files>VPS: remote commands via SSH</files>
  <action>
**ВАЖНО: Это инфраструктурная задача. Все команды выполняются на VPS 89.208.106.208 через SSH (paramiko или vps-ops-manager). НЕ трогать существующие сервисы!**

**Step 1: Full VPS audit (ОБЯЗАТЕЛЬНО первым шагом)**

Подключиться к VPS через SSH как `deploy` (credentials в `Server auth.md`) и выполнить полный аудит:

```bash
# Что работает
docker ps 2>/dev/null || echo "Docker not installed"
docker compose version 2>/dev/null || echo "Docker Compose not available"
systemctl list-units --type=service --state=running --no-pager
ss -tlnp
nginx -v 2>/dev/null || echo "Nginx not installed"
node -v 2>/dev/null || echo "Node.js not installed"
ufw status verbose 2>/dev/null || echo "UFW not installed"
fail2ban-client status 2>/dev/null || echo "fail2ban not installed"
cat /etc/os-release | head -5
df -h /
free -h
```

Записать результат аудита — что уже установлено, какие порты заняты, какие сервисы работают. НЕ устанавливать ничего без анализа аудита.

**Step 1.5: SSH hardening — disable password authentication**

Per locked decision: "SSH key auth, пароль отключить". Проверить и при необходимости отключить парольную аутентификацию:

```bash
# Check current setting
grep -E "^#?PasswordAuthentication" /etc/ssh/sshd_config

# If PasswordAuthentication is not set to 'no', fix it:
sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/^#\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config

# Verify the change
grep -E "^PasswordAuthentication" /etc/ssh/sshd_config
# Expected: PasswordAuthentication no

# Reload sshd (NOT restart — reload сохраняет текущие сессии)
sudo systemctl reload sshd
```

**ВАЖНО:** Перед отключением пароля убедиться что SSH-ключ deploy пользователя работает. Если ключ НЕ настроен — НЕ отключать пароль, вместо этого добавить checkpoint для пользователя.

**Step 2: Install Docker (если не установлен)**

Если Docker не установлен:
```bash
sudo apt-get update
sudo apt-get install -y ca-certificates curl gnupg
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo usermod -aG docker deploy
```

Если Docker уже установлен — пропустить, только проверить `docker compose version`.

**Step 3: Install Nginx (если не установлен)**

Если Nginx не установлен:
```bash
sudo apt-get install -y nginx
sudo systemctl enable nginx
sudo systemctl start nginx
```

Если уже установлен — проверить что работает: `sudo nginx -t && systemctl status nginx`.

Создать конфиг для MAAL (ДОБАВИТЬ новый файл, НЕ менять существующие конфиги):
```bash
sudo tee /etc/nginx/sites-available/maal.conf << 'NGINX_EOF'
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Timeouts for long-running AI requests
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;
    }
}
NGINX_EOF
```

**ВНИМАНИЕ:** Если Nginx уже имеет конфиг в sites-enabled, использовать `server_name maal.local` (или другой уникальный) вместо `_` чтобы не конфликтовать с существующими конфигами. Проверить `ls /etc/nginx/sites-enabled/` перед линковкой.

```bash
sudo ln -sf /etc/nginx/sites-available/maal.conf /etc/nginx/sites-enabled/maal.conf
sudo nginx -t
sudo systemctl reload nginx
```

**Step 4: Configure UFW**

```bash
sudo ufw status verbose
```

Если UFW не активен:
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp comment 'SSH'
sudo ufw allow 80/tcp comment 'HTTP Nginx'
sudo ufw allow 443/tcp comment 'HTTPS reserved'
sudo ufw --force enable
```

Если уже активен — проверить что порты 22, 80, 443 открыты, добавить недостающие. НЕ удалять существующие правила.

**Step 5: Configure fail2ban**

```bash
sudo apt-get install -y fail2ban
```

Создать `/etc/fail2ban/jail.local` (НЕ редактировать jail.conf).

**ВАЖНО:** Per locked decision — fail2ban должен иметь whitelist для IP агентов (vps-ops-manager). Определить IP текущей SSH-сессии динамически через `$SSH_CLIENT`:

```bash
# Определить IP, с которого подключен vps-ops-manager (текущая SSH сессия)
AGENT_IP=$(echo $SSH_CLIENT | awk '{print $1}')
echo "Agent IP for whitelist: $AGENT_IP"

# Создать jail.local с whitelist, включающим IP агента
sudo tee /etc/fail2ban/jail.local << F2B_EOF
[DEFAULT]
# Whitelist: localhost + vps-ops-manager IP (determined at setup time)
# To add more IPs later: sudo fail2ban-client set sshd addignoreip <IP>
ignoreip = 127.0.0.1/8 ::1 ${AGENT_IP}

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 5
findtime = 600
bantime = 3600
F2B_EOF

sudo systemctl enable fail2ban
sudo systemctl restart fail2ban
sudo fail2ban-client status sshd

# Verify agent IP is in whitelist
sudo fail2ban-client get sshd ignoreip
```

**Примечание:** Если IP агента динамический (меняется), можно добавить CIDR range позже: `sudo fail2ban-client set sshd addignoreip <CIDR>`. Но на момент установки текущий IP ОБЯЗАТЕЛЬНО добавляется.

**Step 6: Create MAAL directory on VPS**

```bash
mkdir -p /home/deploy/maal
```

**Step 7: Verify existing services still work**

```bash
# Check all services still running
docker ps 2>/dev/null
systemctl list-units --type=service --state=running --no-pager | grep -E "openclaw|nginx|docker|fail2ban"
ss -tlnp
```

Убедиться что все существующие сервисы (OpenClaw и др.) продолжают работать после настройки.
  </action>
  <verify>
На VPS выполнить:
```bash
docker --version && docker compose version
nginx -v && sudo nginx -t
ufw status verbose | grep -E "22|80|443"
sudo fail2ban-client status sshd
sudo fail2ban-client get sshd ignoreip  # Must include agent IP
grep "^PasswordAuthentication no" /etc/ssh/sshd_config  # SSH password disabled
ls /home/deploy/maal/
# Verify existing services still running
docker ps 2>/dev/null
```
Все команды должны вернуть успешный результат. PasswordAuthentication=no. Agent IP в ignoreip. Существующие контейнеры/сервисы в `docker ps` не изменились.
  </verify>
  <done>SSH password auth отключён. Docker Engine + Compose, Nginx, UFW (22/80/443), fail2ban (с whitelist agent IP) установлены и работают. /home/deploy/maal/ создан. Существующие сервисы не затронуты.</done>
</task>

<task type="auto">
  <name>Task 2: Create Dockerfile, docker-compose.yml, and update next.config.js for standalone build</name>
  <files>
    Dockerfile
    docker-compose.yml
    .dockerignore
    apps/web/next.config.js
  </files>
  <action>
**Создать файлы в репозитории MAAL (локально, не на VPS).**

**File 1: `Dockerfile` (в корне монорепо)**

Multi-stage Dockerfile для Turborepo monorepo с turbo prune:

```dockerfile
# Stage 1: Base image with pnpm
FROM node:20-alpine AS base
RUN apk update && apk add --no-cache libc6-compat
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate
WORKDIR /app

# Stage 2: Prune monorepo for target app
FROM base AS pruner
RUN pnpm add -g turbo@^2
COPY . .
RUN turbo prune @mpstats/web --docker

# Stage 3: Install dependencies (cached layer)
FROM base AS installer
COPY --from=pruner /app/out/json/ .
RUN pnpm install --frozen-lockfile

# Stage 4: Build (inherits from installer which has node_modules)
FROM installer AS builder
COPY --from=pruner /app/out/full/ .

# NEXT_PUBLIC_ variables must be available at build time
ARG NEXT_PUBLIC_SUPABASE_URL
ARG NEXT_PUBLIC_SUPABASE_ANON_KEY
ARG NEXT_PUBLIC_SITE_URL

ENV NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL
ENV NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY
ENV NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL

RUN pnpm turbo build --filter=@mpstats/web

# Stage 5: Production runner (minimal image)
FROM node:20-alpine AS runner
WORKDIR /app

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
USER nextjs

COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/public ./apps/web/public

ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME=0.0.0.0

EXPOSE 3000

CMD ["node", "apps/web/server.js"]
```

**File 2: `docker-compose.yml` (в корне монорепо)**

```yaml
services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL}
    ports:
      - "127.0.0.1:3000:3000"
    env_file:
      - .env.production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

**ВАЖНО:** Порт `127.0.0.1:3000:3000` — только localhost, не наружу. Cloudflare Tunnel и Nginx будут проксировать.

**File 3: `.dockerignore` (в корне монорепо)**

```
node_modules
.next
.git
.github
.planning
docs
screenshots
_backup_design_v1
*.md
!README.md
.env
.env.*
!.env.example
```

**File 4: Update `apps/web/next.config.js`**

Добавить `output: 'standalone'` и `outputFileTracingRoot` для монорепо:

```javascript
const path = require('path');

/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
  outputFileTracingRoot: path.join(__dirname, '../../'),
  reactStrictMode: true,
  transpilePackages: ['@mpstats/api', '@mpstats/db', '@mpstats/shared'],
  experimental: {
    serverComponentsExternalPackages: ['@prisma/client'],
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.supabase.co',
      },
      {
        protocol: 'https',
        hostname: 'kinescope.io',
      },
    ],
  },
};

module.exports = nextConfig;
```

`outputFileTracingRoot` указывает на корень монорепо (`../../` от apps/web/), чтобы standalone build включил файлы из packages/*.
  </action>
  <verify>
Проверить что файлы созданы и синтаксически корректны:
```bash
# Files exist
ls Dockerfile docker-compose.yml .dockerignore apps/web/next.config.js

# next.config.js has standalone
grep "output.*standalone" apps/web/next.config.js
grep "outputFileTracingRoot" apps/web/next.config.js

# docker-compose has localhost binding
grep "127.0.0.1:3000" docker-compose.yml

# Dockerfile has turbo prune
grep "turbo prune" Dockerfile
```
  </verify>
  <done>Dockerfile (multi-stage turbo prune), docker-compose.yml (localhost:3000), .dockerignore, и обновленный next.config.js (standalone + outputFileTracingRoot) созданы в репозитории.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify VPS setup and Docker files</name>
  <what-built>
VPS 89.208.106.208 настроен: Docker, Nginx, UFW, fail2ban. В репозитории созданы Dockerfile, docker-compose.yml, .dockerignore. next.config.js обновлен для standalone build.
  </what-built>
  <action>Human verification of VPS infrastructure and Docker build files.</action>
  <how-to-verify>
1. SSH на VPS: `ssh deploy@89.208.106.208`
2. Проверить: `docker --version`, `nginx -v`, `ufw status`, `fail2ban-client status`
3. Убедиться что OpenClaw и другие сервисы работают: `docker ps`, `systemctl status`
4. Локально: проверить что `Dockerfile`, `docker-compose.yml`, `.dockerignore` и обновленный `next.config.js` выглядят корректно
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `ssh deploy@89.208.106.208` подключается успешно
2. `grep "^PasswordAuthentication no" /etc/ssh/sshd_config` — password auth отключён
3. `docker --version` и `docker compose version` возвращают версии
4. `sudo nginx -t` проходит без ошибок
5. `ufw status` показывает порты 22, 80, 443 открытыми
6. `sudo fail2ban-client status sshd` показывает jail активным
7. `sudo fail2ban-client get sshd ignoreip` содержит IP агента (не только localhost)
8. `docker ps` показывает ВСЕ существующие контейнеры без изменений
9. Файлы Dockerfile, docker-compose.yml, .dockerignore существуют в корне монорепо
10. `grep "standalone" apps/web/next.config.js` находит настройку
</verification>

<success_criteria>
- VPS 89.208.106.208 доступен через SSH (key auth only, password disabled)
- Docker Engine + Docker Compose работают (заменяет PM2/Node.js — INFRA-02)
- Nginx запущен с конфигом maal.conf (reverse proxy на localhost:3000)
- UFW активен (порты 22, 80, 443)
- fail2ban защищает SSH с whitelist для IP агента
- Существующие сервисы не затронуты
- Dockerfile для Turborepo monorepo standalone build готов
- docker-compose.yml с localhost-only port binding готов
- next.config.js обновлен для standalone output
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-vps-infrastructure-setup/05.1-01-SUMMARY.md`
</output>
