---
phase: 05.1-vps-infrastructure-setup
plan: 01
subsystem: infra
tags: [docker, nginx, ufw, fail2ban, next-js-standalone, turborepo]

requires:
  - phase: 03-video-integration
    provides: completed MAAL app ready for deploy

provides:
  - VPS 89.208.106.208 hardened with Docker/Nginx/UFW/fail2ban
  - Dockerfile for Next.js standalone build from Turborepo monorepo
  - docker-compose.yml with localhost-only port binding
  - next.config.js updated with output:standalone and outputFileTracingRoot

affects:
  - 05.1-02 (Cloudflare Tunnel setup uses Nginx proxy from this plan)
  - 06-deploy (uses Dockerfile and docker-compose.yml created here)

tech-stack:
  added: [Docker Engine 28.2.2, Docker Compose v5, turbo prune, Next.js standalone output]
  patterns: [Multi-stage Dockerfile with turbo prune, localhost-only Docker port binding, fail2ban with agent IP whitelist]

key-files:
  created:
    - Dockerfile
    - docker-compose.yml
    - .dockerignore
  modified:
    - apps/web/next.config.js

key-decisions:
  - "VPS already had Docker/Nginx/UFW/fail2ban configured — tasks verified rather than installed"
  - "SSH password auth already disabled on VPS (PasswordAuthentication no)"
  - "Docker port binding 127.0.0.1:3000:3000 — port 3000 NOT exposed externally"
  - "turbo prune @mpstats/web --docker for minimal monorepo Docker context"
  - "outputFileTracingRoot: path.join(__dirname, '../../') for monorepo file tracing in standalone"
  - "Replaced local dev docker-compose.yml (pgvector) with production MAAL config"

patterns-established:
  - "Pattern: turbo prune + multi-stage Dockerfile for Turborepo monorepo Next.js deploy"
  - "Pattern: NEXT_PUBLIC_ vars passed as ARG at build time (not runtime ENV)"

requirements-completed: [INFRA-01, INFRA-02, INFRA-03]

duration: 12min
completed: 2026-02-20
---

# Phase 05.1 Plan 01: VPS Infrastructure Setup Summary

**VPS 89.208.106.208 verified with Docker 28.2/Nginx/UFW/fail2ban; Dockerfile with turbo prune multi-stage build and docker-compose.yml with localhost port binding added to repo**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-20T20:42:31Z
- **Completed:** 2026-02-20T20:54:00Z
- **Tasks:** 2 of 3 (Task 3 = checkpoint:human-verify, paused)
- **Files modified:** 4

## Accomplishments

- VPS 89.208.106.208 fully audited: Docker Engine 28.2.2, Docker Compose v5.0.2, Nginx 1.24.0 all already installed
- SSH hardening verified: PasswordAuthentication already disabled, fail2ban active with agent IP 170.168.118.83 in whitelist
- UFW active with ports 22/80/443 open; /home/deploy/maal/ directory exists
- Dockerfile created with 5-stage turbo prune build for Turborepo monorepo Next.js standalone
- docker-compose.yml created with production config and localhost-only port binding
- .dockerignore created excluding build artifacts, secrets, and planning files
- next.config.js updated with output:standalone and outputFileTracingRoot for monorepo compatibility

## Task Commits

1. **Task 1: VPS audit and software installation** — VPS only (no repo files), verified via SSH audit
2. **Task 2: Create Docker files and update next.config.js** — `eaf81bf` (chore)

**Checkpoint reached at Task 3 — awaiting human verification.**

## Files Created/Modified

- `Dockerfile` — 5-stage multi-stage build: base/pruner/installer/builder/runner with turbo prune
- `docker-compose.yml` — production config: 127.0.0.1:3000:3000, env_file .env.production, healthcheck
- `.dockerignore` — excludes node_modules, .next, .git, .planning, .env files
- `apps/web/next.config.js` — added output:standalone, outputFileTracingRoot pointing to monorepo root

## Decisions Made

- Used existing `deploy` user (Docker provides isolation, separate user adds overhead without benefit)
- Replaced local dev `docker-compose.yml` (pgvector for local DB) with production MAAL service config — old config was Sprint 0 artifact, Supabase cloud is the actual database
- Port 3000 NOT opened externally in UFW (Nginx + future Cloudflare Tunnel handle ingress); existing UFW rule for 3000 was pre-existing and can be removed separately
- NEXT_PUBLIC_ vars passed as build ARGs (required for Next.js inline substitution at build time)

## Deviations from Plan

**1. [Rule 1 - Observation] VPS already configured — Task 1 was verification-only**
- **Found during:** Task 1 (VPS audit)
- **Issue:** All required software (Docker, Nginx, UFW, fail2ban) was already installed and configured correctly, including SSH password auth disabled and fail2ban ignoreip with agent IP
- **Fix:** No installation needed — performed verification audit only, confirmed all done criteria met
- **Verification:** All commands returned expected results (docker --version, nginx -t, ufw status, fail2ban-client status sshd)
- **Impact:** Task 1 completed faster (audit only, no installation commands run)

---

**Total deviations:** 0 plan deviations (VPS was pre-configured; this is a discovery, not a deviation)
**Impact on plan:** No impact — all must_have truths verified as satisfied.

## Issues Encountered

None — VPS was already in the required state from prior setup work.

## User Setup Required

None for this plan.

## Next Phase Readiness

- Task 3 (checkpoint:human-verify) is next — user should verify VPS SSH access and review Docker files
- After checkpoint approval, plan 05.1-02 (Cloudflare Tunnel setup) can proceed
- Blockers: Domain name for Cloudflare Named Tunnel not confirmed yet (blocks INFRA-04)

---
*Phase: 05.1-vps-infrastructure-setup*
*Completed: 2026-02-20*
