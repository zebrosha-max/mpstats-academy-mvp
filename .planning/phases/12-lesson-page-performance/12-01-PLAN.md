---
phase: 12-lesson-page-performance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/video/KinescopePlayer.tsx
  - apps/web/src/components/video/VideoPlaceholder.tsx
  - apps/web/src/app/(main)/learn/[id]/page.tsx
  - apps/web/src/lib/trpc/provider.tsx
  - packages/api/src/routers/learning.ts
autonomous: true
requirements:
  - PERF-01
  - PERF-02
  - PERF-03

must_haves:
  truths:
    - "Страница урока показывает контент (breadcrumb, заголовок, summary) без ожидания загрузки видео"
    - "Видеоплеер не загружает Kinescope iframe до клика пользователя на кнопку Play"
    - "После клика Play iframe загружается и видео воспроизводится"
    - "Повторное открытие того же урока использует кешированные данные (не показывает скелетон)"
    - "seekTo по источникам и таймкодам продолжает работать после загрузки плеера"
  artifacts:
    - path: "apps/web/src/components/video/KinescopePlayer.tsx"
      provides: "Lazy video player with thumbnail placeholder and click-to-load"
      contains: "LazyVideoPlayer"
    - path: "apps/web/src/lib/trpc/provider.tsx"
      provides: "Optimized React Query cache settings"
      contains: "gcTime"
    - path: "packages/api/src/routers/learning.ts"
      provides: "Optimized getLesson with single query"
  key_links:
    - from: "apps/web/src/app/(main)/learn/[id]/page.tsx"
      to: "apps/web/src/components/video/KinescopePlayer.tsx"
      via: "VideoPlayer or LazyVideoPlayer component"
      pattern: "VideoPlayer|LazyVideoPlayer"
    - from: "apps/web/src/components/video/KinescopePlayer.tsx"
      to: "Kinescope iframe"
      via: "Click-to-load trigger"
      pattern: "onClick.*setActivated"
---

<objective>
Оптимизировать производительность страницы урока: lazy-загрузка видеоплеера (iframe появляется только после клика), оптимизация tRPC запросов и кеширования.

Purpose: Пользователь видит контент страницы быстро, видео не блокирует рендер, повторные посещения используют кеш.
Output: Быстрая страница урока с lazy video и оптимизированным кешированием.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-lesson-page-performance/12-CONTEXT.md
@apps/web/src/app/(main)/learn/[id]/page.tsx
@apps/web/src/components/video/KinescopePlayer.tsx
@apps/web/src/lib/trpc/provider.tsx
@packages/api/src/routers/learning.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement lazy video loading with click-to-play placeholder</name>
  <files>
    apps/web/src/components/video/KinescopePlayer.tsx
    apps/web/src/components/video/VideoPlaceholder.tsx
    apps/web/src/app/(main)/learn/[id]/page.tsx
  </files>
  <action>
Переделать KinescopePlayer в lazy-загружаемый плеер с thumbnail placeholder:

1. **KinescopePlayer.tsx** — добавить состояние `activated` (default: false):
   - Когда `activated === false`: рендерить placeholder с кнопкой Play поверх
   - Placeholder: `aspect-video` div с фоном `bg-mp-gray-900`, по центру крупная кнопка Play (белый треугольник в полупрозрачном круге), cursor-pointer
   - Попробовать загрузить Kinescope poster: `https://kinescope.io/embed/${videoId}` как img с `loading="lazy"`. Если получится — использовать как фон placeholder. Если нет — использовать тёмный фон с иконкой видео.
   - НО: poster URL от Kinescope может быть `https://kinescope.io/${videoId}/poster` — проверить. Если не работает, использовать generica `bg-gradient-to-br from-mp-gray-800 to-mp-gray-900` с иконкой камеры.
   - При клике на placeholder: `setActivated(true)` → рендерить реальный iframe через существующую логику `loadKinescopeApi()`
   - После активации — автозапуск видео (передать `autoPlay: true` в `factory.create` options)
   - seekTo должен работать: если `seekTo` вызван до активации — сохранить в `pendingSeekRef` И активировать плеер (setActivated(true)), чтобы timecode клики автоматически запускали загрузку

2. **VideoPlaceholder.tsx** — оставить как есть (используется когда videoId === null)

3. **Lesson page** — убедиться что VideoPlayer ref и seekTo продолжают работать. Никаких изменений в логике вызова — lazy loading инкапсулирован внутри KinescopePlayer.

Важно: НЕ добавлять IntersectionObserver или viewport-based loading — только click-to-load per CONTEXT.md decision.
  </action>
  <verify>
    <automated>cd "D:/GpT_docs/MPSTATS ACADEMY ADAPTIVE LEARNING/MAAL" && pnpm build 2>&1 | tail -5</automated>
    <manual>Открыть страницу урока — должен быть тёмный placeholder с кнопкой Play вместо iframe. После клика — видео загружается и воспроизводится.</manual>
  </verify>
  <done>
    - Страница урока рендерит placeholder вместо iframe (Kinescope JS не загружается до клика)
    - Клик на Play загружает iframe и запускает воспроизведение
    - seekTo через источники/таймкоды активирует плеер автоматически и перематывает на позицию
    - VideoPlaceholder (no videoId) продолжает работать как раньше
  </done>
</task>

<task type="auto">
  <name>Task 2: Optimize tRPC caching and getLesson query</name>
  <files>
    apps/web/src/lib/trpc/provider.tsx
    packages/api/src/routers/learning.ts
    apps/web/src/app/(main)/learn/[id]/page.tsx
  </files>
  <action>
Оптимизировать кеширование и запросы для быстрой загрузки:

1. **provider.tsx** — настроить React Query для агрессивного кеширования:
   - Оставить `staleTime: 5 * 60 * 1000` (5 мин) — уже хорошо для дефолта
   - Добавить `gcTime: 30 * 60 * 1000` (30 мин) — данные остаются в кеше 30 минут после unmount (дефолт 5 мин слишком мало для навигации назад-вперёд между уроками)
   - Добавить `retry: 1` — не тратить время на 3 retry при ошибке (дефолт 3)

2. **learning.ts getLesson** — оптимизировать запрос:
   - Сейчас делает 2 DB запроса: `findUnique(lesson)` + `findMany(courseLessons)` для навигации
   - Объединить в 1 запрос: использовать `findUnique` с `include: { course: { include: { lessons: { orderBy: { order: 'asc' }, select: { id: true, title: true, order: true } } } } }` — получить id/title/order всех уроков курса через relation
   - Это даст навигацию (prev/next) без второго запроса
   - Не включать полный progress для всех уроков курса — только для текущего урока (через отдельный progress include на самом уроке)
   - Из courseLessons (через course.lessons) извлечь только id для prev/next — не нужны полные LessonWithProgress для навигации
   - Упростить тип возвращаемых prev/next: `{ id: string; title: string }` вместо полного LessonWithProgress

3. **Lesson page** — адаптировать к упрощённому типу prev/next:
   - prevLesson и nextLesson теперь содержат только `{ id, title }` — обновить использование
   - Сейчас из prevLesson/nextLesson используется только `id` (для Link href) — минимальное изменение

Не делать: prefetch следующего урока (per CONTEXT.md — не усложнять).
  </action>
  <verify>
    <automated>cd "D:/GpT_docs/MPSTATS ACADEMY ADAPTIVE LEARNING/MAAL" && pnpm build 2>&1 | tail -5</automated>
    <manual>Открыть урок, перейти на другую страницу, вернуться — урок должен загрузиться мгновенно из кеша (без скелетона). Навигация prev/next продолжает работать.</manual>
  </verify>
  <done>
    - gcTime 30 мин обеспечивает кеширование при навигации между уроками
    - getLesson выполняет 1 DB запрос вместо 2
    - Prev/next навигация работает с упрощённым типом
    - retry: 1 вместо 3 для быстрого отображения ошибок
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` проходит без ошибок
2. Страница урока показывает placeholder вместо iframe при первой загрузке
3. Клик на Play загружает и воспроизводит видео
4. seekTo через источники автоматически активирует плеер
5. Повторное открытие урока не показывает скелетон (данные из кеша)
6. Навигация prev/next работает корректно
</verification>

<success_criteria>
- Контент страницы (breadcrumb, заголовок, summary) рендерится без ожидания iframe
- Kinescope JS SDK не загружается до клика на Play
- React Query кеш хранит данные 30 минут
- getLesson использует 1 DB запрос
- Все существующие функции (seekTo, chat, summary) работают
</success_criteria>

<output>
After completion, create `.planning/phases/12-lesson-page-performance/12-01-SUMMARY.md`
</output>
