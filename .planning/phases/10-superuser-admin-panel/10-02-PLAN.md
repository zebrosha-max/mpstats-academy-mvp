---
phase: 10-superuser-admin-panel
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - apps/web/src/app/(admin)/admin/page.tsx
  - apps/web/src/app/(admin)/admin/users/page.tsx
  - apps/web/src/app/(admin)/admin/analytics/page.tsx
  - apps/web/src/app/(admin)/admin/content/page.tsx
  - apps/web/src/components/admin/StatCard.tsx
  - apps/web/src/components/admin/UserTable.tsx
  - apps/web/src/components/admin/ActivityChart.tsx
  - apps/web/src/components/admin/CourseManager.tsx
autonomous: false
requirements:
  - ADMIN-01
  - ADMIN-02
  - ADMIN-03
  - ADMIN-04
  - ADMIN-05

must_haves:
  truths:
    - "Admin sees dashboard with KPI cards showing platform statistics"
    - "Admin sees charts for user growth and activity over time"
    - "Admin can search users by name and see paginated list"
    - "Admin can toggle isAdmin and isActive via inline switches"
    - "Admin sees courses with lesson counts and can reorder lessons"
  artifacts:
    - path: "apps/web/src/app/(admin)/admin/page.tsx"
      provides: "Admin dashboard with KPI cards, recent events, and quick chart"
      min_lines: 50
    - path: "apps/web/src/app/(admin)/admin/users/page.tsx"
      provides: "Users management page with table, search, pagination, toggle switches"
      min_lines: 80
    - path: "apps/web/src/app/(admin)/admin/analytics/page.tsx"
      provides: "Analytics page with growth and activity charts"
      min_lines: 50
    - path: "apps/web/src/app/(admin)/admin/content/page.tsx"
      provides: "Content management page with courses and lesson ordering"
      min_lines: 50
    - path: "apps/web/src/components/admin/UserTable.tsx"
      provides: "Table component with search, pagination, inline toggles"
      min_lines: 60
  key_links:
    - from: "apps/web/src/app/(admin)/admin/page.tsx"
      to: "packages/api/src/routers/admin.ts"
      via: "trpc.admin.getDashboardStats.useQuery()"
      pattern: "trpc\\.admin\\.getDashboardStats"
    - from: "apps/web/src/app/(admin)/admin/users/page.tsx"
      to: "packages/api/src/routers/admin.ts"
      via: "trpc.admin.getUsers.useQuery() and trpc.admin.toggleUserField.useMutation()"
      pattern: "trpc\\.admin\\.(getUsers|toggleUserField)"
    - from: "apps/web/src/app/(admin)/admin/content/page.tsx"
      to: "packages/api/src/routers/admin.ts"
      via: "trpc.admin.getCourses.useQuery() and trpc.admin.updateLessonOrder.useMutation()"
      pattern: "trpc\\.admin\\.(getCourses|updateLessonOrder)"
---

<objective>
Build all admin panel pages: Dashboard with KPI cards and recent events, Users management with search/pagination/inline toggles, Analytics with time-series charts, and Content management with course/lesson viewing and reordering.

Purpose: Complete the admin experience — admin can monitor platform health, manage users, view analytics, and organize content.
Output: Four fully functional admin pages consuming the admin tRPC router from Plan 01.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-superuser-admin-panel/10-01-SUMMARY.md
@packages/api/src/routers/admin.ts
@apps/web/src/app/(admin)/layout.tsx
@apps/web/src/components/admin/AdminSidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin Dashboard page + Users management page</name>
  <files>
    apps/web/src/app/(admin)/admin/page.tsx
    apps/web/src/app/(admin)/admin/users/page.tsx
    apps/web/src/components/admin/StatCard.tsx
    apps/web/src/components/admin/UserTable.tsx
  </files>
  <action>
1. **StatCard component** (`apps/web/src/components/admin/StatCard.tsx`):
   - Simple reusable card: icon, title, value, optional trend/change indicator
   - Uses Card from shadcn/ui with mp-color variants
   - Props: `{ title: string, value: string | number, icon: LucideIcon, trend?: string, color?: 'blue' | 'green' | 'pink' | 'gray' }`

2. **Admin Dashboard** (`apps/web/src/app/(admin)/admin/page.tsx`):
   - Client component (`'use client'`)
   - Calls `trpc.admin.getDashboardStats.useQuery()`
   - **KPI Cards row** (4 cards in grid): Total Users, Completed Diagnostics, Total Lessons, Recent Registrations (7d)
   - **Recent Events section**: Compact list of last 5-10 events. Since we don't have an Activity/Event model, derive from:
     - Recent DiagnosticSessions (completed) — "User X completed diagnostic"
     - Recent UserProfile creations — "New user registered"
     - Query these in `getDashboardStats` or add a new `getRecentActivity` procedure if needed
   - **Quick Stats**: Small area chart showing registrations per day (last 7 days) using Recharts (already in project for RadarChart)
   - Loading state: skeleton cards (use existing Skeleton component pattern)
   - Error state: DatabaseError component pattern
   - Use mp-blue, mp-green, mp-pink for card accents per CONTEXT.md

3. **UserTable component** (`apps/web/src/components/admin/UserTable.tsx`):
   - Client component
   - Props: receives users array, totalCount, pagination handlers, search handlers
   - Table layout: Avatar (initials fallback), Name, Email (if available from user data, otherwise "—"), Registration date (formatted), Diagnostics count, isActive toggle (Switch), isAdmin toggle (Switch)
   - Switch components: use shadcn/ui Switch (if not available, create minimal toggle with input checkbox + styled label)
   - Toggle calls `trpc.admin.toggleUserField.useMutation()` with optimistic update (flip UI immediately, revert on error)
   - Search input at top: debounced (300ms) text input filtering by name
   - Pagination: simple "Previous / Page X of Y / Next" at bottom
   - Empty state: "No users found"

4. **Users page** (`apps/web/src/app/(admin)/admin/users/page.tsx`):
   - Client component
   - State: search query, page number, limit (default 20)
   - Calls `trpc.admin.getUsers.useQuery({ search, page, limit })`
   - Renders UserTable with data
   - Page title: "Управление пользователями" with user count badge

Note: The admin router from Plan 01 may need a `getRecentActivity` procedure. If it doesn't exist, add it in this plan — it should query recent DiagnosticSessions (COMPLETED, last 7 days) and recent UserProfile creations (last 7 days), merge and sort by date. Return array of `{ type: 'registration' | 'diagnostic', userName: string, date: Date }`.
  </action>
  <verify>
    <automated>cd D:/GpT_docs/MPSTATS\ ACADEMY\ ADAPTIVE\ LEARNING/MAAL && pnpm typecheck</automated>
    <manual>
      1. Visit /admin as admin user → see 4 KPI cards with real data
      2. See recent events list below cards
      3. Navigate to /admin/users → see user table with search and toggles
      4. Search by name → table filters
      5. Toggle isAdmin switch → value changes (optimistic update)
    </manual>
  </verify>
  <done>
    - Admin dashboard shows 4 KPI cards with live stats from DB
    - Recent activity section shows last registrations and diagnostics
    - Users page renders paginated table with search
    - Inline toggle switches work for isAdmin and isActive fields
    - All data comes from tRPC admin router (no mock data)
  </done>
</task>

<task type="auto">
  <name>Task 2: Analytics page + Content management page</name>
  <files>
    apps/web/src/app/(admin)/admin/analytics/page.tsx
    apps/web/src/app/(admin)/admin/content/page.tsx
    apps/web/src/components/admin/ActivityChart.tsx
    apps/web/src/components/admin/CourseManager.tsx
  </files>
  <action>
1. **ActivityChart component** (`apps/web/src/components/admin/ActivityChart.tsx`):
   - Client component using Recharts (already in project)
   - Area chart (per CONTEXT.md: "линейные area chart")
   - Props: `{ data: Array<{ date: string, count: number }>, title: string, color?: string }`
   - Responsive container, tooltip, gradient fill
   - Uses mp-blue for user growth, mp-green for activity

2. **Analytics page** (`apps/web/src/app/(admin)/admin/analytics/page.tsx`):
   - Client component
   - Period selector: buttons for 7d / 14d / 30d / 90d (per CONTEXT.md: "7 дней по умолчанию, переключатель на 14d/30d/90d")
   - State: `period` (default 7)
   - Two charts side by side (grid layout):
     - **User Growth**: registrations per day for selected period
     - **Activity**: diagnostics completed per day for selected period
   - Add new tRPC procedure `getAnalytics` to admin router if not present from Plan 01:
     - Input: `{ days: number }` (7, 14, 30, 90)
     - Query: Group UserProfile by createdAt date, DiagnosticSession (COMPLETED) by completedAt date
     - Return: `{ userGrowth: Array<{date, count}>, activity: Array<{date, count}> }`
     - Use raw SQL or Prisma groupBy with date truncation
   - Summary stats above charts: total for period, average per day, peak day

3. **CourseManager component** (`apps/web/src/components/admin/CourseManager.tsx`):
   - Client component
   - Accordion layout (per CONTEXT.md discretion — accordion is natural for hierarchical course > lesson)
   - Each course: expandable section showing title, lesson count, content chunk count
   - Inside expanded course: list of lessons with order number, title, skillCategory badge, videoId status (has video / no video)
   - Lesson reordering: Up/Down arrow buttons (per discretion — simpler than DnD, no extra dependency)
     - Click up/down → calls `trpc.admin.updateLessonOrder.useMutation()` → swaps order with adjacent lesson
     - Optimistic UI update
   - Read-only metadata display (per discretion — view-only for MVP, no inline edit)
   - Stats per course: lesson count, chunks count (RAG coverage indicator)

4. **Content page** (`apps/web/src/app/(admin)/admin/content/page.tsx`):
   - Client component
   - Calls `trpc.admin.getCourses.useQuery()`
   - Renders CourseManager with course data
   - Page title: "Управление контентом" with total courses/lessons count
   - Loading: skeleton accordion
  </action>
  <verify>
    <automated>cd D:/GpT_docs/MPSTATS\ ACADEMY\ ADAPTIVE\ LEARNING/MAAL && pnpm typecheck</automated>
    <manual>
      1. Visit /admin/analytics → see two area charts
      2. Switch period to 30d → charts update with more data
      3. Visit /admin/content → see accordion with 6 courses
      4. Expand a course → see lessons with order numbers and category badges
      5. Click up/down arrows → lesson order changes
    </manual>
  </verify>
  <done>
    - Analytics page shows user growth and activity charts with period selector
    - Charts use Recharts AreaChart with mp-color gradients
    - Period selector works (7d, 14d, 30d, 90d)
    - Content page shows courses in accordion with lesson details
    - Lesson reorder via up/down arrows works with optimistic update
    - Chunk counts visible per course (RAG coverage)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of admin panel</name>
  <what-built>Complete admin panel with 4 pages: Dashboard (KPIs + activity), Users (table + toggles), Analytics (charts), Content (courses + reorder)</what-built>
  <how-to-verify>
    1. Set your test user as admin: In Supabase SQL Editor run `UPDATE "UserProfile" SET "isAdmin" = true WHERE id = '62b06f05-1d65-47b6-8f7c-9f535449a9d9';`
    2. Start dev server: `pnpm dev`
    3. Login and visit http://localhost:3000/admin
    4. Verify Dashboard: KPI cards with numbers, recent events, mini chart
    5. Click "Users" in sidebar → verify table with search, toggles work
    6. Click "Analytics" → verify charts render, period selector works
    7. Click "Content" → verify courses expand, lessons visible, reorder arrows work
    8. Try visiting /admin in incognito (not logged in) → should redirect to /login
    9. Try visiting /admin as non-admin user → should redirect to /dashboard
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes — all admin pages compile
2. Dashboard shows live KPIs from database (not mock data)
3. Users table with search, pagination, inline toggle switches
4. Analytics charts render with period selector (7d/14d/30d/90d)
5. Content management: courses accordion with lesson reordering
6. All admin procedures protected by adminProcedure (FORBIDDEN for non-admins)
7. Non-admin users cannot access /admin routes
</verification>

<success_criteria>
- Admin dashboard displays platform statistics (users, diagnostics, lessons, recent activity)
- Admin can search users and toggle isAdmin/isActive inline
- Analytics shows time-series charts with configurable period
- Content management shows courses with lesson ordering capability
- All pages use mp-color design system and existing component patterns
- All data is real (from Prisma/Supabase, not mock)
</success_criteria>

<output>
After completion, create `.planning/phases/10-superuser-admin-panel/10-02-SUMMARY.md`
</output>
