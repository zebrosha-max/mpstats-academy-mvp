---
phase: 10-superuser-admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/prisma/schema.prisma
  - packages/api/src/trpc.ts
  - packages/api/src/routers/admin.ts
  - packages/api/src/root.ts
  - apps/web/src/app/(admin)/layout.tsx
  - apps/web/src/components/admin/AdminSidebar.tsx
  - apps/web/src/middleware.ts
autonomous: true
requirements:
  - ADMIN-06
  - ADMIN-07

must_haves:
  truths:
    - "User with isAdmin=true can access /admin pages"
    - "User without isAdmin gets redirected away from /admin"
    - "adminProcedure throws FORBIDDEN for non-admin users"
    - "Admin layout renders with its own sidebar navigation"
  artifacts:
    - path: "packages/db/prisma/schema.prisma"
      provides: "isAdmin field on UserProfile"
      contains: "isAdmin"
    - path: "packages/api/src/trpc.ts"
      provides: "adminProcedure with isAdmin check"
      contains: "adminProcedure"
    - path: "packages/api/src/routers/admin.ts"
      provides: "Admin tRPC router with dashboard/users/content procedures"
      exports: ["adminRouter"]
    - path: "apps/web/src/app/(admin)/layout.tsx"
      provides: "Admin layout with isAdmin guard"
      contains: "isAdmin"
    - path: "apps/web/src/components/admin/AdminSidebar.tsx"
      provides: "Admin sidebar navigation component"
      exports: ["AdminSidebar"]
  key_links:
    - from: "apps/web/src/app/(admin)/layout.tsx"
      to: "packages/db/prisma/schema.prisma"
      via: "Prisma query for UserProfile.isAdmin"
      pattern: "userProfile.*isAdmin"
    - from: "packages/api/src/trpc.ts"
      to: "packages/db/prisma/schema.prisma"
      via: "adminProcedure checks isAdmin from DB"
      pattern: "adminProcedure"
    - from: "packages/api/src/root.ts"
      to: "packages/api/src/routers/admin.ts"
      via: "admin router added to appRouter"
      pattern: "admin.*adminRouter"
---

<objective>
Build the admin panel infrastructure: Prisma schema migration (isAdmin field), adminProcedure for tRPC, (admin) route group with layout guard, and admin sidebar navigation.

Purpose: Foundation layer that all admin pages depend on — authentication, authorization, routing, and layout.
Output: Working /admin route group that only isAdmin=true users can access, with adminProcedure for backend protection and a sidebar for navigation.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/prisma/schema.prisma
@packages/api/src/trpc.ts
@packages/api/src/root.ts
@apps/web/src/app/(main)/layout.tsx
@apps/web/src/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isAdmin to Prisma schema + create adminProcedure + admin tRPC router</name>
  <files>
    packages/db/prisma/schema.prisma
    packages/api/src/trpc.ts
    packages/api/src/routers/admin.ts
    packages/api/src/root.ts
  </files>
  <action>
1. **Prisma schema** (`packages/db/prisma/schema.prisma`):
   - Add `isAdmin Boolean @default(false)` field to `UserProfile` model (after `avatarUrl`, before `createdAt`)
   - Run `pnpm db:push` to apply migration (no data loss — adds nullable column with default)
   - Run `pnpm db:generate` to regenerate Prisma client

2. **adminProcedure** (`packages/api/src/trpc.ts`):
   - Add `adminProcedure` after existing `protectedProcedure`
   - Pattern: extend `protectedProcedure` with additional middleware that queries `UserProfile.isAdmin` via `ctx.prisma`
   - If user not found or `isAdmin !== true`, throw `TRPCError({ code: 'FORBIDDEN', message: 'Admin access required' })`
   - Export `adminProcedure`

3. **Admin router** (`packages/api/src/routers/admin.ts`):
   - Create new router file with initial procedures (all using `adminProcedure`):
     - `getDashboardStats` — returns: totalUsers (count UserProfile), totalDiagnostics (count DiagnosticSession where COMPLETED), totalLessons (count Lesson), recentRegistrations (last 7 days count)
     - `getUsers` — input: `{ search?: string, page?: number, limit?: number }`, returns paginated UserProfile list with totalCount. Search by name or email (email from Supabase auth not available in Prisma — search by name only, email can be added later). Include `_count` of diagnosticSessions.
     - `toggleUserField` — input: `{ userId: string, field: 'isAdmin' | 'isActive' }`, toggles the boolean field. Note: `isActive` field doesn't exist yet in schema — for now only support `isAdmin` toggle. Add TODO comment for isActive.
     - `getCourses` — returns all courses with `_count` of lessons and content chunks count per course (via raw query or nested count)
     - `updateLessonOrder` — input: `{ lessonId: string, newOrder: number }`, updates lesson order field
   - Use Zod for all input validation
   - Follow existing router patterns (try/catch with handleDatabaseError)

4. **Root router** (`packages/api/src/root.ts`):
   - Import `adminRouter` from `./routers/admin`
   - Add `admin: adminRouter` to appRouter

Note on `isActive`: The CONTEXT.md mentions toggling `is_active`, but UserProfile doesn't have this field. Add `isActive Boolean @default(true)` to schema alongside `isAdmin`. This enables the user management toggle without a future migration.
  </action>
  <verify>
    <automated>cd D:/GpT_docs/MPSTATS\ ACADEMY\ ADAPTIVE\ LEARNING/MAAL && pnpm db:generate && pnpm typecheck</automated>
    <manual>Verify schema has isAdmin and isActive fields, adminProcedure exists in trpc.ts, admin router has 5 procedures</manual>
  </verify>
  <done>
    - UserProfile has isAdmin and isActive boolean fields with defaults
    - adminProcedure exists and checks isAdmin from DB
    - Admin router has getDashboardStats, getUsers, toggleUserField, getCourses, updateLessonOrder procedures
    - Root router includes admin router
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create (admin) route group with layout guard + admin sidebar + middleware protection</name>
  <files>
    apps/web/src/app/(admin)/layout.tsx
    apps/web/src/app/(admin)/admin/page.tsx
    apps/web/src/components/admin/AdminSidebar.tsx
    apps/web/src/middleware.ts
  </files>
  <action>
1. **Middleware** (`apps/web/src/middleware.ts`):
   - Add `/admin` to `protectedRoutes` array so unauthenticated users get redirected to login

2. **AdminSidebar** (`apps/web/src/components/admin/AdminSidebar.tsx`):
   - Client component (`'use client'`)
   - Fixed left sidebar (same pattern as main Sidebar: `fixed top-0 left-0 h-full w-64 hidden md:flex`)
   - Navigation items: Dashboard (`/admin`), Users (`/admin/users`), Content (`/admin/content`), Analytics (`/admin/analytics`)
   - Use icons from lucide-react (LayoutDashboard, Users, BookOpen, BarChart3)
   - Active state based on `usePathname()` — highlight current route with mp-blue
   - "Back to app" link at bottom → `/dashboard`
   - MPSTATS logo at top with "Admin" badge

3. **Admin layout** (`apps/web/src/app/(admin)/layout.tsx`):
   - Server component (same pattern as `(main)/layout.tsx`)
   - Get user from Supabase `createClient()`
   - If no user → redirect to `/login`
   - Query UserProfile via Prisma to check `isAdmin`
   - If not admin → redirect to `/dashboard` (per CONTEXT.md: redirect approach, not 403)
   - Render: AdminSidebar + main content area with `md:ml-64` offset
   - Header: minimal, with "Admin Panel" title and user avatar

4. **Admin dashboard placeholder** (`apps/web/src/app/(admin)/admin/page.tsx`):
   - Simple placeholder page that says "Admin Dashboard" — will be replaced in Plan 02
   - This file exists so the route `/admin` works and layout guard can be tested

Note on route structure: Next.js App Router route groups use `(admin)` for layout isolation. The actual URL path `/admin` is defined by the `admin/` folder inside `(admin)/`. So the file structure is `app/(admin)/admin/page.tsx` → URL `/admin`.
  </action>
  <verify>
    <automated>cd D:/GpT_docs/MPSTATS\ ACADEMY\ ADAPTIVE\ LEARNING/MAAL && pnpm typecheck</automated>
    <manual>
      1. Start dev server (pnpm dev)
      2. Visit /admin without login → should redirect to /login
      3. Login as non-admin user → visit /admin → should redirect to /dashboard
      4. Set isAdmin=true for test user via Supabase SQL: UPDATE "UserProfile" SET "isAdmin" = true WHERE id = '62b06f05-1d65-47b6-8f7c-9f535449a9d9'
      5. Visit /admin → should see admin layout with sidebar and placeholder content
    </manual>
  </verify>
  <done>
    - /admin requires authentication (middleware redirects to /login)
    - /admin requires isAdmin=true (layout redirects non-admins to /dashboard)
    - Admin layout renders with its own sidebar (Dashboard, Users, Content, Analytics links)
    - AdminSidebar shows active state for current route
    - Placeholder admin dashboard page is accessible at /admin
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes — all new files compile
2. `pnpm db:generate` succeeds — Prisma client includes isAdmin/isActive
3. Admin layout guard works: non-admin users redirected to /dashboard
4. AdminSidebar renders with navigation links
5. Admin tRPC router accessible only through adminProcedure
</verification>

<success_criteria>
- isAdmin and isActive fields exist in UserProfile schema
- adminProcedure rejects non-admin users with FORBIDDEN
- /admin route group has working layout guard with redirect
- Admin sidebar provides navigation between admin pages
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-superuser-admin-panel/10-01-SUMMARY.md`
</output>
