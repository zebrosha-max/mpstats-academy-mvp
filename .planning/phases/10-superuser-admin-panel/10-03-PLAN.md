---
phase: 10-superuser-admin-panel
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - packages/api/src/routers/admin.ts
  - apps/web/src/components/admin/CourseManager.tsx
autonomous: true
requirements:
  - ADMIN-05

must_haves:
  truths:
    - "Admin can change course display order by clicking the order number and typing a new position"
    - "Admin can inline-edit a course title by clicking it, typing a new name, and pressing Enter"
    - "Admin can inline-edit a lesson title by clicking it, typing a new name, and pressing Enter"
    - "Pressing Escape cancels all inline edits without saving"
  artifacts:
    - path: "packages/api/src/routers/admin.ts"
      provides: "moveCourseToPosition, updateCourseTitle, updateLessonTitle mutations"
      contains: "moveCourseToPosition"
    - path: "apps/web/src/components/admin/CourseManager.tsx"
      provides: "Inline editing for course order, course title, and lesson title"
      contains: "editingCourseTitle"
  key_links:
    - from: "apps/web/src/components/admin/CourseManager.tsx"
      to: "packages/api/src/routers/admin.ts"
      via: "trpc.admin.moveCourseToPosition.useMutation()"
      pattern: "trpc\\.admin\\.moveCourseToPosition"
    - from: "apps/web/src/components/admin/CourseManager.tsx"
      to: "packages/api/src/routers/admin.ts"
      via: "trpc.admin.updateCourseTitle.useMutation()"
      pattern: "trpc\\.admin\\.updateCourseTitle"
    - from: "apps/web/src/components/admin/CourseManager.tsx"
      to: "packages/api/src/routers/admin.ts"
      via: "trpc.admin.updateLessonTitle.useMutation()"
      pattern: "trpc\\.admin\\.updateLessonTitle"
---

<objective>
Add course reorder, course title editing, and lesson title editing to the admin Content management page.

Purpose: Extend admin content management so admins can fully control course/lesson ordering and naming without SQL access.
Output: 3 new mutations in admin router + inline editing UI in CourseManager component.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-superuser-admin-panel/10-02-SUMMARY.md
@packages/api/src/routers/admin.ts
@apps/web/src/components/admin/CourseManager.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 3 new admin mutations (moveCourseToPosition, updateCourseTitle, updateLessonTitle)</name>
  <files>packages/api/src/routers/admin.ts</files>
  <action>
Add 3 new mutations to the existing `adminRouter` in `packages/api/src/routers/admin.ts`:

1. **`moveCourseToPosition`** — Identical shift algorithm to `moveLessonToPosition`, but for Course model:
   - Input: `{ courseId: string, targetPosition: z.number().int().min(1) }`
   - Fetch course, get oldPos = course.order, newPos = targetPosition
   - Get all courses ordered by `order asc`
   - Clamp target to valid range (1..courses.length)
   - If oldPos < clampedNew: shift courses in (oldPos, clampedNew] up by decrement 1
   - If oldPos > clampedNew: shift courses in [clampedNew, oldPos) down by increment 1
   - Update the moved course to clampedNew
   - Return updated course
   - Wrap in try/catch with `handleDatabaseError(error)`

2. **`updateCourseTitle`** — Simple title update:
   - Input: `{ courseId: z.string(), title: z.string().min(1).max(200) }`
   - `ctx.prisma.course.update({ where: { id: courseId }, data: { title } })`
   - Return updated course
   - Wrap in try/catch with `handleDatabaseError(error)`

3. **`updateLessonTitle`** — Simple title update:
   - Input: `{ lessonId: z.string(), title: z.string().min(1).max(300) }`
   - `ctx.prisma.lesson.update({ where: { id: lessonId }, data: { title } })`
   - Return updated lesson
   - Wrap in try/catch with `handleDatabaseError(error)`

Place these after the existing `moveLessonToPosition` and before `updateLessonOrder`. Follow the exact same code style as existing procedures (JSDoc comment, adminProcedure, Zod input, try/catch).
  </action>
  <verify>
    <automated>cd "D:/GpT_docs/MPSTATS ACADEMY ADAPTIVE LEARNING/MAAL" && pnpm typecheck</automated>
    <manual>Verify admin.ts has moveCourseToPosition, updateCourseTitle, updateLessonTitle procedures</manual>
  </verify>
  <done>
    - moveCourseToPosition mutation exists with shift algorithm matching moveLessonToPosition
    - updateCourseTitle mutation exists accepting courseId + title
    - updateLessonTitle mutation exists accepting lessonId + title
    - All 3 use adminProcedure and Zod validation
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add inline editing UI for course order, course titles, and lesson titles in CourseManager</name>
  <files>apps/web/src/components/admin/CourseManager.tsx</files>
  <action>
Modify `CourseManager.tsx` to add 3 inline editing capabilities. Follow the EXACT same click-to-edit pattern already used for lesson order numbers.

**1. Course order editing (in CourseAccordion header):**
- Replace the static `#{course.order}` span with a click-to-edit pattern
- Add state: `editingCourseOrder` (boolean), `courseOrderValue` (string)
- Click on order number → show input (type=number, min=1), same styling as lesson order input
- Enter → call `trpc.admin.moveCourseToPosition.useMutation()`, then invalidate `admin.getCourses`
- Escape → cancel
- onBlur → submit
- The mutation hook should be added in `CourseManager` (parent), not `CourseAccordion`, since it needs to invalidate the courses query. Pass a callback `onMoveCourse(courseId, targetPosition)` as prop to CourseAccordion.

**2. Course title editing (in CourseAccordion header):**
- Replace the static title span with a click-to-edit pattern
- Add state: `editingCourseTitle` (boolean), `courseTitleValue` (string)
- Click on title → show text input with current title, full width
- Enter → call `trpc.admin.updateCourseTitle.useMutation()`, invalidate `admin.getCourses`
- Escape → cancel, restore original title
- onBlur → submit
- Input styling: same font as display (`text-body-md font-semibold`), with a border-bottom or subtle box to indicate edit mode
- IMPORTANT: Prevent the accordion toggle from firing when clicking the title for editing. Use `e.stopPropagation()` on the title click handler.
- Pass `onUpdateCourseTitle(courseId, title)` callback from parent.

**3. Lesson title editing (in lesson list):**
- Replace the static lesson title `<p>` with a click-to-edit pattern
- Add state to CourseAccordion: `editingLessonTitleId` (string | null), `lessonTitleValue` (string)
- Click on lesson title → show text input with current title
- Enter → call `trpc.admin.updateLessonTitle.useMutation()`, invalidate `admin.getCourseLessons`
- Escape → cancel
- onBlur → submit
- Input styling: same as lesson title display but with subtle border

**Mutation setup in CourseManager (parent component):**
- Add `trpc.admin.moveCourseToPosition.useMutation()` with onSuccess → `utils.admin.getCourses.invalidate()`
- Add `trpc.admin.updateCourseTitle.useMutation()` with onSuccess → `utils.admin.getCourses.invalidate()`
- Pass callbacks down to CourseAccordion

**Mutation setup in CourseAccordion:**
- Add `trpc.admin.updateLessonTitle.useMutation()` with onSuccess → `utils.admin.getCourseLessons.invalidate({ courseId })`
- This stays in CourseAccordion (same level as existing lesson mutations)

**UX details:**
- All inputs auto-focus when editing starts
- All inputs select their text on focus for easy replacement
- Inputs have a subtle visual indicator (blue border like existing lesson order input)
- Disable the accordion toggle button's onClick propagation when editing course header fields
  </action>
  <verify>
    <automated>cd "D:/GpT_docs/MPSTATS ACADEMY ADAPTIVE LEARNING/MAAL" && pnpm typecheck</automated>
    <manual>
      1. Start dev server (pnpm dev), visit /admin/content as admin
      2. Click course order number → input appears, type new number, press Enter → course moves
      3. Click course title → input appears, type new name, press Enter → title updates
      4. Expand a course, click lesson title → input appears, type new name, press Enter → title updates
      5. Press Escape in any edit → cancels without saving
      6. Clicking title to edit does NOT toggle the accordion open/closed
    </manual>
  </verify>
  <done>
    - Course order is editable via click-to-edit (same pattern as lesson order)
    - Course title is editable inline (click → input → Enter to save, Escape to cancel)
    - Lesson title is editable inline (click → input → Enter to save, Escape to cancel)
    - All edits call the correct tRPC mutations and invalidate relevant queries
    - Accordion toggle is not triggered when clicking editable fields in header
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes — all modified files compile
2. Course reorder works: clicking course order number, entering new position, pressing Enter moves course
3. Course title edit works: clicking title, typing new name, pressing Enter saves
4. Lesson title edit works: clicking title, typing new name, pressing Enter saves
5. Escape cancels all edits without API calls
6. Accordion behavior unaffected — expanding/collapsing still works correctly
</verification>

<success_criteria>
- 3 new mutations exist in admin router (moveCourseToPosition, updateCourseTitle, updateLessonTitle)
- CourseManager supports inline editing for course order, course title, and lesson title
- All edits persist to database via tRPC mutations
- Edit UX is consistent (click to edit, Enter to save, Escape to cancel)
- No regressions in existing content management functionality
</success_criteria>

<output>
After completion, create `.planning/phases/10-superuser-admin-panel/10-03-SUMMARY.md`
</output>
