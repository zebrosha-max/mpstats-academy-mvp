---
phase: 03-video-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/kinescope-upload.ts
  - scripts/kinescope-mapping.ts
  - docs/KINESCOPE_SETUP.md
autonomous: false
requirements: [VIDEO-02]

must_haves:
  truths:
    - "Bulk upload script reads videos from local directory and uploads to Kinescope API"
    - "Upload script maps uploaded videoIds back to lesson records in Supabase"
    - "User has step-by-step guide to set up Kinescope account and get API key"
    - "Script handles upload failures gracefully (retry, skip, resume)"
  artifacts:
    - path: "scripts/kinescope-upload.ts"
      provides: "Bulk upload + DB update script"
      contains: "upload.new.video"
    - path: "scripts/kinescope-mapping.ts"
      provides: "Directory inspection + filename-to-lessonId mapping"
      contains: "Academy Courses"
    - path: "docs/KINESCOPE_SETUP.md"
      provides: "Step-by-step Kinescope setup guide"
      contains: "API key"
  key_links:
    - from: "scripts/kinescope-upload.ts"
      to: "Kinescope API"
      via: "POST https://upload.new.video with Bearer token"
      pattern: "upload.new.video"
    - from: "scripts/kinescope-upload.ts"
      to: "packages/db/prisma/schema.prisma"
      via: "prisma.lesson.update({ videoId })"
      pattern: "prisma.*lesson.*update"
---

<objective>
Create bulk video upload infrastructure for Kinescope: directory mapping script, upload script, and setup guide.

Purpose: ~80+ videos sit in `E:\Academy Courses` and need to be uploaded to Kinescope with automatic videoId mapping to Lesson records. The user needs a clear guide to set up Kinescope (first time) and scripts to automate the upload.

Output: Two scripts (mapping + upload) and a setup guide document.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-video-integration/03-RESEARCH.md
@packages/db/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory mapping script and Kinescope setup guide</name>
  <files>
    scripts/kinescope-mapping.ts
    docs/KINESCOPE_SETUP.md
  </files>
  <action>
1. Create `scripts/kinescope-mapping.ts` — inspects `E:\Academy Courses` and creates a mapping file:
   - Recursively scan the directory for video files (mp4, mkv, avi, mov, webm)
   - For each file, extract a candidate lesson_id from filename/path
   - Query Supabase `Lesson` table to match filenames against existing lesson IDs
   - Output a JSON mapping file `scripts/kinescope-video-map.json`:
     ```json
     {
       "matched": [
         { "filePath": "E:\\Academy Courses\\01_analytics\\...", "lessonId": "01_analytics_m01_start_001", "title": "..." }
       ],
       "unmatched": [
         { "filePath": "E:\\Academy Courses\\unknown_file.mp4", "reason": "No matching lesson_id" }
       ],
       "stats": { "total": 85, "matched": 80, "unmatched": 5 }
     }
     ```
   - Use PrismaClient from @mpstats/db
   - Run with: `npx tsx scripts/kinescope-mapping.ts`
   - Print summary to console: total files, matched, unmatched
   - IMPORTANT: Do NOT assume file naming convention — inspect first, then adapt parsing logic. Log raw filenames for manual review if needed.

2. Create `docs/KINESCOPE_SETUP.md` — step-by-step guide for first-time Kinescope setup:
   - Step 1: Register at kinescope.io (create account)
   - Step 2: Create a new project (e.g., "MPSTATS Academy")
   - Step 3: Navigate to Settings -> API -> Generate API key
   - Step 4: Copy API key and project_id
   - Step 5: Add to `.env`:
     ```
     KINESCOPE_API_KEY=your_api_key
     KINESCOPE_PROJECT_ID=your_project_id
     ```
   - Step 6: Run mapping script first: `npx tsx scripts/kinescope-mapping.ts`
   - Step 7: Review mapping output, fix any unmatched files manually in the JSON
   - Step 8: Run upload script: `npx tsx scripts/kinescope-upload.ts`
   - Include pricing note: check plan limits before uploading ~80 videos
   - Include troubleshooting section: common errors (auth, file size, timeout)
   - Written in Russian (matching project language)
  </action>
  <verify>
    - `scripts/kinescope-mapping.ts` exists and can be parsed by TypeScript (`npx tsx --check scripts/kinescope-mapping.ts` or similar)
    - `docs/KINESCOPE_SETUP.md` exists with all 8 steps
    - If `E:\Academy Courses` is accessible, run the mapping script and verify JSON output
  </verify>
  <done>
    Mapping script inspects E:\Academy Courses, matches files to Lesson records, outputs kinescope-video-map.json. Setup guide covers full Kinescope onboarding from registration to upload.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bulk upload script with retry and DB update</name>
  <files>
    scripts/kinescope-upload.ts
  </files>
  <action>
1. Create `scripts/kinescope-upload.ts`:
   - Reads `scripts/kinescope-video-map.json` (output from mapping script)
   - Only processes entries from `matched` array
   - For each matched entry:
     a. Check if lesson already has videoId in DB (skip if already uploaded)
     b. Upload video file to Kinescope API: POST `https://upload.new.video` with Bearer token
     c. Use `form-data` package for multipart upload (install as dev dep: `pnpm add -D form-data`)
     d. Set title from lesson title (from DB)
     e. Set project_id from env `KINESCOPE_PROJECT_ID`
     f. Parse response to get Kinescope video ID
     g. Update Lesson record in Supabase: `prisma.lesson.update({ where: { id: lessonId }, data: { videoId } })`

2. Error handling and resilience:
   - Retry failed uploads up to 3 times with exponential backoff (2s, 4s, 8s)
   - On persistent failure, log error and continue to next file (don't stop entire batch)
   - Track progress in a state file `scripts/kinescope-upload-progress.json`:
     ```json
     { "uploaded": ["lesson_id_1", "lesson_id_2"], "failed": [{ "lessonId": "...", "error": "..." }] }
     ```
   - On re-run, skip already-uploaded lessons (resume capability)
   - Set generous timeout for large files (5 minutes per upload)

3. Console output:
   - Progress bar or counter: `[15/80] Uploading: 01_analytics_m01_start_001.mp4...`
   - Summary at end: uploaded N, skipped M (already had videoId), failed K

4. Environment variables required:
   - `KINESCOPE_API_KEY` — Bearer token for API auth
   - `KINESCOPE_PROJECT_ID` — project to upload into
   - `DATABASE_URL` — for Prisma (already in .env)

5. Run with: `npx tsx scripts/kinescope-upload.ts`
   - Optional flags: `--dry-run` (validate mapping without uploading), `--limit N` (upload only first N for testing)

NOTE: Kinescope API exact response format has MEDIUM confidence (from research). The script MUST log the full API response for the first upload so user can verify the videoId field name. Add a comment: "// TODO: verify response.id is the correct videoId field after first upload test"
  </action>
  <verify>
    - `scripts/kinescope-upload.ts` exists and can be parsed by TypeScript
    - `--dry-run` flag works (prints what would be uploaded without actually calling API)
    - Progress file `kinescope-upload-progress.json` is created/updated during run
    - Script skips lessons that already have videoId in DB
  </verify>
  <done>
    Bulk upload script reads mapping JSON, uploads videos to Kinescope API with retry logic, updates Lesson.videoId in Supabase, tracks progress for resume capability. Supports --dry-run and --limit flags.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify mapping and upload scripts</name>
  <files>scripts/kinescope-video-map.json</files>
  <action>
    Human verifies the mapping output and upload script behavior:
    1. Review `docs/KINESCOPE_SETUP.md` — does the guide make sense for Kinescope setup?
    2. Run `npx tsx scripts/kinescope-mapping.ts` — verify the mapping output matches file structure
    3. Check `scripts/kinescope-video-map.json` — are files correctly matched to lesson IDs?
    4. If Kinescope is set up: run `npx tsx scripts/kinescope-upload.ts --dry-run --limit 1` to verify the flow
    5. Note: actual upload requires Kinescope API key (see setup guide)
  </action>
  <verify>User confirms mapping is correct and scripts are ready for use</verify>
  <done>User approved mapping output and upload script behavior</done>
</task>

</tasks>

<verification>
1. `scripts/kinescope-mapping.ts` scans E:\Academy Courses and outputs JSON mapping
2. `scripts/kinescope-upload.ts` reads mapping, uploads to Kinescope, updates Lesson.videoId
3. Upload script has retry (3x), resume (progress file), and skip (existing videoId) logic
4. `docs/KINESCOPE_SETUP.md` has complete guide from registration to upload
5. Both scripts run via `npx tsx`
</verification>

<success_criteria>
- Mapping script produces accurate file-to-lesson mapping from E:\Academy Courses
- Upload script handles batch upload with retry, resume, and progress tracking
- Lesson.videoId updated in Supabase after successful upload
- Step-by-step Kinescope setup guide exists for first-time setup
- Scripts handle errors gracefully (no crash on single file failure)
</success_criteria>

<output>
After completion, create `.planning/phases/03-video-integration/03-02-SUMMARY.md`
</output>
