---
phase: 03-video-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/video/KinescopePlayer.tsx
  - apps/web/src/components/video/TimecodeLink.tsx
  - apps/web/src/components/video/VideoPlaceholder.tsx
  - apps/web/src/app/(main)/learn/[id]/page.tsx
  - apps/web/package.json
autonomous: true
requirements: [VIDEO-01, VIDEO-03, VIDEO-04]

must_haves:
  truths:
    - "Lesson page renders Kinescope React player when videoId exists"
    - "Clicking a timecode in RAG summary or chat seeks the video to that moment"
    - "Lesson page shows informative placeholder when videoId is null"
    - "AI panels (summary/chat) work regardless of videoId presence"
    - "Timecodes without video appear as disabled badges (not hidden)"
    - "Player does not autoplay"
  artifacts:
    - path: "apps/web/src/components/video/KinescopePlayer.tsx"
      provides: "Kinescope React player wrapper with ref-based seekTo"
      contains: "dynamic.*import.*kinescope"
    - path: "apps/web/src/components/video/TimecodeLink.tsx"
      provides: "Clickable timecode badge triggering onSeek callback"
      contains: "onSeek"
    - path: "apps/web/src/components/video/VideoPlaceholder.tsx"
      provides: "Placeholder UI when videoId is null"
      contains: "Видео"
    - path: "apps/web/src/app/(main)/learn/[id]/page.tsx"
      provides: "Updated lesson page wiring player + timecodes"
      contains: "playerRef"
  key_links:
    - from: "apps/web/src/components/video/TimecodeLink.tsx"
      to: "apps/web/src/components/video/KinescopePlayer.tsx"
      via: "onSeek callback -> playerRef.current.seekTo(seconds)"
      pattern: "seekTo"
    - from: "apps/web/src/app/(main)/learn/[id]/page.tsx"
      to: "apps/web/src/components/video/KinescopePlayer.tsx"
      via: "useRef<PlayerHandle> passed to VideoPlayer"
      pattern: "playerRef"
    - from: "apps/web/src/app/(main)/learn/[id]/page.tsx"
      to: "apps/web/src/components/video/TimecodeLink.tsx"
      via: "source.timecode_start passed to TimecodeLink.startSeconds"
      pattern: "timecode_start"
---

<objective>
Integrate Kinescope React player into lesson pages with programmatic timecode seek from RAG citations.

Purpose: Replace the current raw iframe with a controllable React player that supports seekTo() via ref. Make timecodes in RAG summary and chat clickable to jump video to that moment. Show a clean placeholder when no video is available.

Output: Three video components (player, timecode link, placeholder) and an updated lesson page wiring them together.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-video-integration/03-RESEARCH.md
@apps/web/src/app/(main)/learn/[id]/page.tsx
@packages/ai/src/generation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create video components (KinescopePlayer, TimecodeLink, VideoPlaceholder)</name>
  <files>
    apps/web/src/components/video/KinescopePlayer.tsx
    apps/web/src/components/video/TimecodeLink.tsx
    apps/web/src/components/video/VideoPlaceholder.tsx
    apps/web/package.json
  </files>
  <action>
1. Install `@kinescope/react-kinescope-player` in apps/web: `pnpm add @kinescope/react-kinescope-player`

2. Create `KinescopePlayer.tsx`:
   - Use `'use client'` directive
   - Use `next/dynamic(() => import('@kinescope/react-kinescope-player'), { ssr: false })` — CRITICAL: direct import causes SSR crash (window not defined)
   - Export `PlayerHandle` interface with `seekTo(seconds: number): void`
   - Use `forwardRef` + `useImperativeHandle` to expose `seekTo` and `play` via ref
   - Track player readiness via `onReady` callback — queue seek commands if player not ready yet (pitfall from research)
   - Props: `videoId: string | null`, optional className
   - If `videoId` is null, render `<VideoPlaceholder />` instead
   - Set `autoPlay={false}` per locked user decision
   - Wrap in `aspect-video` container, width 100%

3. Create `TimecodeLink.tsx`:
   - Props: `startSeconds: number`, `formattedTime: string`, `onSeek: (seconds: number) => void`, `disabled?: boolean`
   - Render as a `<button>` with play icon (small SVG triangle) + formatted time text
   - When disabled (no video): `text-mp-gray-400 bg-mp-gray-100 cursor-not-allowed`
   - When enabled: `text-mp-blue-600 bg-mp-blue-50 hover:bg-mp-blue-100 cursor-pointer`
   - Size: `text-xs px-1.5 py-0.5 rounded inline-flex items-center gap-1`
   - On click: call `onSeek(startSeconds)` if not disabled

4. Create `VideoPlaceholder.tsx`:
   - Full aspect-video container with `bg-mp-gray-900` background
   - Centered content: film/video icon (SVG), text "Видео готовится к публикации", subtle subtext "AI-панель работает на основе транскрипта урока"
   - Use mp-gray-400/500 colors for text, mp-gray-600 for icon
   - Keep consistent with existing design language (rounded-xl, etc.)
  </action>
  <verify>
    - `pnpm --filter web build` compiles without errors (SSR safety confirmed by dynamic import)
    - All three component files exist and export their types
    - No direct import of `@kinescope/react-kinescope-player` outside dynamic() call
  </verify>
  <done>
    Three video components created: KinescopePlayer with ref-based seekTo + onReady queue, TimecodeLink with enabled/disabled states, VideoPlaceholder with informative message. Package installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire video components into lesson page with timecode seek</name>
  <files>
    apps/web/src/app/(main)/learn/[id]/page.tsx
  </files>
  <action>
1. Update the `ChatMessage` interface to include `timecode_start` and `timecode_end` in sources:
   ```typescript
   sources?: Array<{
     id: string;
     timecodeFormatted: string;
     content: string;
     timecode_start: number;  // ADD
     timecode_end: number;    // ADD
   }>;
   ```

2. Replace the iframe/placeholder block (lines 219-238) with the KinescopePlayer component:
   - Add `useRef<PlayerHandle>(null)` for playerRef
   - Import `VideoPlayer` and `PlayerHandle` from `@/components/video/KinescopePlayer`
   - Wrap in same Card with `overflow-hidden shadow-mp-card`, add `id="video-player"` for scroll target
   - Pass `videoId={lesson.videoId}` and `ref={playerRef}`

3. Create `handleTimecodeClick` function:
   ```typescript
   const handleTimecodeClick = (seconds: number) => {
     playerRef.current?.seekTo(seconds);
     // Scroll to player on mobile (player may be above fold)
     document.getElementById('video-player')?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
   };
   ```

4. Replace static timecodes in SUMMARY sources (around lines 396-399):
   - Import `TimecodeLink` from `@/components/video/TimecodeLink`
   - Replace `<span className="text-mp-gray-500">{source.timecodeFormatted}</span>` with:
     ```tsx
     <TimecodeLink
       startSeconds={source.timecode_start}
       formattedTime={source.timecodeFormatted}
       onSeek={handleTimecodeClick}
       disabled={!lesson.videoId}
     />
     ```
   - Note: summary sources come from tRPC `ai.getLessonSummary` which returns full SourceCitation objects (including timecode_start)

5. Replace static timecodes in CHAT sources (around lines 462-467):
   - Replace the static `<span>` badges with `<TimecodeLink>` components
   - Same props pattern: `startSeconds={src.timecode_start}`, `disabled={!lesson.videoId}`
   - The `chatMutation.onSuccess` handler already spreads `result.sources` which includes timecode_start

6. Ensure AI panels remain fully functional when videoId is null — only the timecodes become disabled (grayed out), all other AI functionality unchanged per locked decision.
  </action>
  <verify>
    - `pnpm --filter web build` succeeds
    - Open lesson page in dev mode: if no videoId, placeholder shows with "Видео готовится к публикации" and timecodes are grayed out but visible
    - If videoId present (can test by temporarily hardcoding a known Kinescope videoId), player renders and timecode click triggers seek
    - AI summary and chat tabs work independently of video presence
  </verify>
  <done>
    Lesson page uses KinescopePlayer component (not raw iframe). Timecodes in both summary and chat sources are clickable TimecodeLink badges that trigger seekTo on the player. When videoId is null, placeholder shows and timecodes appear disabled. AI panels fully functional in both states.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` — full build succeeds (SSR safe)
2. Lesson page with videoId=null: shows VideoPlaceholder, timecodes grayed out, AI summary/chat work
3. Lesson page with videoId set: Kinescope player renders, no autoplay, timecode click seeks video
4. No direct import of kinescope player outside dynamic() wrapper
</verification>

<success_criteria>
- Kinescope React player renders on lesson page when videoId exists
- Clickable timecodes in RAG summary and chat trigger video seek
- Informative placeholder when videoId is null
- AI panels work regardless of video availability
- No SSR errors (dynamic import with ssr: false)
- No autoplay
</success_criteria>

<output>
After completion, create `.planning/phases/03-video-integration/03-01-SUMMARY.md`
</output>
