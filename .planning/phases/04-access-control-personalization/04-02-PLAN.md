---
phase: 04-access-control-personalization
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - apps/web/src/app/(main)/learn/page.tsx
  - apps/web/src/components/learning/LessonCard.tsx
autonomous: true
requirements:
  - ACCESS-02
  - ACCESS-04

must_haves:
  truths:
    - "User with completed diagnostic sees 'Мой трек' tab as default on /learn page"
    - "User without diagnostic sees 'Все курсы' tab as default on /learn page"
    - "'Мой трек' empty state shows CTA banner to /diagnostic for users without diagnostic"
    - "Progress bar in 'Мой трек' header shows X/Y completed lessons"
    - "Recommended lessons show green 'Рекомендовано для вас' badge on LessonCard"
    - "User who completed all track lessons sees congratulatory message with CTA to re-diagnose"
  artifacts:
    - path: "apps/web/src/app/(main)/learn/page.tsx"
      provides: "My Track tab with default mode, progress bar, empty/completion states"
      contains: "getRecommendedPath"
    - path: "apps/web/src/components/learning/LessonCard.tsx"
      provides: "isRecommended badge on lesson cards"
      contains: "isRecommended"
  key_links:
    - from: "apps/web/src/app/(main)/learn/page.tsx"
      to: "trpc.diagnostic.hasCompletedDiagnostic"
      via: "tRPC useQuery for default tab selection"
      pattern: "hasCompletedDiagnostic"
    - from: "apps/web/src/app/(main)/learn/page.tsx"
      to: "trpc.learning.getRecommendedPath"
      via: "tRPC useQuery enabled when hasDiagnostic"
      pattern: "getRecommendedPath"
---

<objective>
Add "Мой трек" personalized tab on /learn page and "Рекомендовано для вас" badge on lesson cards.

Purpose: Users with completed diagnostic see their personalized learning track by default, with a progress bar ("5/18 уроков завершено") and recommended badges. Users without diagnostic see "Все курсы" with a clear CTA to start diagnostic. This makes the learning experience personalized and motivating.

Output: Updated /learn page with smart tab switching and progress tracking, updated LessonCard with recommendation badge.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-access-control-personalization/04-CONTEXT.md
@.planning/phases/04-access-control-personalization/04-RESEARCH.md
@.planning/phases/04-access-control-personalization/04-01-SUMMARY.md
@apps/web/src/app/(main)/learn/page.tsx
@apps/web/src/components/learning/LessonCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isRecommended badge to LessonCard</name>
  <files>
    apps/web/src/components/learning/LessonCard.tsx
  </files>
  <action>
**Modify `apps/web/src/components/learning/LessonCard.tsx`:**

1. Add `isRecommended` optional prop to the `LessonCardProps` interface:
```typescript
interface LessonCardProps {
  lesson: LessonWithProgress;
  showCourse?: boolean;
  courseName?: string;
  isRecommended?: boolean;
}
```

2. Update the component signature to destructure `isRecommended`:
```typescript
export function LessonCard({ lesson, showCourse, courseName, isRecommended }: LessonCardProps) {
```

3. Add the recommendation badge in the Meta section (`<div className="flex items-center gap-3 mt-3">`), AFTER the existing category badge span and BEFORE the duration span:
```tsx
{isRecommended && (
  <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-caption font-medium bg-mp-green-100 text-mp-green-700">
    <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
    </svg>
    Рекомендовано
  </span>
)}
```

Badge uses green color (mp-green) with checkmark icon per research recommendations. Text shortened to "Рекомендовано" to fit in the meta row alongside category badge and duration.
  </action>
  <verify>
    <automated>cd "D:/GpT_docs/MPSTATS ACADEMY ADAPTIVE LEARNING/MAAL" && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -10</automated>
    <manual>Verify LessonCard renders green badge when isRecommended=true, and no badge when false/undefined</manual>
  </verify>
  <done>
    - LessonCard accepts optional isRecommended prop
    - Green badge with checkmark icon renders when isRecommended is true
    - Existing behavior unchanged when isRecommended is undefined or false
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Мой трек" tab with smart defaults and progress on /learn page</name>
  <files>
    apps/web/src/app/(main)/learn/page.tsx
  </files>
  <action>
**Modify `apps/web/src/app/(main)/learn/page.tsx`:**

1. Add `useEffect` to imports from React (it's not currently imported):
```typescript
import { useState, useEffect } from 'react';
```

2. Add new tRPC queries inside the LearnPage component, after existing queries:
```typescript
const { data: hasDiagnostic, isLoading: diagLoading } = trpc.diagnostic.hasCompletedDiagnostic.useQuery();
const { data: recommendedPath } = trpc.learning.getRecommendedPath.useQuery(
  undefined,
  { enabled: hasDiagnostic === true }
);
```

3. Replace the viewMode state initialization and add initialization effect:
```typescript
const [viewMode, setViewMode] = useState<'path' | 'courses'>('courses');
const [viewModeInitialized, setViewModeInitialized] = useState(false);

useEffect(() => {
  if (!diagLoading && !viewModeInitialized) {
    setViewMode(hasDiagnostic ? 'path' : 'courses');
    setViewModeInitialized(true);
  }
}, [hasDiagnostic, diagLoading, viewModeInitialized]);
```

4. Create a Set of recommended lesson IDs for O(1) lookup (after the queries):
```typescript
const recommendedLessonIds = new Set(
  recommendedPath?.lessons.map((l) => l.id) ?? []
);
```

5. Update the loading state to include diagLoading:
```typescript
const isLoading = coursesLoading || pathLoading || (diagLoading && !viewModeInitialized);
```

6. Find the existing view mode toggle buttons in the page (the two buttons for "Мой план"/"Все курсы"). Update the "Мой план" button text to "Мой трек" per CONTEXT.md decision. The toggle should look like:
```tsx
<div className="flex gap-2">
  <Button
    variant={viewMode === 'path' ? 'default' : 'outline'}
    size="sm"
    onClick={() => setViewMode('path')}
  >
    Мой трек
  </Button>
  <Button
    variant={viewMode === 'courses' ? 'default' : 'outline'}
    size="sm"
    onClick={() => setViewMode('courses')}
  >
    Все курсы
  </Button>
</div>
```

7. Add progress bar for "Мой трек" view. Place it right after the view mode toggle, inside the same header area:
```tsx
{viewMode === 'path' && recommendedPath && recommendedPath.totalLessons > 0 && (
  <div className="mt-4">
    <div className="flex justify-between text-body-sm text-mp-gray-600 mb-2">
      <span>Прогресс трека</span>
      <span className="font-medium">{recommendedPath.completedLessons}/{recommendedPath.totalLessons} уроков завершено</span>
    </div>
    <div className="h-2 bg-mp-gray-200 rounded-full overflow-hidden">
      <div
        className="h-full bg-mp-green-500 rounded-full transition-all duration-500"
        style={{ width: `${Math.round((recommendedPath.completedLessons / recommendedPath.totalLessons) * 100)}%` }}
      />
    </div>
  </div>
)}
```

8. Modify the "Мой трек" view content section. When `viewMode === 'path'`:

**Case A — No diagnostic completed (`hasDiagnostic === false`):**
Show empty state banner:
```tsx
<Card className="shadow-mp-card border-mp-blue-200 bg-gradient-to-br from-mp-blue-50 to-white">
  <CardContent className="py-12 text-center">
    <div className="w-16 h-16 rounded-2xl bg-mp-blue-100 flex items-center justify-center mx-auto mb-4">
      <svg className="w-8 h-8 text-mp-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
      </svg>
    </div>
    <h2 className="text-heading text-mp-gray-900 mb-2">Персональный трек обучения</h2>
    <p className="text-body text-mp-gray-500 mb-6 max-w-md mx-auto">
      Пройди диагностику, чтобы получить персональный трек обучения на основе твоих навыков
    </p>
    <Link href="/diagnostic">
      <Button size="lg">Начать диагностику</Button>
    </Link>
  </CardContent>
</Card>
```

**Case B — All track lessons completed (`recommendedPath && recommendedPath.completedLessons === recommendedPath.totalLessons && recommendedPath.totalLessons > 0`):**
Show congratulatory message:
```tsx
<Card className="shadow-mp-card border-mp-green-200 bg-gradient-to-br from-mp-green-50 to-white">
  <CardContent className="py-12 text-center">
    <div className="w-16 h-16 rounded-2xl bg-mp-green-100 flex items-center justify-center mx-auto mb-4">
      <svg className="w-8 h-8 text-mp-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <h2 className="text-heading text-mp-gray-900 mb-2">Отличная работа!</h2>
    <p className="text-body text-mp-gray-500 mb-6 max-w-md mx-auto">
      Ты завершил все рекомендованные уроки. Пройди диагностику снова, чтобы проверить прогресс!
    </p>
    <Link href="/diagnostic">
      <Button size="lg">Проверь свой прогресс</Button>
    </Link>
  </CardContent>
</Card>
```

**Case C — Normal track with lessons:**
Render the recommended lessons using LessonCard with `isRecommended={true}` and `showCourse={true}` with `courseName` from the lesson data:
```tsx
<div className="space-y-3">
  {recommendedPath.lessons.map((lesson) => (
    <LessonCard
      key={lesson.id}
      lesson={lesson}
      showCourse
      courseName={lesson.courseName}
      isRecommended
    />
  ))}
</div>
```

Note: The `lesson` objects from `getRecommendedPath` have a `courseName` field added in Plan 01. The `LessonWithProgress` type may need a type assertion or the `courseName` can be passed directly since LessonCard accepts it as a separate prop.

9. In the existing "Все курсы" view, pass `isRecommended` to LessonCard instances where the lesson ID is in the recommended set:
```tsx
<LessonCard
  key={lesson.id}
  lesson={lesson}
  isRecommended={recommendedLessonIds.has(lesson.id)}
/>
```

Apply this to ALL LessonCard instances in the courses view (both in the expanded course list and in the filtered lessons list if applicable).

**Flickering prevention:** Do NOT render the view mode toggle until `viewModeInitialized` is true. Show a skeleton for the header area while `diagLoading && !viewModeInitialized`:
```tsx
{!viewModeInitialized ? (
  <div className="h-10 bg-mp-gray-200 rounded-lg w-48 animate-pulse" />
) : (
  <div className="flex gap-2">...</div>
)}
```
  </action>
  <verify>
    <automated>cd "D:/GpT_docs/MPSTATS ACADEMY ADAPTIVE LEARNING/MAAL" && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -20</automated>
    <manual>
      1. Visit /learn as user WITHOUT diagnostic — default "Все курсы" view, no badges
      2. Switch to "Мой трек" tab — see empty state CTA banner
      3. Visit /learn as user WITH diagnostic — default "Мой трек" view with progress bar
      4. Lessons in track show green "Рекомендовано" badge
      5. Switch to "Все курсы" — recommended lessons still show badge
      6. No flicker when page loads (skeleton until mode resolved)
    </manual>
  </verify>
  <done>
    - /learn defaults to "Мой трек" when diagnostic completed, "Все курсы" otherwise
    - "Мой трек" shows progress bar "X/Y уроков завершено"
    - Empty state shows CTA to /diagnostic with motivating text
    - Track completion shows congratulatory message with re-diagnose CTA
    - Recommended lessons marked with green badge in both views
    - No viewMode flicker on initial load
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. /learn defaults to correct tab based on diagnostic status
3. "Мой трек" progress bar updates correctly
4. Empty state and completion state render appropriately
5. LessonCard shows green badge for recommended lessons
6. No flicker or flash of wrong view mode on page load
</verification>

<success_criteria>
- Default view mode matches diagnostic status (no flicker)
- Progress bar shows accurate count from getRecommendedPath data
- Recommended badge appears on correct lesson cards in both views
- Empty state and completion state have correct CTA links
</success_criteria>

<output>
After completion, create `.planning/phases/04-access-control-personalization/04-02-SUMMARY.md`
</output>
