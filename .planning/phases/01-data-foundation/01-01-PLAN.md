---
phase: 01-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/seed/seed-from-manifest.ts
  - scripts/seed/seed-skill-categories.ts
  - packages/api/src/utils/ensure-user-profile.ts
  - packages/api/src/utils/db-errors.ts
autonomous: true

must_haves:
  truths:
    - "Running seed-from-manifest.ts populates 6 courses and 405 lessons in Supabase"
    - "Running seed-skill-categories.ts assigns per-lesson SkillCategory via AI classification"
    - "Seed scripts are idempotent — safe to re-run without duplicates"
    - "ensureUserProfile creates UserProfile on first call, no-ops on subsequent calls"
    - "DB error helper distinguishes Supabase 521 (paused) from generic errors"
  artifacts:
    - path: "scripts/seed/seed-from-manifest.ts"
      provides: "Idempotent Course/Lesson seeding from manifest.json"
      contains: "prisma.course.upsert"
    - path: "scripts/seed/seed-skill-categories.ts"
      provides: "AI-based lesson SkillCategory classification"
      contains: "openrouter"
    - path: "packages/api/src/utils/ensure-user-profile.ts"
      provides: "UserProfile auto-creation middleware"
      contains: "prisma.userProfile.upsert"
    - path: "packages/api/src/utils/db-errors.ts"
      provides: "Typed DB error handling with Supabase 521 detection"
      contains: "DATABASE_UNAVAILABLE"
  key_links:
    - from: "scripts/seed/seed-skill-categories.ts"
      to: "content_chunk table"
      via: "Supabase query for lesson content"
      pattern: "content_chunk"
    - from: "packages/api/src/utils/ensure-user-profile.ts"
      to: "packages/db/prisma/schema.prisma"
      via: "UserProfile upsert"
      pattern: "userProfile\\.upsert"
---

<objective>
Create foundational seed scripts and shared utilities that all subsequent router migrations depend on.

Purpose: Course/Lesson data must exist in Supabase before routers can query it. ensureUserProfile and error handling utilities are shared by all three routers being migrated in Plans 02-04.

Output:
- Updated seed-from-manifest.ts (idempotent, course-level SkillCategory default)
- New seed-skill-categories.ts (AI classification at lesson level)
- ensureUserProfile utility
- DB error handling utility (Supabase 521 detection)
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation/01-RESEARCH.md

@packages/db/prisma/schema.prisma
@packages/api/src/trpc.ts
@scripts/seed/seed-from-manifest.ts
@packages/ai/src/openrouter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update seed-from-manifest.ts and create shared utilities</name>
  <files>
    scripts/seed/seed-from-manifest.ts
    packages/api/src/utils/ensure-user-profile.ts
    packages/api/src/utils/db-errors.ts
  </files>
  <action>
**1. Update `scripts/seed/seed-from-manifest.ts`:**

The existing script already works but needs minor improvements:
- Add `--dry-run` flag support (parse `process.argv` for `--dry-run`, if set only log what would be done)
- Ensure course-level `skillCategory` is used as DEFAULT for all lessons (this already works, but verify the `SKILL_CATEGORY_MAP` covers all 6 courses from manifest). The manifest has `skill_category` values for each course. Courses without a matching enum value should default to the closest match:
  - `01_analytics` -> ANALYTICS
  - `02_ads` -> MARKETING
  - `03_ai` -> CONTENT (AI tools for content creation)
  - `04_workshops` -> OPERATIONS (workshop/operational skills)
  - `05_ozon` -> MARKETING (Ozon marketplace marketing)
  - `06_express` -> OPERATIONS (logistics/express delivery)
- Add summary output: total courses, total lessons, lessons per course, total duration
- Keep idempotent upsert logic (already exists)

**2. Create `packages/api/src/utils/ensure-user-profile.ts`:**

```typescript
import type { PrismaClient } from '@prisma/client';
import type { User } from '@supabase/supabase-js';

export async function ensureUserProfile(prisma: PrismaClient, user: User) {
  return prisma.userProfile.upsert({
    where: { id: user.id },
    update: { updatedAt: new Date() },
    create: {
      id: user.id,
      name: user.user_metadata?.full_name || user.email?.split('@')[0] || null,
      avatarUrl: user.user_metadata?.avatar_url || null,
    },
  });
}
```

This function:
- Creates UserProfile if it doesn't exist (new Google OAuth users)
- Touches `updatedAt` if it does exist
- Extracts name and avatar from Supabase user_metadata (Google OAuth provides these)
- Is idempotent — safe to call multiple times

**3. Create `packages/api/src/utils/db-errors.ts`:**

```typescript
import { TRPCError } from '@trpc/server';
import { Prisma } from '@prisma/client';

export function handleDatabaseError(error: unknown): never {
  // Supabase free tier paused (521)
  if (
    error instanceof Prisma.PrismaClientInitializationError ||
    (error instanceof Error && error.message.includes('521'))
  ) {
    throw new TRPCError({
      code: 'INTERNAL_SERVER_ERROR',
      message: 'DATABASE_UNAVAILABLE',
      cause: error,
    });
  }

  // Connection refused / timeout
  if (error instanceof Prisma.PrismaClientKnownRequestError) {
    throw new TRPCError({
      code: 'INTERNAL_SERVER_ERROR',
      message: `DATABASE_ERROR: ${error.code}`,
      cause: error,
    });
  }

  // Unknown error
  throw new TRPCError({
    code: 'INTERNAL_SERVER_ERROR',
    message: 'Unexpected database error',
    cause: error,
  });
}

export function isDatabaseUnavailable(errorMessage: string): boolean {
  return errorMessage === 'DATABASE_UNAVAILABLE';
}

export function isSupabasePaused(error: unknown): boolean {
  return error instanceof Error && (
    error.message.includes('521') ||
    error.message.includes('Web server is down')
  );
}
```

Do NOT add mock fallback in error handling — per user decision, show errors, not mock data.
  </action>
  <verify>
- `npx tsx scripts/seed/seed-from-manifest.ts --dry-run` runs without errors and shows summary
- Files `packages/api/src/utils/ensure-user-profile.ts` and `packages/api/src/utils/db-errors.ts` exist
- TypeScript compiles: `cd packages/api && npx tsc --noEmit` (or project-level `pnpm typecheck`)
  </verify>
  <done>
- seed-from-manifest.ts has correct SkillCategory mapping for all 6 courses
- ensureUserProfile utility handles Google OAuth metadata
- db-errors utility distinguishes Supabase 521 from generic DB errors
- No mock fallback in error handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AI-classification seed script for lesson-level SkillCategory</name>
  <files>
    scripts/seed/seed-skill-categories.ts
  </files>
  <action>
Create `scripts/seed/seed-skill-categories.ts` — a script that reclassifies lessons using AI analysis of their content_chunk data.

**How it works:**
1. Query all unique `lesson_id` values from `content_chunk` table (via Prisma raw query or Supabase client)
2. For each lesson with content_chunks, concatenate first 3-5 chunks as representative content (~500-1000 tokens)
3. Batch 10-15 lessons per LLM call to OpenRouter (use `google/gemini-2.5-flash` — already configured in `packages/ai/src/openrouter.ts`)
4. Prompt LLM to classify each lesson into ONE of: ANALYTICS, MARKETING, CONTENT, OPERATIONS, FINANCE
5. Update `Lesson.skillCategory` via Prisma upsert for each classified lesson
6. Lessons WITHOUT content_chunks keep their course-level default (from seed-from-manifest.ts)

**LLM Prompt template:**
```
Classify each lesson into exactly ONE category based on its content.
Categories: ANALYTICS, MARKETING, CONTENT, OPERATIONS, FINANCE

ANALYTICS: Data analysis, metrics, KPIs, tracking, reports, ABC-analysis
MARKETING: Advertising, promotion, SEO, PPC, marketplace ads, Ozon/WB promotion
CONTENT: Product cards, photos, descriptions, A+ content, infographics
OPERATIONS: Logistics, FBO/FBS, supply chain, warehouse, delivery, returns
FINANCE: Unit economics, pricing, margins, profitability, financial planning

Return JSON array: [{"lesson_id": "...", "category": "ANALYTICS"}, ...]

Lessons:
{lessons_json}
```

**Key implementation details:**
- Use OpenRouter client from `packages/ai/src/openrouter.ts` (OpenAI SDK compatible)
- OPENROUTER_API_KEY from `.env` (already exists)
- Rate limit: add 1-2 second delay between batches
- `--dry-run` flag: show classifications without writing to DB
- Save classification results to `scripts/seed/classification-results.json` for debugging
- If a lesson has no content_chunks, skip it (keep course-level default)
- If LLM returns invalid category, log warning and keep course-level default
- Parse JSON response with try/catch — if malformed, retry once, then skip batch with warning

**Expected cost:** ~20-40 API calls * ~$0.001 = ~$0.02-0.04 total

**Script arguments:**
- `--dry-run`: Log classifications without updating DB
- `--batch-size N`: Lessons per LLM call (default 10)
- `--skip-cached`: If classification-results.json exists, use cached results instead of calling LLM
  </action>
  <verify>
- `npx tsx scripts/seed/seed-skill-categories.ts --dry-run` runs and outputs classification for lessons with content_chunks
- `scripts/seed/classification-results.json` is created with lesson classifications
- No lesson gets a category not in the enum (ANALYTICS, MARKETING, CONTENT, OPERATIONS, FINANCE)
  </verify>
  <done>
- AI classification script exists and correctly classifies lessons based on content_chunk text
- Script is idempotent (upsert on Lesson.skillCategory)
- Dry-run mode works without modifying DB
- Lessons without content_chunks keep course-level default category
- Classification results cached to JSON for debugging
  </done>
</task>

</tasks>

<verification>
1. `npx tsx scripts/seed/seed-from-manifest.ts --dry-run` completes with summary of 6 courses, 405 lessons
2. `npx tsx scripts/seed/seed-skill-categories.ts --dry-run` classifies lessons with content_chunks
3. `packages/api/src/utils/ensure-user-profile.ts` exports `ensureUserProfile` function
4. `packages/api/src/utils/db-errors.ts` exports `handleDatabaseError`, `isDatabaseUnavailable`, `isSupabasePaused`
5. TypeScript compiles without errors
</verification>

<success_criteria>
- Seed scripts ready to populate Supabase with real course/lesson data
- AI classification assigns per-lesson SkillCategory (not just course-level)
- Shared utilities (ensureUserProfile, db-errors) ready for router migration plans
- All scripts are idempotent — safe to re-run
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-01-SUMMARY.md`
</output>
