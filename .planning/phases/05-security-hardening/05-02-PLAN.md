---
phase: 05-security-hardening
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/web/src/components/shared/SafeMarkdown.tsx
  - apps/web/src/app/(main)/learn/[id]/page.tsx
  - apps/web/src/app/error.tsx
  - apps/web/src/app/global-error.tsx
  - apps/web/src/app/not-found.tsx
  - apps/web/src/app/(main)/error.tsx
autonomous: true
requirements:
  - SEC-03
  - SEC-05

must_haves:
  truths:
    - "AI-генерированный markdown рендерится через react-markdown, а не dangerouslySetInnerHTML"
    - "Ссылки и изображения из AI output не рендерятся (заблокированы санитизацией)"
    - "Ошибка в diagnostic/learning/chat компоненте показывает Error Boundary с кнопками Повторить и На главную"
    - "404 страница показывает кастомный not-found с навигацией"
    - "Таймкоды в sources секции остаются кликабельными (TimecodeLink не затронут)"
  artifacts:
    - path: "apps/web/src/components/shared/SafeMarkdown.tsx"
      provides: "Safe markdown renderer with rehype-sanitize"
      exports: ["SafeMarkdown"]
    - path: "apps/web/src/app/error.tsx"
      provides: "Global error boundary"
      contains: "Что-то пошло не так"
    - path: "apps/web/src/app/(main)/error.tsx"
      provides: "Main section error boundary"
      contains: "reset"
    - path: "apps/web/src/app/global-error.tsx"
      provides: "Root layout error boundary"
      contains: "<html>"
    - path: "apps/web/src/app/not-found.tsx"
      provides: "Custom 404 page"
      contains: "не найдена"
  key_links:
    - from: "apps/web/src/app/(main)/learn/[id]/page.tsx"
      to: "apps/web/src/components/shared/SafeMarkdown.tsx"
      via: "SafeMarkdown component import"
      pattern: "import.*SafeMarkdown"
    - from: "apps/web/src/components/shared/SafeMarkdown.tsx"
      to: "react-markdown"
      via: "ReactMarkdown component"
      pattern: "import ReactMarkdown"
---

<objective>
Заменить dangerouslySetInnerHTML на безопасный react-markdown рендеринг и добавить error boundaries для устойчивости UI.

Purpose: Устранить XSS-вектор через AI-генерированный контент (текущий formatContent + dangerouslySetInnerHTML небезопасен). Error boundaries предотвращают белый экран при ошибках компонентов.
Output: SafeMarkdown компонент, error.tsx на двух уровнях, not-found.tsx, global-error.tsx.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-security-hardening/05-RESEARCH.md
@.planning/phases/05-security-hardening/05-01-SUMMARY.md
@apps/web/src/app/(main)/learn/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: SafeMarkdown component + lesson page migration</name>
  <files>
    apps/web/src/components/shared/SafeMarkdown.tsx
    apps/web/src/app/(main)/learn/[id]/page.tsx
  </files>
  <action>
1. Install dependencies:
   ```bash
   pnpm add react-markdown rehype-sanitize remark-gfm --filter @mpstats/web
   ```

2. Create `apps/web/src/components/shared/SafeMarkdown.tsx`:
   - `'use client'` directive
   - Import `ReactMarkdown` from `react-markdown`, `rehypeSanitize` with `defaultSchema` from `rehype-sanitize`, `remarkGfm` from `remark-gfm`
   - Define `sanitizeSchema` extending `defaultSchema`:
     - `tagNames`: h1-h6, p, br, strong, em, del, ul, ol, li, code, pre, table, thead, tbody, tr, th, td, blockquote, sup
     - NO `a`, `img`, or script tags (per locked decision)
     - `attributes`: keep `code.className` for syntax highlighting
   - Props interface: `{ content: string; className?: string }`
   - Render `<ReactMarkdown>` with `remarkPlugins={[remarkGfm]}`, `rehypePlugins={[[rehypeSanitize, sanitizeSchema]]}`, `allowedElements={sanitizeSchema.tagNames}`
   - Add Tailwind prose-like styling via className: headings (font-bold, text sizes), lists (list-disc/list-decimal), code (bg-mp-gray-100 rounded px-1), blockquotes (border-l-4 pl-4 italic), tables (border, padding)
   - Use `components` prop to style individual elements with Tailwind classes

3. Update `apps/web/src/app/(main)/learn/[id]/page.tsx`:
   - Import `SafeMarkdown` from `@/components/shared/SafeMarkdown`
   - Find ALL usages of `dangerouslySetInnerHTML` (research says lines ~389, ~464 — verify by reading file)
   - Replace each `<div dangerouslySetInnerHTML={{ __html: formatContent(text) }} />` with `<SafeMarkdown content={text} />`
   - Remove the `formatContent` function (no longer needed)
   - Keep the existing `TimecodeLink` component and sources section unchanged — timecodes are rendered separately in the sources list, not inline in markdown

IMPORTANT per RESEARCH Pitfall 1: TimecodeLink components in sources section are NOT affected by this change. They're rendered separately as Badge components. Only the markdown body text switches to SafeMarkdown.

Per RESEARCH Pitfall 5: react-markdown@^9.0.0, rehype-sanitize@^6.0.0, remark-gfm@^4.0.0 must be installed together for compatibility. Next.js 14 handles ESM-only packages fine.
  </action>
  <verify>
    <automated>cd "D:/GpT_docs/MPSTATS ACADEMY ADAPTIVE LEARNING/MAAL" && grep -rn "dangerouslySetInnerHTML" apps/web/src/app/\(main\)/learn/\[id\]/page.tsx; echo "---"; grep -n "SafeMarkdown" apps/web/src/app/\(main\)/learn/\[id\]/page.tsx</automated>
    <manual>No dangerouslySetInnerHTML in lesson page; SafeMarkdown imported and used</manual>
  </verify>
  <done>
    - SafeMarkdown component created with react-markdown + rehype-sanitize + remark-gfm
    - Sanitization blocks links, images, raw HTML (only safe elements allowed)
    - Lesson page uses SafeMarkdown instead of dangerouslySetInnerHTML
    - formatContent function removed from lesson page
    - TimecodeLink in sources section unchanged and working
  </done>
</task>

<task type="auto">
  <name>Task 2: Error boundaries and not-found page</name>
  <files>
    apps/web/src/app/error.tsx
    apps/web/src/app/global-error.tsx
    apps/web/src/app/not-found.tsx
    apps/web/src/app/(main)/error.tsx
  </files>
  <action>
1. Create `apps/web/src/app/error.tsx` (global error boundary):
   - `'use client'` directive
   - Accept `{ error, reset }` props (Next.js App Router convention)
   - `useEffect` to `console.error('[ErrorBoundary]', error)` on error change
   - UI: centered card with mp-colors styling:
     - Icon or emoji indicator
     - Heading: "Что-то пошло не так"
     - Paragraph: "Произошла непредвиденная ошибка. Попробуйте обновить страницу."
     - Two buttons: "Повторить" (calls `reset()`) and "На главную" (Link to `/`)
   - Style with Tailwind: `min-h-screen flex items-center justify-center`, Card component from shadcn/ui, mp-blue button

2. Create `apps/web/src/app/global-error.tsx` (root layout error boundary):
   - `'use client'` directive
   - MUST include `<html>` and `<body>` tags (catches root layout errors)
   - Same UI as error.tsx but self-contained (no imports from layout)
   - Basic Tailwind via inline style or hardcoded classes
   - `console.error('[GlobalError]', error)` in useEffect

3. Create `apps/web/src/app/not-found.tsx` (custom 404):
   - Server component (no 'use client' needed)
   - Import Logo component from `@/components/shared/Logo`
   - UI: centered layout with:
     - Logo at top
     - "404" large number
     - "Страница не найдена"
     - "Запрашиваемая страница не существует или была перемещена."
     - Button: "На главную" (Link to `/dashboard`)
   - Style consistent with app design (mp-colors, rounded cards)

4. Create `apps/web/src/app/(main)/error.tsx` (main section error boundary):
   - `'use client'` directive
   - Same pattern as root error.tsx but scoped to (main) layout
   - Includes sidebar context (user sees sidebar, error in content area)
   - Heading: "Ошибка загрузки"
   - Paragraph: "Не удалось загрузить страницу. Попробуйте ещё раз."
   - Buttons: "Повторить" (reset) + "Дашборд" (Link to `/dashboard`)
   - Logging: `console.error('[MainError]', error)`

Per RESEARCH: Individual component-level ErrorBoundary wrappers are NOT needed — existing try/catch in chat/diagnostic components handle component-level errors. Route-level error.tsx is sufficient for MVP.
  </action>
  <verify>
    <automated>cd "D:/GpT_docs/MPSTATS ACADEMY ADAPTIVE LEARNING/MAAL" && ls -la apps/web/src/app/error.tsx apps/web/src/app/global-error.tsx apps/web/src/app/not-found.tsx "apps/web/src/app/(main)/error.tsx" 2>&1</automated>
    <manual>All 4 error boundary files exist; each has proper 'use client' directive (except not-found); global-error includes html+body tags</manual>
  </verify>
  <done>
    - app/error.tsx catches uncaught errors globally with Повторить + На главную buttons
    - app/global-error.tsx catches root layout errors with self-contained HTML
    - app/not-found.tsx shows branded 404 page with navigation
    - app/(main)/error.tsx catches errors in protected section with sidebar context preserved
    - All error pages log to console.error with prefix tags
  </done>
</task>

</tasks>

<verification>
1. No `dangerouslySetInnerHTML` in lesson page
2. SafeMarkdown component uses react-markdown + rehype-sanitize
3. 4 error boundary files exist (error.tsx, global-error.tsx, not-found.tsx, (main)/error.tsx)
4. TypeScript compilation passes
5. `pnpm build` completes without errors
</verification>

<success_criteria>
- AI output rendered safely through react-markdown AST (no innerHTML)
- Links and images blocked by sanitization schema
- Uncaught errors show user-friendly error pages at both global and section level
- 404 shows branded not-found page
- TimecodeLink functionality preserved in sources section
</success_criteria>

<output>
After completion, create `.planning/phases/05-security-hardening/05-02-SUMMARY.md`
</output>
