---
phase: 05-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/api/src/middleware/rate-limit.ts
  - packages/api/src/trpc.ts
  - packages/api/src/routers/ai.ts
  - packages/ai/src/retrieval.ts
  - packages/ai/src/openrouter.ts
  - .github/workflows/ci.yml
autonomous: true
requirements:
  - SEC-01
  - SEC-02
  - SEC-04

must_haves:
  truths:
    - "Неаутентифицированный запрос к AI endpoints возвращает 401"
    - "AI endpoints ограничены 50 req/hour per user, при превышении — 429 с retryAfterMin"
    - "Chat endpoint ограничен 20 msg/hour per user"
    - "service_role key не присутствует в client-side bundle"
    - "Модули с секретами (retrieval.ts, openrouter.ts) помечены server-only"
  artifacts:
    - path: "packages/api/src/middleware/rate-limit.ts"
      provides: "Sliding window rate limiter middleware"
      exports: ["createRateLimitMiddleware"]
    - path: "packages/api/src/trpc.ts"
      provides: "aiProcedure and chatProcedure with rate limiting"
      contains: "aiProcedure"
    - path: "packages/api/src/routers/ai.ts"
      provides: "Protected AI endpoints"
      contains: "aiProcedure"
  key_links:
    - from: "packages/api/src/routers/ai.ts"
      to: "packages/api/src/trpc.ts"
      via: "aiProcedure and chatProcedure imports"
      pattern: "import.*aiProcedure.*chatProcedure"
    - from: "packages/api/src/trpc.ts"
      to: "packages/api/src/middleware/rate-limit.ts"
      via: "createRateLimitMiddleware import"
      pattern: "import.*createRateLimitMiddleware"
    - from: ".github/workflows/ci.yml"
      to: "apps/web/.next/static/"
      via: "grep for service_role key leak"
      pattern: "SUPABASE_SERVICE_ROLE"
---

<objective>
Защитить все AI/LLM endpoints авторизацией и rate limiting, предотвратить утечку service_role key в клиентский бандл.

Purpose: Неаутентифицированные пользователи не должны иметь доступ к LLM endpoints (экономия денег + безопасность). Rate limiting защищает от злоупотреблений. server-only enforcement гарантирует что секреты не утекут в браузер.
Output: Rate limit middleware, protected AI procedures, server-only guards, CI leak detection.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-security-hardening/05-RESEARCH.md
@packages/api/src/trpc.ts
@packages/api/src/routers/ai.ts
@packages/ai/src/retrieval.ts
@packages/ai/src/openrouter.ts
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rate limit middleware + protected AI procedures</name>
  <files>
    packages/api/src/middleware/rate-limit.ts
    packages/api/src/trpc.ts
    packages/api/src/routers/ai.ts
  </files>
  <action>
1. Create `packages/api/src/middleware/rate-limit.ts`:
   - Implement `createRateLimitMiddleware(maxRequests, windowMs, namespace)` function
   - Use sliding window algorithm: store timestamps[] per `${namespace}:${userId}` key
   - Store the Map in `globalThis.__rateLimitStore` for HMR persistence (same pattern as diagnostic.ts)
   - On limit exceeded: throw `TRPCError({ code: 'TOO_MANY_REQUESTS', message: JSON.stringify({ retryAfterMs, retryAfterMin }) })`
   - Filter expired timestamps on each check (timestamps older than windowMs)
   - Export only `createRateLimitMiddleware`

2. Update `packages/api/src/trpc.ts`:
   - Import `createRateLimitMiddleware` from `./middleware/rate-limit`
   - Create `aiProcedure = protectedProcedure.use(createRateLimitMiddleware(50, 3600000, 'ai'))` — 50/hour
   - Create `chatProcedure = protectedProcedure.use(createRateLimitMiddleware(20, 3600000, 'chat'))` — 20/hour
   - Export both new procedures alongside existing exports

3. Update `packages/api/src/routers/ai.ts`:
   - Import `aiProcedure` and `chatProcedure` from `../trpc` (instead of publicProcedure)
   - Change `getLessonSummary` from `publicProcedure` to `aiProcedure`
   - Change `chat` from `publicProcedure` to `chatProcedure`
   - Change `searchChunks` from `publicProcedure` to `protectedProcedure` (no rate limit, debug endpoint)
   - Remove any TODO comments about switching back to protectedProcedure
   - Keep `clearSummaryCache` as `protectedProcedure` (no rate limit needed for cache clear)

Note: The existing rate limiter in diagnostic.ts (lines 37-53) uses a similar globalThis pattern — this new middleware extracts and generalizes that pattern for reuse.
  </action>
  <verify>
    <automated>cd "D:/GpT_docs/MPSTATS ACADEMY ADAPTIVE LEARNING/MAAL" && npx tsc --noEmit --project packages/api/tsconfig.json 2>&1 | head -30</automated>
    <manual>Verify ai.ts has no publicProcedure references, rate-limit.ts exports createRateLimitMiddleware, trpc.ts exports aiProcedure and chatProcedure</manual>
  </verify>
  <done>
    - All 3 AI endpoints use protectedProcedure (via aiProcedure/chatProcedure/protectedProcedure)
    - No publicProcedure remains in ai.ts
    - Rate limiter creates TRPCError with TOO_MANY_REQUESTS code and retryAfterMin in message
    - aiProcedure: 50 req/hour, chatProcedure: 20 req/hour
  </done>
</task>

<task type="auto">
  <name>Task 2: server-only guards + CI service_role leak detection</name>
  <files>
    packages/ai/src/retrieval.ts
    packages/ai/src/openrouter.ts
    .github/workflows/ci.yml
  </files>
  <action>
1. Install `server-only` package:
   ```bash
   pnpm add server-only --filter @mpstats/web
   ```
   Note: `server-only` must be in the web app's dependencies (not in packages/ai) because it's a Next.js build-time marker that works in the app's bundler context. However, the import goes into packages/ai files — Next.js will trace the import through the monorepo.

   Actually, per Pitfall 3 from RESEARCH.md: add `import 'server-only'` ONLY to files that exclusively use server secrets:
   - `packages/ai/src/retrieval.ts` — uses `SUPABASE_SERVICE_ROLE_KEY`
   - `packages/ai/src/openrouter.ts` — uses `OPENROUTER_API_KEY`
   - Do NOT add to `packages/ai/src/index.ts` barrel export — it would poison all consumers

   If `server-only` can't be resolved from packages/ai, add it as a dependency of @mpstats/ai too:
   ```bash
   pnpm add server-only --filter @mpstats/ai
   ```

2. Add `import 'server-only';` as the FIRST import in:
   - `packages/ai/src/retrieval.ts`
   - `packages/ai/src/openrouter.ts`

3. Update `.github/workflows/ci.yml` — add a step AFTER the build step:
   ```yaml
   - name: Check for service_role key leak
     run: |
       if grep -r "SUPABASE_SERVICE_ROLE" apps/web/.next/static/ 2>/dev/null; then
         echo "::error::service_role key found in client bundle!"
         exit 1
       fi
       echo "✓ No service_role key in client bundle"
   ```
   Place this after the `pnpm build` step so `.next/static/` exists.

IMPORTANT: Do NOT add `import 'server-only'` to `packages/ai/src/embeddings.ts` or `packages/ai/src/generation.ts` unless they directly use secrets. Check imports — if they only import from retrieval.ts/openrouter.ts, the server-only guard propagates automatically through the module graph.
  </action>
  <verify>
    <automated>cd "D:/GpT_docs/MPSTATS ACADEMY ADAPTIVE LEARNING/MAAL" && grep -n "server-only" packages/ai/src/retrieval.ts packages/ai/src/openrouter.ts && grep "service_role" .github/workflows/ci.yml</automated>
    <manual>Verify server-only import is first line in both files; CI workflow has the grep check step</manual>
  </verify>
  <done>
    - `packages/ai/src/retrieval.ts` has `import 'server-only'` as first import
    - `packages/ai/src/openrouter.ts` has `import 'server-only'` as first import
    - CI pipeline checks `.next/static/` for service_role key leaks after build
    - Build fails if service_role key found in client bundle
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for packages/api
2. No `publicProcedure` in `packages/api/src/routers/ai.ts`
3. `server-only` import present in retrieval.ts and openrouter.ts
4. CI workflow contains service_role leak check step
5. Rate limit middleware exports createRateLimitMiddleware with proper types
</verification>

<success_criteria>
- All AI tRPC endpoints require authentication (no publicProcedure)
- Rate limiting configured: 50/hour for AI, 20/hour for chat
- server-only guards on modules with secrets
- CI catches service_role key leaks in client bundle
</success_criteria>

<output>
After completion, create `.planning/phases/05-security-hardening/05-01-SUMMARY.md`
</output>
