---
phase: 07-lesson-course-name-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/cleanup/cleanup-names.ts
  - scripts/seed/seed-from-manifest.ts
  - apps/web/src/app/(main)/learn/page.tsx
autonomous: true
requirements: [NAMING-01, NAMING-02, NAMING-03, NAMING-04]

must_haves:
  truths:
    - "Cleanup script in dry-run mode prints Bylo->Stalo diff for all 405 lessons and 6 courses"
    - "Cleanup script in live mode updates all lesson titles, descriptions, and course names in Supabase"
    - "No lesson title contains .mp4, .mov or other file extensions after cleanup"
    - "No module description contains 'Modul: Modul N_' prefix after cleanup"
    - "Course titles are clean Russian names without numeric prefixes"
    - "Seed script applies cleanTitle() so future re-seeds produce clean names"
    - "Lesson cards in /learn show visual numbering from order field"
  artifacts:
    - path: "scripts/cleanup/cleanup-names.ts"
      provides: "One-time cleanup script with --dry-run flag"
      min_lines: 80
    - path: "scripts/seed/seed-from-manifest.ts"
      provides: "Updated seed with cleanTitle() functions"
      contains: "cleanLessonTitle"
    - path: "apps/web/src/app/(main)/learn/page.tsx"
      provides: "Visual numbering in lesson list"
      contains: "lesson.order"
  key_links:
    - from: "scripts/cleanup/cleanup-names.ts"
      to: "Supabase Lesson/Course tables"
      via: "Prisma client update()"
      pattern: "prisma\\.(lesson|course)\\.update"
    - from: "scripts/seed/seed-from-manifest.ts"
      to: "cleanLessonTitle function"
      via: "function call in upsert data"
      pattern: "cleanLessonTitle\\(lesson\\.title_original\\)"
---

<objective>
Clean all 405 lesson titles, module descriptions, and 6 course names from technical artifacts (.mp4, numbering, underscores) in Supabase database, update seed script to prevent regression, and add visual numbering in UI.

Purpose: Users currently see filenames like "1 SEO-optimizacia.mp4" and "Modul: Modul 6_ Trafik_" instead of clean readable names.
Output: Cleanup script, updated seed script, UI with visual lesson numbers.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-lesson-course-name-cleanup/07-CONTEXT.md
@.planning/phases/07-lesson-course-name-cleanup/07-RESEARCH.md
@scripts/seed/seed-from-manifest.ts
@apps/web/src/app/(main)/learn/page.tsx
@apps/web/src/components/learning/LessonCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cleanup-names.ts script with dry-run mode</name>
  <files>scripts/cleanup/cleanup-names.ts</files>
  <action>
Create `scripts/cleanup/cleanup-names.ts` using Prisma client with `--dry-run` flag (default: dry-run, pass `--apply` to execute).

**Cleanup functions (per user decisions):**

1. `cleanLessonTitle(raw: string): string` — Applied to `Lesson.title`:
   - Remove file extensions: `.mp4`, `.mov`, `.avi`, `.mkv`, `.webm`, `.flv` (case-insensitive, anchored to end `$`)
   - Remove leading numeric prefixes: `1 `, `1. `, `1.2 `, `001_`, `m01_` — regex `^(\d+\.?\d*\.?\s*|m?\d+_)`
   - Replace all `_` with spaces
   - Collapse multiple spaces, trim
   - Capitalize first letter, preserve rest (natural Russian style)
   - Safety: if result is empty or < 2 chars, keep original and print WARNING

2. `cleanModuleDescription(raw: string): string` — Applied to `Lesson.description`:
   - Remove `Модуль: ` prefix
   - Remove duplicate `Модуль N_ ` or `Модуль N ` prefix
   - Replace `_` with spaces (but first `_` after topic word becomes `: ` if it's a section separator — e.g., `Трафик_ привлекаем` -> `Трафик: привлекаем`)
   - Collapse multiple spaces, trim
   - Capitalize first letter

3. `COURSE_NAMES` hardcoded map for 6 courses — Russian titles and descriptions:
   - `01_analytics` -> title: `Аналитика для маркетплейсов`, desc: `Внутренняя и внешняя аналитика, юнит-экономика, конкурентный анализ`
   - `02_ads` -> title: `Реклама и продвижение`, desc: `SEO-оптимизация, рекламные кампании, трафик и конверсии`
   - `03_ai` -> title: `AI-инструменты для селлеров`, desc: `Использование искусственного интеллекта в работе на маркетплейсах`
   - `04_workshops` -> title: `Практические воркшопы`, desc: `Пошаговые разборы и мастер-классы`
   - `05_ozon` -> title: `Работа с Ozon`, desc: `Особенности продаж и продвижения на площадке Ozon`
   - `06_express` -> title: `Экспресс-курсы`, desc: `Быстрые курсы по ключевым темам маркетплейсов`

**Script flow:**
1. Connect to Prisma
2. Fetch all lessons ordered by courseId ASC, order ASC
3. For each lesson: compute clean title and description, print diff if changed
4. Fetch all courses, apply COURSE_NAMES map, print diff
5. Print summary: N lessons changed, M courses changed
6. If `--apply` flag passed: execute all updates in a transaction
7. Disconnect Prisma

**Run:** `npx tsx scripts/cleanup/cleanup-names.ts` (dry-run) or `npx tsx scripts/cleanup/cleanup-names.ts --apply` (live)
  </action>
  <verify>
Run `npx tsx scripts/cleanup/cleanup-names.ts` from project root — should print diff table showing before/after for all dirty titles without modifying DB. Verify no empty titles in output. Then run with `--apply` to execute updates. Verify by querying a few lessons: `npx tsx -e "const {PrismaClient}=require('@prisma/client');const p=new PrismaClient();p.lesson.findFirst().then(l=>{console.log(l.title);p.\$disconnect()})"` — title should be clean.
  </verify>
  <done>All 405 lesson titles cleaned (no .mp4, no numeric prefix, no underscores). All lesson descriptions cleaned (no "Modul: Modul N_" prefix). All 6 courses have Russian titles and descriptions. Script outputs summary with count of changes.</done>
</task>

<task type="auto">
  <name>Task 2: Update seed-from-manifest.ts with cleanTitle functions</name>
  <files>scripts/seed/seed-from-manifest.ts</files>
  <action>
Add the same `cleanLessonTitle()` and `cleanModuleDescription()` functions from cleanup-names.ts to seed-from-manifest.ts (or extract to a shared `scripts/utils/clean-titles.ts` module if DRY is preferred — Claude's discretion).

Also add `COURSE_NAMES` map for course title/description.

Update the upsert calls:
- Line ~159/163: `title: course.title_original` -> `title: COURSE_NAMES[course.id]?.title ?? course.title_original`
- Line ~160: `description: course.title_en` -> `description: COURSE_NAMES[course.id]?.description ?? course.title_en`
- Line ~199: `title: lesson.title_original` -> `title: cleanLessonTitle(lesson.title_original)`
- Line ~191: same for update block
- Line ~200: `description: \`Модуль: ${module.title_original}\`` -> `description: cleanModuleDescription(\`Модуль: ${module.title_original}\`)`

This ensures future re-seeds produce clean data automatically.
  </action>
  <verify>Run `npx tsx scripts/seed/seed-from-manifest.ts --dry-run` — should complete without errors. Verify console output shows clean course names (Russian) instead of `01_analytics` etc.</verify>
  <done>Seed script uses cleanLessonTitle() and cleanModuleDescription() for all title/description inserts. Future re-seeds will produce clean names automatically.</done>
</task>

<task type="auto">
  <name>Task 3: Add visual lesson numbering in learn page</name>
  <files>apps/web/src/app/(main)/learn/page.tsx</files>
  <action>
In `learn/page.tsx`, inside the courses view where `visibleLessons.map()` renders LessonCards (line ~319-326), prepend the lesson order number to the displayed title.

Per user decision: "Номер генерируется из поля `order` при отображении, не хранится в title". Format: `{lesson.order}. {lesson.title}`.

Change line ~320-326 from:
```tsx
<LessonCard
  key={lesson.id}
  lesson={lesson}
  showCourse={false}
  isRecommended={recommendedLessonIds.has(lesson.id)}
/>
```
to:
```tsx
<LessonCard
  key={lesson.id}
  lesson={{ ...lesson, title: `${lesson.order}. ${lesson.title}` }}
  showCourse={false}
  isRecommended={recommendedLessonIds.has(lesson.id)}
/>
```

Also apply the same pattern to the "Мой трек" view (line ~253-260) where recommended lessons are rendered — add numbering there too if lesson.order is available.

Do NOT modify the LessonCard component itself or the lesson detail page (it already shows "Урок N из M" in header).
  </action>
  <verify>Run `pnpm build` — should compile without TypeScript errors. Manually check that `lesson.order` exists on the `LessonWithProgress` type in `@mpstats/shared`.</verify>
  <done>Lesson cards in /learn courses view show visual numbering like "1. SEO-оптимизация" using the order field. Lesson detail page unchanged (already shows "Урок N из M").</done>
</task>

</tasks>

<verification>
1. Run cleanup script dry-run: `npx tsx scripts/cleanup/cleanup-names.ts` — shows diffs, no errors
2. Run cleanup script live: `npx tsx scripts/cleanup/cleanup-names.ts --apply` — updates DB
3. Run seed dry-run: `npx tsx scripts/seed/seed-from-manifest.ts --dry-run` — shows clean names
4. Build succeeds: `pnpm build` — no TypeScript errors
5. Dev server: `pnpm dev` then visit /learn — courses show Russian names, lessons show clean titles with numbering
</verification>

<success_criteria>
- Zero lesson titles contain file extensions (.mp4, .mov, etc.)
- Zero lesson descriptions contain "Модуль: Модуль N_" prefix
- All 6 courses have Russian titles and descriptions
- Seed script produces clean names on re-run
- Lesson cards show visual numbering from order field
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-lesson-course-name-cleanup/07-01-SUMMARY.md`
</output>
