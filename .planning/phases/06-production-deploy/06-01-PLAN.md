---
phase: 06-production-deploy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - docker-compose.yml
  - apps/web/src/app/api/health/route.ts
  - .github/workflows/ci.yml
autonomous: true
requirements:
  - DEPLOY-01
  - DEPLOY-02
  - DEPLOY-03
  - DEPLOY-04
  - DEPLOY-05
  - DEPLOY-06

must_haves:
  truths:
    - "Prisma DB queries work inside Alpine Docker container (no libssl error)"
    - "GET /api/health returns JSON with status and database connectivity"
    - "Docker healthcheck uses /api/health endpoint"
    - "CI workflow triggers on master branch (not only main)"
  artifacts:
    - path: "apps/web/src/app/api/health/route.ts"
      provides: "Health check endpoint"
      exports: ["GET"]
    - path: "Dockerfile"
      provides: "Fixed runner stage with openssl"
      contains: "apk add --no-cache openssl"
    - path: "docker-compose.yml"
      provides: "Updated healthcheck to /api/health"
      contains: "/api/health"
  key_links:
    - from: "Dockerfile (runner stage)"
      to: "Prisma query engine"
      via: "openssl package provides libssl"
      pattern: "apk add.*openssl"
    - from: "docker-compose.yml healthcheck"
      to: "/api/health"
      via: "wget spider check"
      pattern: "api/health"
---

<objective>
Fix Prisma OpenSSL compatibility in Docker, add health check endpoint, update CI to target master branch.

Purpose: The production container currently has blank pages because Prisma can't find libssl on Alpine. This plan fixes the root cause, adds a proper health check, and fixes CI branch targeting.
Output: Working Dockerfile with openssl, /api/health endpoint, updated docker-compose healthcheck, CI on master.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-production-deploy/06-RESEARCH.md
@Dockerfile
@docker-compose.yml
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Dockerfile and health check endpoint</name>
  <files>
    Dockerfile
    apps/web/src/app/api/health/route.ts
    docker-compose.yml
  </files>
  <action>
1. **Dockerfile** — In the runner stage (Stage 5), add `RUN apk add --no-cache openssl` BEFORE the `RUN addgroup` line. This fixes Prisma's inability to find libssl on Alpine, which causes all DB routes to fail silently (blank pages in production). Do NOT add `binaryTargets` to schema.prisma — Prisma auto-detects `linux-musl-openssl-3.0.x` once openssl is installed.

2. **Health check endpoint** — Create `apps/web/src/app/api/health/route.ts`:
   - Export `const dynamic = 'force-dynamic'` (prevent static caching)
   - Export async `GET` handler
   - Return JSON: `{ status: 'ok' | 'degraded', timestamp, uptime, database: 'connected' | 'disconnected' }`
   - Import prisma from `@mpstats/db` (use existing singleton, NOT new PrismaClient)
   - Test DB with `prisma.$queryRaw\`SELECT 1\``
   - On DB success: return 200 with `database: 'connected'`
   - On DB failure: return 503 with `status: 'degraded'`, `database: 'disconnected'`, `error: message`
   - Wrap in try/catch, no `finally $disconnect` (singleton client)

3. **docker-compose.yml** — Update healthcheck test to hit `/api/health` instead of `/`:
   ```
   test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
   ```
   This ensures Docker only marks container as healthy when both app AND database are reachable.
  </action>
  <verify>
    - `Dockerfile` contains `apk add --no-cache openssl` in runner stage (before addgroup)
    - `apps/web/src/app/api/health/route.ts` exists and exports GET
    - `docker-compose.yml` healthcheck references `/api/health`
    - `pnpm typecheck` passes (health route imports resolve)
  </verify>
  <done>
    Dockerfile runner stage includes openssl package. Health check endpoint exists at /api/health. Docker healthcheck points to /api/health.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix CI workflow branch targeting</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
Update `.github/workflows/ci.yml` to trigger on `master` branch instead of (or in addition to) `main`:

1. Change `branches: [main, develop]` to `branches: [master, main, develop]` in BOTH the `push` and `pull_request` triggers
2. This ensures CI runs on pushes to master (the actual primary branch) while keeping backward compatibility if branch is ever renamed

Per research (Pitfall 5): repo uses `master` as primary branch but CI targets `main`. No other changes to CI workflow.
  </action>
  <verify>
    - `grep -c "master" .github/workflows/ci.yml` returns at least 2 (push + pull_request triggers)
  </verify>
  <done>
    CI workflow triggers on master branch pushes and pull requests.
  </done>
</task>

</tasks>

<verification>
1. All modified files pass typecheck: `pnpm typecheck`
2. Dockerfile diff shows only openssl addition in runner stage
3. Health route is a proper Next.js API route with force-dynamic
4. CI workflow includes master in branch triggers
</verification>

<success_criteria>
- Dockerfile has openssl in runner stage (fixes Prisma blank pages)
- /api/health endpoint returns app + DB status
- Docker healthcheck uses /api/health
- CI triggers on master branch
- All changes are local code — no VPS interaction needed
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-deploy/06-01-SUMMARY.md`
</output>
