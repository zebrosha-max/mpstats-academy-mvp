---
phase: 06-production-deploy
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - .github/workflows/cd.yml
autonomous: false
requirements:
  - DEPLOY-04
  - DEPLOY-07

user_setup:
  - service: github-secrets
    why: "CD pipeline needs SSH access to VPS"
    env_vars:
      - name: VPS_HOST
        source: "Value: 89.208.106.208"
      - name: VPS_USER
        source: "Value: deploy"
      - name: VPS_SSH_KEY
        source: "Private SSH key for deploy@89.208.106.208 (cat ~/.ssh/id_ed25519 or generate new)"
    dashboard_config:
      - task: "Add secrets to GitHub repo"
        location: "GitHub -> Settings -> Secrets and variables -> Actions"

must_haves:
  truths:
    - "Push to master triggers automatic deploy to VPS"
    - "After deploy, /api/health returns 200 with database: connected"
    - "Full E2E flow works: landing -> login -> dashboard -> diagnostic -> results -> learn -> lesson -> RAG chat"
    - "All pages show real data (no blank screens)"
  artifacts:
    - path: ".github/workflows/cd.yml"
      provides: "CD pipeline for auto-deploy"
      contains: "appleboy/ssh-action"
  key_links:
    - from: ".github/workflows/cd.yml"
      to: "VPS Docker Compose"
      via: "SSH action runs git pull + docker compose rebuild"
      pattern: "docker compose"
    - from: "Docker container"
      to: "Supabase cloud DB"
      via: "DATABASE_URL in .env.production"
      pattern: "database.*connected"
---

<objective>
Create CD pipeline and verify full E2E flow on production.

Purpose: Automate deploys via GitHub Actions and verify that the Prisma fix + health check make all pages work with real data.
Output: Working CD pipeline, verified production deployment with all pages rendering real data.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-production-deploy/06-RESEARCH.md
@.planning/phases/06-production-deploy/06-01-SUMMARY.md
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CD workflow and deploy</name>
  <files>
    .github/workflows/cd.yml
  </files>
  <action>
1. **Create `.github/workflows/cd.yml`:**
   - Name: "Deploy to Production"
   - Triggers: `push` to `master` + `workflow_dispatch` (manual trigger)
   - Single job `deploy` on `ubuntu-latest`
   - Use `appleboy/ssh-action@v1` with secrets: `VPS_HOST`, `VPS_USER`, `VPS_SSH_KEY`
   - Set `script_stop: true` (fail on first error)
   - SSH script:
     ```
     cd /home/deploy/maal
     git pull origin master
     docker compose down
     docker compose build --no-cache
     docker compose up -d
     echo "Waiting for container health..."
     sleep 45
     wget -q -O- http://127.0.0.1:3000/api/health || echo "WARNING: Health check failed"
     ```

2. **Check GitHub Secrets:** Run `gh secret list` to see if VPS_HOST/VPS_USER/VPS_SSH_KEY already exist. If not, inform user that secrets need to be added (see user_setup).

3. **Verify env vars on VPS:** SSH to VPS and check `.env.production` contains all required vars:
   - `DATABASE_URL`, `DIRECT_URL` (Supabase Postgres)
   - `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY` (build-time)
   - `SUPABASE_SERVICE_ROLE_KEY` (server-side)
   - `OPENROUTER_API_KEY` (AI/RAG)
   - `NEXT_PUBLIC_SITE_URL=https://academyal.duckdns.org`

4. **Deploy current changes:** Push the Plan 01 + Plan 02 changes to master. If CD pipeline is set up and secrets exist, it will auto-deploy. If secrets don't exist yet, manually SSH and run the deploy commands from the CD script.

5. **Verify /api/health after deploy:** `curl https://academyal.duckdns.org/api/health` should return `{"status":"ok","database":"connected",...}`. If database is "disconnected", the Prisma openssl fix didn't work or env vars are wrong — debug.
  </action>
  <verify>
    - `.github/workflows/cd.yml` exists with correct structure
    - `curl https://academyal.duckdns.org/api/health` returns 200 with `database: connected`
    - Docker container is healthy on VPS: `docker compose ps` shows "healthy"
  </verify>
  <done>
    CD workflow created. Production container rebuilt with openssl fix. Health check returns 200 with database connected.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify full E2E flow on production</name>
  <files>none</files>
  <action>
    Human verifies that the full production deployment works end-to-end. All pages should display real data from Supabase, no blank screens.
  </action>
  <verify>
    Open browser and test full E2E flow on https://academyal.duckdns.org:

    1. **Landing:** Visit https://academyal.duckdns.org — see hero, features, CTA
    2. **Health:** Visit https://academyal.duckdns.org/api/health — should show {"status":"ok","database":"connected",...}
    3. **Login:** Click "Start" or go to /login — log in with Google OAuth or test account
    4. **Dashboard:** After login, /dashboard should show stats cards, skill chart, recent activity (not blank)
    5. **Learn:** Go to /learn — should show 6 courses with real lesson counts (not blank)
    6. **Lesson:** Click any lesson — should show Kinescope video + Summary/Chat tabs
    7. **RAG Chat:** In lesson page, try Chat tab — type a question, get answer with citations
    8. **Diagnostic:** Go to /diagnostic — start session, answer questions, see results with radar chart
    9. **Profile:** Go to /profile — should show user info and diagnostic history

    Report which pages work and which don't.
  </verify>
  <done>
    User confirms all pages display real data and full E2E flow works on production.
  </done>
</task>

</tasks>

<verification>
1. CD pipeline file exists at `.github/workflows/cd.yml`
2. Production health check returns 200 with `database: connected`
3. All main pages render with real data (no blank screens)
4. Google OAuth works in production
5. RAG chat returns answers with citations
</verification>

<success_criteria>
- CD pipeline auto-deploys on push to master
- /api/health returns status ok + database connected
- Full E2E flow works: register -> diagnose -> results -> learn -> RAG chat
- No blank pages — all show real Supabase data
- User has verified production works
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-deploy/06-02-SUMMARY.md`
</output>
