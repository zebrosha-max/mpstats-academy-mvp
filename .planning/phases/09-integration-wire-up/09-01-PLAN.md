---
phase: 09-integration-wire-up
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/api/src/routers/profile.ts
autonomous: false
requirements:
  - DATA-05
  - DATA-06
  - DATA-07
  - VIDEO-03

must_haves:
  truths:
    - "Profile getDashboard uses getCompletedSessions helper instead of duplicated inline query"
    - "History page displays real diagnostic sessions from Supabase (not mock)"
    - "Clicking a timecode in AI summary panel seeks video to that moment and plays"
    - "Clicking a timecode in AI chat panel seeks video to that moment and plays"
    - "Dashboard recommended track progress widget is NOT implemented (deferred per CONTEXT.md)"
  artifacts:
    - path: "packages/api/src/routers/profile.ts"
      provides: "getDashboard using getCompletedSessions"
      contains: "getCompletedSessions"
  key_links:
    - from: "packages/api/src/routers/profile.ts"
      to: "packages/api/src/routers/diagnostic.ts"
      via: "import getCompletedSessions"
      pattern: "getCompletedSessions\\(ctx\\.prisma"
    - from: "apps/web/src/components/video/TimecodeLink.tsx"
      to: "apps/web/src/components/video/KinescopePlayer.tsx"
      via: "onSeek -> playerRef.seekTo -> postMessage"
      pattern: "postMessage.*seekTo"
---

<objective>
Close integration gaps from v1.0 milestone audit: (1) refactor profile router to use shared getCompletedSessions helper instead of duplicated Prisma query, (2) verify Kinescope seekTo via postMessage works end-to-end in production.

Purpose: Eliminate code duplication in profile router and confirm timecode seeking works correctly before closing milestone v1.0.
Output: Clean profile router import, verified seekTo functionality.
</objective>

<execution_context>
@C:/Users/Zebrosha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Zebrosha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-wire-up/09-CONTEXT.md
@.planning/phases/09-integration-wire-up/09-RESEARCH.md

@packages/api/src/routers/profile.ts
@packages/api/src/routers/diagnostic.ts
@apps/web/src/components/video/KinescopePlayer.tsx
@apps/web/src/components/video/TimecodeLink.tsx
@apps/web/src/app/(main)/learn/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire-up profile getDashboard to use getCompletedSessions</name>
  <files>packages/api/src/routers/profile.ts</files>
  <action>
    1. In `packages/api/src/routers/profile.ts`, add import at the top:
       `import { getCompletedSessions } from './diagnostic';`

    2. In `getDashboard` procedure (~line 171), replace the inline query:
       ```typescript
       // BEFORE:
       ctx.prisma.diagnosticSession.findMany({
         where: { userId: ctx.user.id, status: 'COMPLETED' },
         orderBy: { completedAt: 'desc' },
         take: 10,
       }),
       // AFTER:
       getCompletedSessions(ctx.prisma, ctx.user.id),
       ```

    3. Note: `getCompletedSessions` does not have a `take: 10` limit. This is acceptable for MVP (users have few sessions). If needed, add `.then(sessions => sessions.slice(0, 10))` after the call for safety, but this is not required — profile getDashboard only uses the count and latest session date, not all 10 items for display.

    4. Verify the variable name `completedDiagnostics` still works with the return type. Both the old query and `getCompletedSessions` return `DiagnosticSession[]`, so no type changes needed.

    5. Do NOT touch the dashboard page or the history page. Dashboard recommended track widget is explicitly DEFERRED per CONTEXT.md.
  </action>
  <verify>
    Run `pnpm typecheck` from project root — no TypeScript errors in profile.ts.
    Run `pnpm build` — successful build.
    Grep profile.ts to confirm: `getCompletedSessions` is called, no direct `diagnosticSession.findMany` with `status: 'COMPLETED'` remains in getDashboard.
  </verify>
  <done>
    profile.ts getDashboard calls getCompletedSessions(ctx.prisma, ctx.user.id) instead of inline query. TypeScript compiles clean. No dashboard widget added (deferred).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify seekTo timecodes work in production</name>
  <files>apps/web/src/components/video/KinescopePlayer.tsx, apps/web/src/components/video/TimecodeLink.tsx</files>
  <action>
    This is a verification-only task. No code changes needed — the TimecodeLink + KinescopePlayer seekTo integration already exists.

    The infrastructure in place:
    - TimecodeLink renders play icon + time in mp-blue (both summary and chat panels)
    - KinescopePlayer uses postMessage to iframe for seekTo + play
    - Ready event listener with pending seek queue handles race conditions

    Human verifies on production that clicking timecodes actually seeks the video.
  </action>
  <verify>
    Human verification steps:
    1. Open https://academyal.duckdns.org in browser
    2. Log in with test account (or your account)
    3. Navigate to /learn, open any lesson that has a video (most do — 405 videos uploaded)
    4. Wait for AI Summary to load in the right panel
    5. Find a timecode badge (e.g., "play 02:15 - 03:30") in the Sources section below the summary
    6. Click the timecode badge — video should seek to that time and start playing
    7. Switch to the Chat tab, ask a question about the lesson content
    8. In the AI response sources, find a timecode badge and click it
    9. Confirm video seeks to the correct moment and plays

    Expected behavior:
    - Timecodes look like: play icon + "MM:SS - MM:SS" in blue, clickable
    - Click seeks video to start time and auto-plays
    - If video is still loading, seek queues and executes when ready

    If seekTo does NOT work (video doesn't move on click):
    - Report the exact lesson URL and timecode clicked
    - Check browser console for errors related to postMessage
    - This would mean the Kinescope postMessage format needs investigation
  </verify>
  <done>
    seekTo verified working in production: clicking timecodes in both AI summary and AI chat panels seeks the Kinescope video to the correct moment and auto-plays. VIDEO-03 audit gap closed.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors
2. `pnpm build` completes successfully
3. profile.ts imports and uses getCompletedSessions from diagnostic.ts
4. No direct `diagnosticSession.findMany` with `status: 'COMPLETED'` in profile.ts getDashboard
5. seekTo verified by human on production (checkpoint)
6. Dashboard page NOT modified (deferred widget confirmed absent)
</verification>

<success_criteria>
- Profile router getDashboard uses shared getCompletedSessions helper (no duplicated query)
- Timecode seekTo via postMessage verified working in production (both summary and chat panels)
- No regressions in build or TypeScript compilation
- Dashboard recommended track widget NOT added (confirmed deferred)
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-wire-up/09-01-SUMMARY.md`
</output>
