# Kinescope: Пошаговая настройка

Руководство по настройке Kinescope для MPSTATS Academy.
Результат: ~400 видео загружены, videoId привязаны к урокам в базе данных.

## Содержание

1. [Регистрация](#шаг-1-регистрация)
2. [Создание проекта](#шаг-2-создание-проекта)
3. [Получение API ключа](#шаг-3-получение-api-ключа)
4. [Настройка окружения](#шаг-4-настройка-окружения)
5. [Проверка маппинга](#шаг-5-проверка-маппинга-видео)
6. [Запуск маппинга](#шаг-6-запуск-маппинг-скрипта)
7. [Ревью маппинга](#шаг-7-ревью-результатов-маппинга)
8. [Загрузка видео](#шаг-8-загрузка-видео)

---

## Шаг 1: Регистрация

1. Перейдите на [kinescope.io](https://kinescope.io)
2. Нажмите "Попробовать бесплатно" или "Регистрация"
3. Укажите email и создайте пароль
4. Подтвердите email через ссылку в письме

> **Важно:** Перед массовой загрузкой проверьте лимиты тарифного плана.
> ~400 видео могут потребовать платный тариф. Рекомендуется загрузить 1-2 видео для теста.

## Шаг 2: Создание проекта

1. Войдите в [dashboard.kinescope.io](https://dashboard.kinescope.io)
2. Нажмите "Создать проект" (или "New Project")
3. Введите название: **MPSTATS Academy**
4. Настройки по умолчанию подойдут для начала
5. Запомните **project_id** — он отображается в URL дашборда:
   ```
   https://dashboard.kinescope.io/projects/YOUR_PROJECT_ID/videos
   ```

## Шаг 3: Получение API ключа

1. В дашборде перейдите в **Settings** (иконка шестеренки)
2. Откройте раздел **API**
3. Нажмите **"Generate API Key"** (или "Создать API ключ")
4. Скопируйте ключ — он показывается только один раз
5. Сохраните ключ в надежном месте

> **Безопасность:** API ключ дает полный доступ к аккаунту. Не коммитьте его в git.

## Шаг 4: Настройка окружения

Добавьте ключ и project_id в файл `.env` в корне проекта:

```env
# Kinescope
KINESCOPE_API_KEY=your_api_key_here
KINESCOPE_PROJECT_ID=your_project_id_here
```

Проверьте что `.env` в `.gitignore` (уже должен быть).

## Шаг 5: Проверка маппинга видео

Видео хранятся в `E:\Academy Courses\` со следующей структурой:

```
E:\Academy Courses\
├── manifest.json           # Метаданные всех видео
├── 01_analytics\
│   ├── m01_start\
│   │   ├── 001_kak_proyti_kurs.mp4
│   │   └── 002_dlya_chego_nuzhna_analitika.mp4
│   └── m02_economics\
│       └── ...
├── 02_ads\
├── 03_ai\
├── 04_workshops\
├── 05_ozon\
└── 06_express\
```

Маппинг-скрипт использует `manifest.json` для связки файлов с lesson_id в базе данных.

## Шаг 6: Запуск маппинг-скрипта

```bash
# Создание маппинга (не трогает базу данных)
npx tsx scripts/kinescope-mapping.ts

# Или с проверкой какие уроки уже имеют videoId
npx tsx scripts/kinescope-mapping.ts --check-db

# Только посмотреть структуру (без БД)
npx tsx scripts/kinescope-mapping.ts --dry-run
```

Результат записывается в `scripts/kinescope-video-map.json`.

## Шаг 7: Ревью результатов маппинга

Откройте `scripts/kinescope-video-map.json` и проверьте:

1. **`stats`** — общая статистика:
   - `matched` — сколько файлов привязаны к урокам
   - `unmatched` — сколько файлов не найдены в БД
   - `filesExist` — сколько файлов реально существуют на диске

2. **`matched`** — для каждого файла:
   - `filePath` — путь к видео
   - `lessonId` — ID урока в БД
   - `fileExists` — файл найден на диске
   - `fileSizeMB` — размер файла

3. **`unmatched`** — файлы без привязки:
   - Проверьте причину (`reason`)
   - При необходимости исправьте маппинг вручную

## Шаг 8: Загрузка видео

### Тестовая загрузка (рекомендуется начать с неё)

```bash
# Только показать что будет загружено (без реальной загрузки)
npx tsx scripts/kinescope-upload.ts --dry-run

# Загрузить только 1 видео для теста
npx tsx scripts/kinescope-upload.ts --limit 1
```

### Массовая загрузка

```bash
# Загрузить все видео
npx tsx scripts/kinescope-upload.ts
```

Скрипт:
- Пропускает уроки, у которых уже есть `videoId` в БД
- Повторяет загрузку при ошибке (до 3 раз)
- Сохраняет прогресс в `scripts/kinescope-upload-progress.json`
- При повторном запуске продолжает с того места, где остановился

---

## Устранение ошибок

### 401 Unauthorized
- API ключ неверный или не установлен
- Проверьте `KINESCOPE_API_KEY` в `.env`
- Проверьте что ключ не просрочен в дашборде

### 413 Payload Too Large
- Файл слишком большой для текущего тарифного плана
- Проверьте лимит размера файла в настройках Kinescope
- Рассмотрите сжатие видео перед загрузкой

### Timeout при загрузке
- Большие файлы (>1 ГБ) могут загружаться долго
- Скрипт использует таймаут 5 минут на файл
- При нестабильном интернете используйте `--limit N` для порционной загрузки

### ENOENT: файл не найден
- Видеофайл отсутствует на диске
- Проверьте `kinescope-video-map.json` — колонка `fileExists`
- Перезапустите маппинг-скрипт после перемещения файлов

### База данных недоступна
- Проверьте `DATABASE_URL` в `.env`
- Проверьте что Supabase проект не заснул (free tier)
- Зайдите на supabase.com/dashboard и нажмите "Restore" при необходимости

---

## Полезные ссылки

| Ресурс | URL |
|--------|-----|
| Kinescope Dashboard | https://dashboard.kinescope.io |
| Kinescope API Docs | https://developers.kinescope.io |
| Supabase Dashboard | https://supabase.com/dashboard |
| Manifest файл | `E:\Academy Courses\manifest.json` |
